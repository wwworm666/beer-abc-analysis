# Система маппинга кегов к блюдам

## Как работает

Система связывает **названия блюд в меню** с **названиями кегов в складе**:
- `Brewlok IPA` (блюдо в меню) → `КЕГ Brewlok IPA 20 л` (товар на складе)
- `Блек Шип` (блюдо) → `КЕГ Блек Шип` (товар)

Это позволяет правильно группировать продажи разных порций (0.25L, 0.5L, 1.0L) одного пива в общий объём по кегу.

## Основные файлы

### 1. Главный файл маппинга
**`tochno prav spisok - active_dishes_to_kegs_CLEAN.csv.csv`**
- CSV файл в формате: `DISH_NAME,KEG_NAME`
- Содержит все актуальные привязки блюд к кегам
- **Редактируйте этот файл** когда появляется новое пиво

### 2. Рабочие файлы (генерируются автоматически)
- `keg_mapping.py` - Python файл для использования в коде
- `keg_mapping.json` - JSON формат (кег → список блюд)
- `dish_to_keg_mapping.json` - обратный маппинг (блюдо → кег)

## Когда появляется новое пиво

### Способ 1: Автоматическая проверка

```bash
python check_unmapped_dishes.py
```

Скрипт покажет:
- Какие блюда продаются, но не имеют маппинга
- Сколько порций продано по каждому блюду
- Создаст файл `NEW_DISHES_TO_ADD.csv` для заполнения

**Пример вывода:**
```
NOVYE BLYUDA BEZ MAPPINGA: 3

Novoe Pivo IPA
  Prodano porciy: 45
  Bary: Лиговский

Gletcher Sour
  Prodano porciy: 23
  Bary: Невский завод
```

### Способ 2: Ручное добавление

1. **Откройте** `tochno prav spisok - active_dishes_to_kegs_CLEAN.csv.csv`

2. **Добавьте новую строку:**
```csv
Новое Пиво IPA,КЕГ Новое Пиво IPA 20 л
```

3. **Импортируйте изменения:**
```bash
python import_final_mapping.py
```

4. **Перезапустите сервер:**
```bash
# Остановите (Ctrl+C)
python app.py
```

## Как найти правильное название кега

### Вариант 1: Справочник кегов
Смотрите файл `all_kegs_reference.csv` - там все 400 кегов из системы

### Вариант 2: Через интерфейс iiko Office
1. Откройте справочник товаров
2. Найдите нужный кег (начинается с "КЕГ ")
3. Скопируйте **точное** название

### Вариант 3: Правый клик на товаре
В iiko Office:
1. Правый клик на кеге
2. "Отчет о вхождении в блюдо"
3. Увидите какие блюда использует этот кег

## Проверка покрытия

```bash
python check_unmapped_dishes.py
```

**Хороший результат:**
```
Pokrytie mappingom: 100.0%
Zamapleno: 50
Ne zamapleno: 0
```

**Нужно действовать:**
```
Pokrytie mappingom: 85.0%
Zamapleno: 42
Ne zamapleno: 8
```

## Типичные проблемы

### 1. Блюдо называется по-другому чем кег

**Проблема:**
- Кег: `КЕГ Rebel Apple Дикий Крест`
- Блюдо: `Дикий Крест сухой`

**Решение:** Укажите в CSV точное название блюда
```csv
Дикий Крест сухой,КЕГ Rebel Apple Дикий Крест
```

### 2. Одно блюдо из нескольких кегов

**Пример:** "Карлова Корчма" может продаваться из разных кегов

**В CSV:**
```csv
Карлова Корчма,КЕГ Карлова Корчма Премиум 30 л
Карлова корчма,КЕГ Карлова Корчма Премиум 30 л
```

### 3. Блюдо с префиксом бара

**Пример:** "ВО Brewlok IPA" (Невский завод)

**В CSV:**
```csv
Brewlok IPA,КЕГ Brewlok IPA 20 л
ВО Brewlok IPA,КЕГ Brewlok IPA 20 л
```

## Регулярное обслуживание

### Еженедельно
```bash
python check_unmapped_dishes.py
```

### При добавлении нового пива
1. Добавить в CSV
2. Запустить `python import_final_mapping.py`
3. Перезапустить сервер

### При изменении ассортимента
1. Обновить CSV
2. Импортировать маппинг
3. Проверить покрытие

## Статистика

Текущее покрытие (по состоянию на импорт):
- **149 блюд** замаплены
- **131 кег** в системе
- **100%** покрытие продаж за последние 30 дней
