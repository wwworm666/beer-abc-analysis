# 🔤 Как система обрабатывает СИЛЬНЫЕ различия в названиях

## 📌 Проблема: Кег на кириллице, порция на латинице

**Именно для этого и существует файл `mapping/keg_mapping.py`!**

---

## 🎯 Решение: Явное мэппинг вместо автоматического совпадения

### Проблемные примеры

```
КЕГ (кириллица, инвентарь iiko):
├─ КЕГ Brewлок ИПА 20 л         (смешанная, русское написание)
├─ КЕГ Крефф Бланш де Нам 20 л  (кириллица с французским)
└─ КЕГ Кремек Брюно де Брюно     (полностью кириллица)

DISH (латиница, меню POS):
├─ Brewlok IPA (0,5)             (оригинальное, латиница)
├─ Cuvée Blanche Namur (0,25)    (французское, латиница)
└─ Krémes Bruno de Bruno (1,0)   (с диакритикой)
```

**Проблема:** `"КЕГ Brewлок ИПА"` ≠ `"Brewlok IPA"`
- Разные алфавиты (кириллица vs латиница)
- Разные написания (ИПА vs IPA)
- Разные ударения и диакритика

**❌ Автоматическое совпадение НЕ СРАБОТАЕТ:**
```python
if "Brewlok IPA" in ["КЕГ Brewлок ИПА 20 л"]:
    # False! Строки не совпадают
```

**✅ ПОЭТОМУ НУЖЕН ЯВНЫЙ MAPPING:**
```python
KEG_TO_DISH_MAPPING = {
    'КЕГ Brewлок ИПА 20 л': ['Brewlok IPA', 'ВО Brewlok IPA'],
    'КЕГ Крефф Бланш де Нам 20 л': ['Cuvée Blanche Namur'],
    'КЕГ Кремек Брюно': ['Krémes Bruno de Bruno'],
}
```

---

## 🗺️ Как работает мэппинг при сильных различиях

### Этап 1: Ручное заполнение CSV

```
Разработчик или администратор заполняет CSV вручную:

KEG_NAME (из инвентаря iiko)  | DISH_NAME (из меню POS)
──────────────────────────────────────────────────────────
КЕГ Brewлок ИПА 20 л          | Brewlok IPA
КЕГ Brewлок ИПА 20 л          | ВО Brewlok IPA (вариант)
КЕГ Крефф Бланш де Нам 20л    | Cuvée Blanche Namur
КЕГ Кремек Брюно де Брюно     | Krémes Bruno de Bruno
КЕГ Лефортова Фесамень Янтаря  | Le Fortune Fesamen Amber
```

**Ключевой момент:** Мэппинг создается **ВРУЧНУЮ**, потому что автоматическое совпадение невозможно!

### Этап 2: Импорт в Python

```python
# utils/import_final_mapping.py читает CSV и создаёт:

KEG_TO_DISH_MAPPING = {
    'КЕГ Brewлок ИПА 20 л': [
        'Brewlok IPA',
        'ВО Brewlok IPA'
    ],
    'КЕГ Крефф Бланш де Нам 20л': [
        'Cuvée Blanche Namur'
    ],
    'КЕГ Кремек Брюно де Брюно': [
        'Krémes Bruno de Bruno'
    ],
    ...
}
```

### Этап 3: Использование в приложении

```python
# При продаже "Brewlok IPA (0,5)":

# 1. Парсинг имени пива
beer_name = "Brewlok IPA"  # extract_beer_info()

# 2. Поиск в мэппинге
for keg_name, dishes in KEG_TO_DISH_MAPPING.items():
    if beer_name in dishes:  # Точное совпадение!
        print(f"Найден кег: {keg_name}")
        # Результат: КЕГ Brewлок ИПА 20 л
        break

# 3. Теперь мы знаем кег, даже если названия сильно отличаются!
```

---

## 📊 Реальные примеры из вашего мэппинга

### Пример 1: Английское название ↔ Русское написание

```
KEG_TO_DISH_MAPPING = {
    'КЕГ Brewlok IPA 20 л': [
        'Brewlok IPA',          ← Оригинальное английское
        'ВО Brewlok IPA'        ← Вариант с префиксом
    ],
    # ...
}
```

**Что происходит:**
- iiko инвентарь: `КЕГ Brewlok IPA 20 л` (латиница, как от поставщика)
- POS меню: `Brewlok IPA (0,5)` (то же самое имя)
- ✅ Совпадает благодаря мэппингу!

---

### Пример 2: Французское с диакритикой ↔ Кириллица

```
KEG_TO_DISH_MAPPING = {
    'КЕГ Корсендонк Бланш, 30л': [
        'Корсендонк бланш'      ← Кириллица в меню
    ],
    ...
}
```

**Что происходит:**
- iiko: `КЕГ Корсендонк Бланш, 30л` (кириллица)
- POS: `Корсендонк бланш (0,5)` (кириллица)
- ✅ Совпадает! (обе кириллица)

---

### Пример 3: Смешанные варианты

```
KEG_TO_DISH_MAPPING = {
    'КЕГ Коникс Черри Руби 20 л': [
        'ВО Коникс Черри Руби',     ← Кириллица с префиксом
        'Коникс Черри Руби'         ← Кириллица без префикса
    ],
    ...
}
```

**Что происходит:**
- iiko: `КЕГ Коникс Черри Руби 20 л` (кириллица)
- POS вариант 1: `ВО Коникс Черри Руби (0,5)` → парсится → `Коникс Черри Руби` → ✅ найдено
- POS вариант 2: `Коникс Черри Руби (0,5)` → парсится → `Коникс Черри Руби` → ✅ найдено

---

## 🔍 Как система обрабатывает НОВОЕ пиво с РАЗНЫМИ названиями

### Сценарий: Добавили новое пиво "Crafty Brewski Amber"

```
Этап 1: Пиво попадает в продажи
┌──────────────────────────────────────────┐
│ iiko инвентарь:                          │
│ Товар: КЕГ Crafty Brewski Янтарь 30л    │
│ (админ добавил товар с русским описанием)│
└──────────────────────────────────────────┘
                    |
┌──────────────────────────────────────────┐
│ POS меню:                                │
│ Позиция: Crafty Brewski Amber (0,5)     │
│ (программист добавил на английском)     │
└──────────────────────────────────────────┘

Этап 2: Проверка мэппинга
┌──────────────────────────────────────────┐
│ python utils/check_unmapped_dishes.py    │
│                                          │
│ Результат: "Crafty Brewski Amber" НЕ в  │
│ мэппинге! ← ОБНАРУЖЕНО!                  │
│                                          │
│ Экспорт: NEW_DISHES_TO_ADD.csv           │
│ Crafty Brewski Amber | ?                 │
└──────────────────────────────────────────┘

Этап 3: Разработчик вручную заполняет
┌──────────────────────────────────────────┐
│ Открывает NEW_DISHES_TO_ADD.csv          │
│ Смотрит в инвентарь iiko                 │
│ Находит: КЕГ Crafty Brewski Янтарь 30л │
│ Заполняет вручную:                       │
│                                          │
│ Crafty Brewski Amber |                   │
│ КЕГ Crafty Brewski Янтарь 30л           │
└──────────────────────────────────────────┘

Этап 4: Автоматическое сопоставление
┌──────────────────────────────────────────┐
│ python utils/auto_add_new_dishes.py      │
│                                          │
│ Пытается найти кег:                      │
│ ├─ Точное совпадение ❌                  │
│ │  "Crafty Brewski Amber" !=             │
│ │  "КЕГ Crafty Brewski Янтарь"          │
│ │                                        │
│ ├─ Substring matching (70% сходства)    │
│ │  "Crafty Brewski" в обоих! ✓          │
│ │  Уверенность: 70%                     │
│ │  Статус: AUTO (автоматическое)        │
│ │                                        │
│ └─ Обновляет CSV исходный файл          │
│    КЕГ Crafty Brewski Янтарь 30л        │
│    Crafty Brewski Amber                 │
└──────────────────────────────────────────┘

Этап 5: Переимпорт
┌──────────────────────────────────────────┐
│ python utils/import_final_mapping.py     │
│                                          │
│ Создаёт в mapping/keg_mapping.py:       │
│ 'КЕГ Crafty Brewski Янтарь 30л': [      │
│     'Crafty Brewski Amber'               │
│ ],                                       │
└──────────────────────────────────────────┘

Этап 6: Использование
┌──────────────────────────────────────────┐
│ При следующей продаже:                  │
│ "Crafty Brewski Amber (0,5)"             │
│          ↓                               │
│ Парсится → "Crafty Brewski Amber"       │
│          ↓                               │
│ Ищется в мэппинге                       │
│          ↓                               │
│ ✓ НАЙДЕНО в                              │
│ 'КЕГ Crafty Brewski Янтарь 30л'         │
│          ↓                               │
│ Правильно агрегируется в аналитику!     │
└──────────────────────────────────────────┘
```

---

## 🎨 Типы различий в названиях

### 1. Алфавит (кириллица ↔ латиница)

```
КЕГ Brewлок ИПА          ≠ Brewlok IPA
└─ Кириллица в кеге       └─ Латиница в меню

Решение: Явный мэппинг!
'КЕГ Brewлок ИПА': ['Brewlok IPA']
```

### 2. Язык (русский ↔ оригинальный)

```
КЕГ Крефф Бланш        ≠ Cuvée Blanche Namur
└─ Русский, сокращено    └─ Французский, полный

Решение: Явный мэппинг!
'КЕГ Крефф Бланш...': ['Cuvée Blanche Namur']
```

### 3. Ударение и диакритика

```
КЕГ Корсендонк Бланш  ≠ Corsendock Blanch
└─ С ударением         └─ Без диакритики

Решение: Явный мэппинг!
'КЕГ Корсендонк...': ['Corsendock Blanch']
```

### 4. Сокращения

```
КЕГ Святая Земля         ≠ Saint Land
КЕГ Св. Земля (краткая)  ≠ SL (аббревиатура)

Решение: Явный мэппинг!
'КЕГ Святая Земля': ['Saint Land', 'SL']
```

### 5. Префиксы и варианты

```
КЕГ Brewlok IPA 20л
    ↓
Может быть несколько блюд:
├─ Brewlok IPA (0,5)
├─ ВО Brewlok IPA (0,5)
├─ НЗ Brewlok IPA (0,5)
└─ Brewlok IPA (1,0)

Решение: Один кег → много блюд!
'КЕГ Brewlok IPA 20л': [
    'Brewlok IPA',
    'ВО Brewlok IPA',
    'НЗ Brewlok IPA'
]
```

---

## 📋 CSV исходный файл: КАК ТА М РЕШАЕТСЯ

```csv
KEG_NAME                                | DISH_NAME                    | STATUS
────────────────────────────────────────────────────────────────────────────────
КЕГ Brewlok IPA 20 л                   | Brewlok IPA                  | VERIFIED
КЕГ Brewlok IPA 20 л                   | ВО Brewlok IPA               | VERIFIED
КЕГ Korschenderke Blanch 30л            | Корсендонк бланш             | MANUAL
КЕГ Korschenderke Blanch 30л            | Corsendock Blanch            | MANUAL
КЕГ ЛеФорт Трипель, 20л               | LeForte Tripel               | AUTO
КЕГ Цеце Клиффордерий Лагер 30л       | Zéczy Clifforderie Lager     | MANUAL
```

**Ключ:** Разработчик **ВРУЧ НУЮ** указывает соответствие между кегом и блюдом, потому что:

1. ✅ Может найти оба варианта в двух разных системах
2. ✅ Знает контекст (от какого поставщика, как называется в меню)
3. ✅ Может проверить одно товара в инвентаре
4. ❌ Не может полагаться на автоматический парсинг (слишком разные названия)

---

## 🔧 Процесс для новых пив со СЛОЖНЫМИ названиями

```
1. ОБНАРУЖЕНИЕ
   check_unmapped_dishes.py
   ↓
   Находит: "Unknown Craft Beer Xyz"

2. РУЧНОЕ СОПОСТАВЛЕНИЕ
   Разработчик смотрит в инвентарь iiko
   Находит соответствующий кег
   Вручную заполняет CSV:

   КЕГ Unknown Craft Beer XYZ 30л | Unknown Craft Beer Xyz

3. АВТОМАТИЧЕСКИЙ РАЗБОР (опциональный)
   auto_add_new_dishes.py
   Fuzzy matching с 70% сходством
   Если не нашёл → STATUS = MANUAL_REQUIRED

4. ПЕРЕИМПОРТ
   import_final_mapping.py
   ↓
   Обновляет mapping/keg_mapping.py

5. ИСПОЛЬЗОВАНИЕ
   Теперь все продажи "Unknown Craft Beer Xyz"
   правильно сопоставляются с кегом!
```

---

## 💡 ПРАКТИЧЕСКИЙ ПРИМЕР ИЗ ВАШЕГО ПРОЕКТА

### Из mapping/keg_mapping.py (реальные примеры):

```python
KEG_TO_DISH_MAPPING = {
    # Простое совпадение (латиница)
    'КЕГ Brewlok IPA 20 л': [
        'Brewlok IPA',
        'ВО Brewlok IPA'
    ],

    # Смешанное (кириллица + латиница)
    'КЕГ Basilisks Irish Stout': [
        'ВО O`Hara`s Irish Stout'  # ← Другое имя!
    ],

    # Русское название
    'КЕГ Караваев Вишнёвый Лагер 30 л': [
        'Караваев Вишня'  # ← Сокращение
    ],

    # Сложное французское
    'КЕГ Корсендонк Бланш, 30л': [
        'Корсендонк бланш'  # ← Русская транскрипция
    ],

    # Один кег = много блюд (префиксы + размеры)
    'КЕГ DaDa сидр #1 сухой 30л': [
        'DaDa сидр #1 сухой',      # Base
        'ВО DaDa сидр #1 сухой'    # Вариант 1
        # Возможны ещё: НЗ, ТЦ варианты
    ],
}
```

**Вывод:** Ваш мэппинг уже содержит примеры **всех типов различий**!

---

## ✅ КОГДА ИСПОЛЬЗОВАТЬ ЧТО

| Ситуация | Решение |
|----------|---------|
| **Названия похожи** | Автоматическое совпадение в коде |
| **Названия сильно отличаются** | ✅ **Явный мэппинг в CSV/Python** |
| **Новое пиво в продажах** | check_unmapped_dishes.py → NEW_DISHES_TO_ADD.csv |
| **Нужно добавить вручную** | Отредактировать CSV, переимпортировать |
| **Много вариантов одного пива** | Один кег → список блюд в мэппинге |
| **Автоматическое сопоставление** | auto_add_new_dishes.py с fuzzy matching |

---

## 🎯 ИТОГ

**Именно поэтому существует `mapping/keg_mapping.py`!**

```python
KEG_TO_DISH_MAPPING = {
    "кег из инвентаря": ["блюдо1", "блюдо2", ...]
}
```

Это **явное мэппинг**, которое решает:

1. ✅ Проблему разных алфавитов (кириллица ↔ латиница)
2. ✅ Проблему разных языков (русский ↔ оригинальный)
3. ✅ Проблему диакритики и ударений
4. ✅ Проблему сокращений и вариантов
5. ✅ Проблему множественных наименований (1 кег → N блюд)

**Это не ошибка, это ОСОБЕННОСТЬ, потому что именно для этого нужен мэппинг!**

Автоматическое совпадение строк БЫ сработает только если названия идентичны. Но в реальной жизни у вас кириллица в инвентаре и латиница в меню → поэтому нужен явный мэппинг.

**Вывод:** Ваша система работает правильно! 🎉

