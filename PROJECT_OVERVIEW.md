# Обзор Проекта: Beer ABC/XYZ Analysis System

> Справочный документ для быстрого понимания проекта в новых сессиях

---

## 1. КРАТКОЕ ОПИСАНИЕ ПРОЕКТА

**Название:** Beer ABC/XYZ Analysis
**Язык:** Python 3.11+
**Тип:** Веб-приложение (Flask)
**Назначение:** Автоматизированный анализ продаж пива для управления ассортиментом в сети баров
**Расположение:** `C:\12\beer-abc-analysis`

**Основные возможности:**
- ABC-анализ по 3 метрикам (выручка, наценка, маржа)
- XYZ-анализ стабильности спроса (по процентилям)
- Анализ фасованного пива (бутылки) и разливного (драфт)
- Интерактивная веб-панель с визуализацией
- Интеграция с iiko API (OLAP отчеты)
- Объединенный режим "Общая" для всех баров

**Поддерживаемые бары:**
1. Большой пр. В.О
2. Лиговский
3. Кременчугская
4. Варшавская

---

## 2. СТРУКТУРА ПРОЕКТА

```
beer-abc-analysis/
├── app.py                      # Flask сервер (главная точка входа) - 700+ строк
├── config.py                   # Конфигурация iiko API
├── requirements.txt            # Python зависимости
│
├── Модули анализа:
│   ├── abc_analysis.py         # ABC анализ (3-буквенная классификация)
│   ├── xyz_analysis.py         # XYZ анализ (стабильность спроса)
│   ├── category_analysis.py    # Анализ по категориям
│   ├── data_processor.py       # Обработка и агрегация данных
│   └── draft_analysis.py       # NEW: Анализ разливного пива
│
├── Интеграция API:
│   ├── iiko_api.py            # Аутентификация в iiko
│   └── olap_reports.py        # Получение OLAP отчетов (фасовка + драфт)
│
├── Веб-интерфейс:
│   └── templates/
│       ├── index.html         # Панель для фасованного пива
│       └── draft.html         # NEW: Панель для разливного пива
│
├── Документация:
│   ├── README.md              # Основная документация
│   ├── PROBLEM_SOLUTION.md    # Решения проблем
│   ├── CATEGORY_ANALYSIS.md   # Руководство по категориям
│   └── PROJECT_OVERVIEW.md    # Этот файл
│
├── Тестовые файлы:
│   ├── diagnose.py
│   ├── test_no_filter.py
│   ├── test_category_fix.py
│   └── remove_emoji.py
│
├── Данные (генерируются):
│   ├── beer_report.json       # Кэш OLAP отчета
│   ├── all_groups.json        # Кэш групп продуктов
│   ├── aggregated_beer_data.csv
│   ├── abc_analysis_*.csv
│   └── xyz_analysis_test.csv
│
└── Документация/              # PDF документация от iiko
```

---

## 3. КЛЮЧЕВЫЕ ФАЙЛЫ И ИХ РОЛИ

### **app.py** (700+ строк) - Flask веб-сервер
**Маршруты:**
- `GET /` - Главная страница (фасованное пиво - index.html)
- `GET /draft` - NEW: Страница разливного пива (draft.html)
- `POST /api/analyze` - Анализ фасованного пива на уровне бутылок
- `POST /api/categories` - Анализ на уровне категорий
- `POST /api/draft-analyze` - NEW: Анализ разливного пива с ABC/XYZ
- `GET /api/weekly-chart/<bar>/<beer>` - Недельные тренды продаж
- `GET /api/connection-status` - Проверка соединения с API

**Ключевые функции:**
- Двухрежимный анализ (бутылки vs категории)
- **Режим "Общая"** - агрегация данных по всем 4 барам
- ABC анализ с агрегацией по `BeerName` для "Общая"
- XYZ анализ по процентилям (топ 33% / средние 33% / нижние 33%)
- Обработка ошибок и логирование

### **draft_analysis.py** (300+ строк) - NEW: Модуль разливного пива
**Методы:**
- `extract_beer_info()` - Парсинг названий типа "ФестХаус Хеллес (0,5)" → название + объем
- `get_weekly_draft_sales()` - Недельная агрегация продаж разливного
- `get_beer_summary()` - Сводка по каждому сорту пива (литры, порции, финансы)
- `calculate_xyz_for_summary()` - **XYZ по процентилям** (как ABC)
- `format_summary_for_display()` - Форматирование для JSON API

**Особенности:**
- Разбор порций (0.5L, 0.4L, 0.3L) из названий блюд
- Агрегация в литры вместо количества порций
- Поддержка финансовых данных (выручка, наценка, маржа)
- Расчёт средней порции и недель активности

### **abc_analysis.py** (168 строк) - ABC классификация
**Методы:**
- `calculate_abc_category()` - Категоризация по принципу Парето (80-15-5%)
- `perform_abc_analysis_by_bar()` - Анализ одного бара
- `perform_full_analysis()` - Анализ нескольких баров

**Метрики (3-буквенный код):**
1. **1-я буква (A/B/C)** - Выручка: Топ 80% / Средние 15% / Нижние 5%
2. **2-я буква (A/B/C)** - Наценка %: По процентилям (топ 33% / средние 33% / нижние 33%)
3. **3-я буква (A/B/C)** - Маржа: По процентилям (топ 33% / средние 33% / нижние 33%)

**Результат:** 3-буквенные комбинации (AAA, ABC, CCC и т.д.)

### **xyz_analysis.py** (172 строки) - Стабильность спроса
**Методы:**
- `calculate_coefficient_of_variation()` - Расчет коэффициента вариации
- `categorize_xyz()` - Присвоение категории X/Y/Z
- `perform_xyz_analysis_by_bar()` - Анализ по неделям
- `get_weekly_sales_chart_data()` - Данные для графиков

**Категории (старая формула для фасовки):**
- **X** - CV < 10% (Стабильный спрос)
- **Y** - CV 10-25% (Умеренная вариация)
- **Z** - CV > 25% (Нестабильный спрос)

**NEW: Для разливного пива (процентильная система в draft_analysis.py):**
- **X** - Топ 33% (наименьший CV - самые стабильные)
- **Y** - Средние 33%
- **Z** - Нижние 33% (наибольший CV - самые нестабильные)

### **olap_reports.py** (157 строк) - Получение отчетов
**Методы:**
- `connect()` - Установка сессии с API
- `get_beer_sales_report()` - Получение данных продаж **фасованного** пива
- `get_draft_sales_report()` - NEW: Получение данных **разливного** пива
- `_build_olap_request()` - Построение JSON запроса OLAP v2

**Применяемые фильтры:**
- Диапазон дат
- **Группа продуктов:**
  - `"Напитки Фасовка"` - для бутылочного пива
  - `"Напитки Розлив"` - для разливного пива
- Статус удаления (только активные)
- Опционально: конкретный бар

### **index.html** (1657 строк) - Веб-панель фасованного пива
**Функции:**
- Двухрежимный UI (переключатель: бутылки/категории)
- Выбор периода: выпадающий список (Неделя, Месяц, Квартал, Год)
- **Свой период** - календарь с выбором дат
- Переключатель "Общая" / конкретный бар
- Индикатор подключения к API в реальном времени
- Переключатель светлой/темной темы
- Модальные окна для детальных просмотров
- Интерактивные графики (Chart.js)
- Минималистичный заголовок: "ABC/XYZ" + "В культуре"
- Навигация: [Фасовка] | [Разливное]

### **draft.html** (920+ строк) - NEW: Веб-панель разливного пива
**Функции:**
- Выбор бара (включая "Общая")
- Выбор периода (как в index.html)
- Статистика: Общий объём (L), Порций продано, Позиций
- Таблица топ-20 с колонками: ABC, XYZ
- **Кликабельные строки** - модальное окно с деталями
- Модальное окно:
  - Финансовые данные (выручка, наценка %, маржа)
  - **ABC Анализ** с расшифровкой каждой буквы
  - **XYZ Анализ** с коэффициентом вариации
- Цветные бейджи:
  - ABC: A (зелёный), B (оранжевый), C (красный)
  - XYZ: X (зелёный), Y (оранжевый), Z (серый)
- Тёмная/светлая тема
- Навигация: [Фасовка] | [Разливное]

---

## 4. ТЕХНОЛОГИИ

| Слой | Технология | Версия | Назначение |
|------|-----------|--------|------------|
| **Веб-фреймворк** | Flask | 3.0.0 | HTTP сервер, маршрутизация |
| **Обработка данных** | pandas | 2.2.3 | DataFrame, агрегации |
| **Математика** | numpy | 1.26.2 | Массивы, расчеты |
| **HTTP клиент** | requests | 2.31.0 | Связь с iiko API |
| **Конфигурация** | python-dotenv | 1.0.0 | Переменные окружения |
| **Prod сервер** | gunicorn | 21.2.0 | WSGI сервер |
| **Графики** | Chart.js | 4.4.0 | Визуализация |
| **Язык** | Python | 3.11+ | Backend |

---

## 5. ЗАПУСК ПРОЕКТА

### Разработка:
```bash
python app.py
# Запускает Flask dev-сервер на http://localhost:5000
```

### Production:
```bash
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### Страницы:
- **Фасованное пиво:** http://localhost:5000/
- **Разливное пиво:** http://localhost:5000/draft

### Отдельные модули:
```bash
python abc_analysis.py    # ABC анализ
python xyz_analysis.py    # XYZ анализ
python category_analysis.py  # Анализ категорий
python draft_analysis.py  # Анализ разливного
python olap_reports.py    # Тест OLAP подключения
```

---

## 6. ПОТОК ДАННЫХ

### Фасованное пиво (index.html):
```
1. Пользователь выбирает бар(ы) и период в UI
   ↓
2. app.py получает POST запрос на /api/analyze или /api/categories
   ↓
3. olap_reports.py подключается к iiko API (фильтр: "Напитки Фасовка")
   ↓
4. Получение OLAP отчета с данными продаж
   ↓
5. data_processor.py очищает и агрегирует данные
   ↓
6. abc_analysis.py рассчитывает 3-буквенные классификации
   ↓
7. xyz_analysis.py рассчитывает коэффициент вариации
   ↓
8. Результаты объединяются в app.py
   ↓
9. JSON ответ отправляется на фронтенд
   ↓
10. index.html рендерит интерактивные визуализации
```

### Разливное пиво (draft.html):
```
1. Пользователь выбирает бар и период в UI
   ↓
2. app.py получает POST запрос на /api/draft-analyze
   ↓
3. olap_reports.get_draft_sales_report() (фильтр: "Напитки Розлив")
   ↓
4. draft_analysis.py парсит названия блюд (пиво + порция)
   ↓
5. Агрегация по BeerName (суммируем литры, порции)
   ↓
6. Для "Общая": агрегация данных из всех 4 баров
   ↓
7. ABC анализ (3 буквы) на агрегированных данных
   ↓
8. XYZ анализ по процентилям (топ 33% / средние / нижние)
   ↓
9. JSON ответ с ABC_Combined, XYZ_Category, финансами
   ↓
10. draft.html рендерит таблицу + модальные окна
```

---

## 7. СИСТЕМА КЛАССИФИКАЦИИ

### ABC (3-буквенный код)
Каждое пиво получает 3-символьный код:
- **1-я буква (A/B/C):** Рейтинг по выручке (Парето 80-15-5%)
- **2-я буква (A/B/C):** Рейтинг по наценке % (процентили 33/33/33)
- **3-я буква (A/B/C):** Рейтинг по марже (процентили 33/33/33)

**Примеры:**
- `AAA` = Высокая выручка + высокая наценка + высокая маржа (премиум товар)
- `ABC` = Высокая выручка + средняя наценка + низкая маржа
- `CCC` = Низкие показатели по всем метрикам

**Применение:**
- Фасованное пиво (index.html): полный ABC
- Разливное пиво (draft.html): полный ABC (только для конкретного бара или "Общая")

### XYZ (Стабильность спроса)

**Коэффициент вариации:**
```
CV = (Стандартное отклонение / Среднее) × 100
```

**Для фасованного пива (фиксированные пороги):**
- **X** = CV < 10% (Стабильный)
- **Y** = CV 10-25% (Умеренный)
- **Z** = CV > 25% (Нестабильный)

**NEW: Для разливного пива (процентильная система):**
- **X** = Топ 33% по стабильности (наименьший CV)
- **Y** = Средние 33%
- **Z** = Нижние 33% (наибольший CV)

**Преимущества процентильной системы:**
- Гарантированное распределение ≈33% / 33% / 33%
- Нет "сплошных Z" при высокой вариативности
- Единообразие с ABC (наценка и маржа)

---

## 8. КОНФИГУРАЦИЯ

### config.py - Учетные данные API
```python
IIKO_SERVER = "first-federation.iiko.it"
IIKO_PORT = "443"
IIKO_LOGIN = "claude544"
IIKO_PASSWORD = "ApiPass2024!"
IIKO_BASE_URL = f"https://{IIKO_SERVER}:{IIKO_PORT}/resto/api"
```
**Важно:** В production переместить в переменные окружения

### requirements.txt
```
Flask==3.0.0
requests==2.31.0
pandas==2.2.3
numpy==1.26.2
python-dotenv==1.0.0
gunicorn==21.2.0
```

---

## 9. ИЗВЕСТНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### Исправлено:
1. **Пустые категории пива:** Отсутствующие категории → "Без категории (Ф)"
2. **Emoji в консоли Windows:** Все emoji заменены на текстовые метки `[OK]`, `[ERROR]`
3. **JSON сериализация:** pandas int64/float64 явно конвертируются в Python типы
4. **Отсутствие XYZ данных:** По умолчанию 'Z' когда коэффициент не может быть рассчитан
5. **"Все бары" → "Общая":** Унифицировано во всём приложении
6. **Кнопка "Запустить анализ" пропадала:** Вынесена из скрытого блока custom-period
7. **Сплошные Z в XYZ:** Изменена формула на процентильную для разливного
8. **На "Общая" показывал только один бар:** Добавлена агрегация по BeerName для draft

---

## 10. АРХИТЕКТУРНЫЕ РЕШЕНИЯ

1. **Stateless API:** Каждый запрос независимо получает свежие OLAP данные
2. **Кеширование:** JSON кеш файлы для быстрого тестирования
3. **Pandas-first:** Векторизованные операции для производительности
4. **Client-side рендеринг:** Графики и модалки в браузере
5. **Две независимые страницы:** index.html (фасовка) и draft.html (драфт)
6. **API-центричный backend:** Flask только для endpoints
7. **Regex парсинг:** Извлечение объёма порций из названий блюд разливного
8. **Агрегация "Общая":** Группировка по BeerName после объединения баров

---

## 11. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### Анализ фасованного пива (один бар за 30 дней)
**Запрос:**
```json
POST /api/analyze
{
  "bar": "Лиговский",
  "days": 30
}
```

**Ответ:**
```json
{
  "Лиговский": {
    "total_beers": 85,
    "total_revenue": 1500000.00,
    "total_qty": 3200,
    "abc_stats": {"AAA": 12, "AAB": 10, ...},
    "xyz_stats": {"X": 30, "Y": 35, "Z": 20},
    "records": [...],
    "top_beers": [...],
    "worst_beers": [...]
  }
}
```

### Анализ разливного пива (все бары - "Общая")
**Запрос:**
```json
POST /api/draft-analyze
{
  "bar": "",
  "days": 30
}
```

**Ответ:**
```json
{
  "Общая": {
    "total_liters": 2845.3,
    "total_portions": 6234,
    "total_beers": 42,
    "total_revenue": 1250000.00,
    "beers": [
      {
        "BeerName": "ФестХаус Хеллес",
        "TotalLiters": 385.5,
        "TotalPortions": 853,
        "AvgPortionSize": 0.45,
        "TotalRevenue": 128400.00,
        "AvgMarkupPercent": 0.65,
        "TotalMargin": 52100.00,
        "ABC_Combined": "AAA",
        "ABC_Revenue": "A",
        "ABC_Markup": "A",
        "ABC_Margin": "A",
        "XYZ_Category": "X",
        "CoefficientOfVariation": 8.2,
        "ABCXYZ_Combined": "AAA-X"
      },
      ...
    ]
  }
}
```

---

## 12. ПЛАНЫ РАЗВИТИЯ

- [ ] UI фильтрация по категориям
- [ ] Экспорт в Excel
- [ ] Сравнение категорий между барами
- [ ] Анализ трендов по времени
- [ ] Автоматические рекомендации по ассортименту
- [ ] Прогнозирование спроса (ML)
- [ ] Сравнительный анализ за несколько периодов
- [ ] Унификация XYZ формулы (процентили для обоих типов пива)
- [ ] График продаж разливного по неделям (как у фасованного)

---

## 13. БЫСТРАЯ СПРАВКА

### Основные команды
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск приложения
python app.py

# Тест подключения к API
python olap_reports.py

# Запуск отдельного анализа
python abc_analysis.py
python xyz_analysis.py
python draft_analysis.py
```

### Основные пути
- **Фасованное пиво:** `http://localhost:5000`
- **Разливное пиво:** `http://localhost:5000/draft`
- **API фасовки:** `POST /api/analyze`
- **API категорий:** `POST /api/categories`
- **API драфта:** `POST /api/draft-analyze`
- **Графики:** `GET /api/weekly-chart/<bar>/<beer>`

### Основные файлы данных
- `beer_report.json` - Кеш OLAP данных (фасовка)
- `aggregated_beer_data.csv` - Агрегированные данные
- `abc_analysis_*.csv` - Результаты ABC по барам

---

## 14. КРАТКАЯ ТАБЛИЦА

| Аспект | Детали |
|--------|---------|
| **Язык** | Python 3.11+ |
| **Фреймворк** | Flask 3.0.0 |
| **Основные библиотеки** | pandas, numpy, requests |
| **База данных** | Нет (только OLAP API) |
| **Точка входа** | app.py |
| **Конфиг** | config.py |
| **Веб UI** | Две SPA: index.html (фасовка), draft.html (драфт) |
| **Типы пива** | Фасованное ("Напитки Фасовка"), Разливное ("Напитки Розлив") |
| **Типы анализа** | ABC (3 метрики), XYZ (стабильность), Комбинированный |
| **Источник данных** | iiko OLAP API v2 |
| **Локации** | 4 бара в Санкт-Петербурге + режим "Общая" |
| **Форматы вывода** | JSON, CSV, HTML визуализация |
| **Кеширование** | Файловый JSON кеш |
| **Адаптивный дизайн** | Mobile-first с breakpoint 768px |
| **Навигация** | Переключение между Фасовка/Разливное |

---

## 15. СОВЕТЫ ДЛЯ РАБОТЫ С ПРОЕКТОМ

### При добавлении новой функциональности:
1. Изучите `data_processor.py` для понимания структуры данных
2. Проверьте `olap_reports.py` для доступных полей OLAP
3. Для драфта используйте `draft_analysis.py`
4. Обновите `app.py` для новых endpoints
5. Добавьте UI элементы в `index.html` или `draft.html`
6. Протестируйте с реальными данными

### При отладке:
1. Проверьте `beer_report.json` для структуры данных
2. Используйте `diagnose.py` для диагностики
3. Проверьте логи Flask в консоли
4. Используйте браузерные DevTools для фронтенда
5. Для драфта: проверьте парсинг названий с regex

### При добавлении нового бара:
1. Обновите список в `app.py` (`BARS`)
2. Точное имя должно совпадать с iiko API
3. Протестируйте с `test_no_filter.py`

### Ключевые изменения в этой сессии:
1. **Создана страница разливного пива** (`/draft`)
2. **"Все бары" → "Общая"** по всему приложению
3. **Минималистичный заголовок:** "ABC/XYZ" + "В культуре"
4. **Улучшенный период:** Dropdown + календарь для "Свой период"
5. **Парсинг порций разливного:** Regex для "Название (0,5)" → литры
6. **ABC/XYZ для драфта:** Полный анализ с модальными окнами
7. **Процентильная XYZ:** Топ/средние/нижние 33% вместо фиксированных порогов
8. **Агрегация "Общая":** Объединение одинаковых сортов из всех баров
9. **Сортировка по объёму:** Все позиции разливного сортируются по литрам (от большего к меньшему)

---

**Последнее обновление:** 2025-10-19
**Версия документа:** 2.1
**Создано для:** Быстрое погружение в проект в новых сессиях
