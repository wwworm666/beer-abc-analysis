# Система управления кранами v2.0

## Обзор

Полностью переработанная система управления пивными кранами с отдельными страницами для каждого бара и интеграцией с номенклатурой iiko.

**Статус проекта**: ✅ **ГОТОВО К ИСПОЛЬЗОВАНИЮ**

## Что изменилось

### v2.0 (Текущая версия)

#### Новые возможности
- ✅ **Отдельные страницы для каждого бара** - каждый бар имеет свою страницу управления
- ✅ **Выпадающий список кег** - список разливного пива загружается автоматически из номенклатуры iiko
- ✅ **Единый дизайн** - тот же стиль, что и на страницах "Фасовка" и "Проливы"
- ✅ **Светлая/темная тема** - переключатель темы с сохранением выбора
- ✅ **Главная страница** - обзор всех баров с текущей статистикой
- ✅ **Автообновление** - данные обновляются каждые 30 секунд

#### Технические улучшения
- Новый endpoint `/api/beers/draft` - получение списка разливного пива из номенклатуры
- Новый endpoint `/api/taps/{bar_id}/stats` - краткая статистика для карточки бара
- Улучшенная структура маршрутов `/taps` (главная) и `/taps/{bar_id}` (страница бара)
- Полная адаптивность для мобильных устройств

### v1.0 (Устаревшая)

- Одна общая страница для всех баров
- Ручной ввод названия пива
- Другой дизайн

## Быстрый старт

### 1. Запуск приложения

```bash
python app.py
```

### 2. Откройте в браузере

**Главная страница (выбор бара):**
```
http://localhost:5000/taps
```

**Страницы баров:**
- Большой пр. В.О: `http://localhost:5000/taps/bar1`
- Лиговский: `http://localhost:5000/taps/bar2`
- Кременчугская: `http://localhost:5000/taps/bar3`
- Варшавская: `http://localhost:5000/taps/bar4`

## Структура баров

| Бар ID | Название | Количество кранов |
|--------|----------|-------------------|
| bar1 | Большой пр. В.О | 12 |
| bar2 | Лиговский | 12 |
| bar3 | Кременчугская | 12 |
| bar4 | Варшавская | 24 |
| **Всего** | | **60** |

## Интерфейс

### Главная страница (`/taps`)

Показывает карточки всех баров с:
- Названием бара
- Количеством кранов
- Количеством активных кранов
- Количеством пустых кранов
- Процентом загрузки

Клик по карточке бара переводит на страницу управления этим баром.

### Страница бара (`/taps/{bar_id}`)

Показывает:
- **Навигацию** - быстрый переход к Фасовка, Проливы, Официанты
- **Статистику** - всего кранов, активных, пустых, % в работе
- **Сетку кранов** - визуальное отображение всех кранов

#### Цветовая индикация

- **Серый** (пустой) - кран не используется
- **Зелёный** (активный) - кран работает
- **Оранжевый** (замена) - идёт замена кеги

#### Управление краном

При клике на кран открывается модальное окно с действиями:

**Если кран пустой:**
- "Подключить кегу" - выбрать пиво из списка и добавить ID кеги

**Если кран активный:**
- "Заменить сорт" - выбрать новое пиво и добавить ID новой кеги
- "Остановить кран" - отключить кран (кега закончилась)

## Выбор пива

При подключении или замене кеги открывается выпадающий список со всем разливным пивом из номенклатуры iiko.

Список автоматически загружается из `data/all_products.json` и фильтрует только разливное пиво (содержит КЕГ, KEG, 30L, 50L в названии).

## API

### Новые endpoints

#### GET `/api/beers/draft`
Получить список разливного пива из номенклатуры

**Ответ:**
```json
{
  "beers": [
    {
      "id": "uuid",
      "name": "КЕГ Guinness Draught 30л",
      "num": "12345"
    },
    ...
  ]
}
```

#### GET `/api/taps/{bar_id}/stats`
Получить краткую статистику бара

**Ответ:**
```json
{
  "active": 5,
  "empty": 7,
  "total": 12
}
```

### Существующие endpoints

#### GET `/api/taps/{bar_id}`
Получить состояние всех кранов бара

#### POST `/api/taps/{bar_id}/start`
Подключить кегу
```json
{
  "tap_number": 1,
  "beer_name": "КЕГ Guinness Draught",
  "keg_id": "KEG-001"
}
```

#### POST `/api/taps/{bar_id}/stop`
Остановить кран
```json
{
  "tap_number": 1
}
```

#### POST `/api/taps/{bar_id}/replace`
Заменить кегу
```json
{
  "tap_number": 1,
  "beer_name": "КЕГ Heineken",
  "keg_id": "KEG-002"
}
```

## Файлы

### Новые файлы

- `templates/taps_main.html` - главная страница (выбор бара)
- `templates/taps_bar.html` - страница управления кранами бара
- `TAPS_V2_README.md` - эта документация

### Устаревшие файлы (можно удалить)

- `templates/taps.html` - старая версия (v1.0)
- `TAPS_*.md` - старая документация

## Дизайн

Новая система использует тот же дизайн, что и страницы "Фасовка" и "Проливы":

### Цветовая схема

**Светлая тема:**
- Фон: `#fafafa`
- Карточки: `#ffffff`
- Акцент: `#0066cc`

**Темная тема:**
- Фон: `#0f0f0f`
- Карточки: `#1a1a1a`
- Акцент: `#3b82f6`

### Типографика

- Шрифт: `-apple-system, BlinkMacSystemFont, 'Segoe UI'`
- Заголовок h1: `4rem, font-weight: 700`
- Стиль: минималистичный, чистый

## Примеры использования

### Сценарий 1: Подключение кеги

1. Открыть `http://localhost:5000/taps`
2. Кликнуть на карточку бара "Большой пр. В.О"
3. Кликнуть на серый (пустой) кран #1
4. Нажать "Подключить кегу"
5. Выбрать "КЕГ Guinness Draught 30л" из списка
6. Ввести ID кеги (например, KEG-001) или оставить автоматический
7. Нажать "Подключить"
8. Кран становится зелёным (активным)

### Сценарий 2: Замена сорта

1. Кликнуть на зелёный (активный) кран
2. Нажать "Заменить сорт"
3. Выбрать новое пиво из списка
4. Ввести ID новой кеги
5. Нажать "Заменить"
6. История сохраняет оба пива (старое и новое)

### Сценарий 3: Остановка крана

1. Кликнуть на активный кран
2. Нажать "Остановить кран"
3. Подтвердить действие
4. Кран становится серым (пустым)

## Автообновление

- **Главная страница** - статистика баров обновляется каждые 30 секунд
- **Страница бара** - состояние кранов обновляется каждые 30 секунд
- Не требуется перезагрузка страницы (F5)

## Мобильная адаптивность

✅ Полностью адаптивный дизайн:
- Мобильные телефоны (320px+)
- Планшеты (768px+)
- Десктопы (1024px+)

Сетка кранов автоматически подстраивается под размер экрана.

## Тестирование

### Проверка API

```bash
# Получить список пива
curl http://localhost:5000/api/beers/draft

# Получить статистику бара
curl http://localhost:5000/api/taps/bar1/stats

# Получить состояние кранов
curl http://localhost:5000/api/taps/bar1

# Подключить кегу
curl -X POST http://localhost:5000/api/taps/bar1/start \
  -H "Content-Type: application/json" \
  -d '{"tap_number": 1, "beer_name": "Guinness", "keg_id": "KEG-001"}'

# Остановить кран
curl -X POST http://localhost:5000/api/taps/bar1/stop \
  -H "Content-Type: application/json" \
  -d '{"tap_number": 1}'
```

## Решение проблем

### Нет списка пива в выпадающем меню

**Причина:** Файл `data/all_products.json` не найден или пустой

**Решение:** Убедитесь, что файл существует и содержит номенклатуру из iiko

### Статистика баров не обновляется

**Причина:** Проблема с сохранением данных в `data/taps_data.json`

**Решение:** Проверьте права доступа к папке `data/`

### Модальное окно не открывается

**Причина:** JavaScript ошибка в консоли браузера

**Решение:**
1. Откройте DevTools (F12)
2. Перейдите в Console
3. Проверьте ошибки JavaScript

## Технические детали

### Хранение данных

Все данные сохраняются в `data/taps_data.json`:

```json
{
  "bar1": {
    "name": "Бар 1",
    "total_taps": 12,
    "taps": [
      {
        "tap_number": 1,
        "status": "active",
        "current_beer": "Guinness Draught",
        "current_keg_id": "KEG-001",
        "started_at": "2024-10-24T10:00:00",
        "history": [...]
      }
    ]
  }
}
```

### Автосохранение

Данные сохраняются автоматически после каждого действия:
- Подключение кеги
- Замена кеги
- Остановка крана

### Фильтрация разливного пива

В endpoint `/api/beers/draft` используется фильтр по ключевым словам:
- КЕГ / KEG
- 30L / 50L
- DRAFT

Если ваша номенклатура использует другие обозначения, обновите код в [app.py:996](app.py#L996).

## Будущие улучшения

Возможные доработки:
- 🔄 История изменений по каждому крану
- 📊 Графики загрузки кранов
- 🔔 Уведомления о скором окончании кеги
- 📱 Push-уведомления для мобильных
- 🔍 Поиск по названию пива
- 📈 Статистика популярности сортов
- 🎨 Кастомизация цветов для статусов
- 💾 Экспорт истории в Excel

## Поддержка

При возникновении проблем:
1. Проверьте логи Flask в консоли
2. Откройте DevTools (F12) → Console для ошибок JavaScript
3. Проверьте файл `data/taps_data.json`
4. Убедитесь, что `data/all_products.json` существует

## Версия

- **Версия**: 2.0.0
- **Дата**: 24 октября 2024
- **Статус**: ✅ PRODUCTION READY

---

**Готово к использованию!** 🍺

Откройте http://localhost:5000/taps и начните управлять кранами.
