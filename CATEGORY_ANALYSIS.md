# Анализ по категориям пива

## Что добавлено

Новый функционал для ABC/XYZ анализа по **категориям (стилям)** пива, например:
- Абатское
- Лагер
- Сауэр эли
- Темные эли
- Гозе и овощные гозе
- И т.д.

## Файлы

### Новые файлы:
- `category_analysis.py` - модуль для анализа по категориям
- `CATEGORY_ANALYSIS.md` - эта инструкция

### Изменённые файлы:
- `app.py` - добавлен новый API endpoint `/api/categories`
- `templates/index.html` - добавлен переключатель режимов анализа

## Как использовать

### Веб-интерфейс

1. Запустите сервер:
```bash
python app.py
```

2. Откройте браузер: `http://localhost:5000`

3. В верхней части формы переключите режим на **"По категориям"**

4. Выберите бар и период анализа

5. Нажмите "Запустить анализ"

### Что вы увидите

#### 1. Сводка по категориям
Таблица с основными метриками для каждого стиля пива:
- Количество фасовок
- Общая выручка
- Процент от выручки
- Накопительный процент
- ABC категория самой категории (A/B/C)

#### 2. Топ-10 категорий
Визуальные карточки с:
- Названием категории
- Доминирующей ABC категорией
- Выручкой
- Количеством фасовок

#### 3. Детальный просмотр
При клике на категорию открывается модальное окно:
- ABC распределение внутри категории (AAA, AAB, ABC и т.д.)
- XYZ распределение (X, Y, Z)
- Полная таблица всех фасовок в этой категории

## Примеры использования

### Кейс 1: Определить самые прибыльные стили пива
```
Режим: По категориям
Бар: Лиговский
Период: 90 дней

Результат:
1. IPA - 450,000 руб (AAA) - 45% от выручки
2. Лагер - 320,000 руб (AAB) - 32% от выручки
3. Стаут - 180,000 руб (ACA) - 18% от выручки

Вывод: IPA и Лагер - основа меню, нужно всегда держать в наличии
```

### Кейс 2: Найти слабые категории для замены
```
Режим: По категориям
Бар: Варшавская
Период: 30 дней

Результат:
Сидры - 25,000 руб (CCC) - ABC категория: C

В категории:
- 5 фасовок
- Все с категориями CCC, CCB, BCC
- Нестабильный спрос (Z)

Вывод: Сидры не заходят - убрать из меню
```

### Кейс 3: Оптимизация ассортимента
```
Режим: По категориям
Бар: Все бары
Период: 60 дней

Результат показывает:
- Какие категории популярны везде (универсальные)
- Какие работают только в конкретных барах
- Где можно унифицировать ассортимент
```

## API Endpoint

### POST `/api/categories`

**Request:**
```json
{
  "bar": "Лиговский",  // или null для всех баров
  "days": 30
}
```

**Response:**
```json
{
  "summary": [
    {
      "Category": "IPA",
      "BeersCount": 15,
      "TotalQty": 250,
      "TotalRevenue": 450000,
      "TotalMargin": 280000,
      "AvgMarkupPercent": 1.85,
      "RevenuePercent": 45.0,
      "CumulativePercent": 45.0,
      "ABC_Category": "A"
    },
    ...
  ],
  "categories": {
    "IPA": {
      "category": "IPA",
      "bar": "Лиговский",
      "total_beers": 15,
      "total_revenue": 450000,
      "total_qty": 250,
      "total_margin": 280000,
      "avg_markup_percent": 1.85,
      "abc_stats": {
        "AAA": 5,
        "AAB": 4,
        "ABA": 3,
        ...
      },
      "xyz_stats": {
        "X": 8,
        "Y": 5,
        "Z": 2
      },
      "beers": [
        {
          "Beer": "IPA Cryo 0.5л",
          "TotalQty": 50,
          "TotalRevenue": 85000,
          "ABC_Combined": "AAA",
          "XYZ_Category": "X",
          "CoefficientOfVariation": 8.5,
          "ABCXYZ_Combined": "AAA-X"
        },
        ...
      ]
    }
  }
}
```

## Программное использование

```python
from category_analysis import CategoryAnalysis
from data_processor import BeerDataProcessor
from xyz_analysis import XYZAnalysis

# Подготовка данных
processor = BeerDataProcessor(report_data)
processor.prepare_dataframe()
agg_data = processor.aggregate_by_beer_and_bar()

# Создание анализатора
cat_analyzer = CategoryAnalysis(agg_data, processor.df)

# Получить список категорий
categories = cat_analyzer.get_categories("Лиговский")

# Анализ конкретной категории
result = cat_analyzer.analyze_category("IPA", "Лиговский")

# Сводка по всем категориям
summary = cat_analyzer.get_category_summary("Лиговский")

# Полный анализ всех категорий
all_results = cat_analyzer.analyze_all_categories("Лиговский")

# Добавить XYZ данные
xyz_analyzer = XYZAnalysis(processor.df)
result_with_xyz = cat_analyzer.add_xyz_to_category_analysis(
    result, xyz_analyzer, "Лиговский"
)
```

## Интерпретация результатов

### ABC категории для самих категорий
- **A**: Категория приносит 80% выручки (например, IPA)
- **B**: Категория приносит 15% выручки (например, Стауты)
- **C**: Категория приносит 5% выручки (например, Редкие сорта)

### ABC внутри категорий
Каждое пиво внутри категории получает свою ABC метку (AAA, BBB и т.д.)

### Стратегии по результатам

**Категория A + большинство фасовок AAA-X:**
→ Звездная категория! Расширять ассортимент.

**Категория A + много CCC:**
→ Чистить ассортимент, убирать слабые позиции.

**Категория C + все AAA:**
→ Нишевая премиум-категория, оставить для имиджа.

**Категория C + все CCC:**
→ Убрать всю категорию из меню.

## Отличия от анализа по фасовкам

| Режим | Группировка | Когда использовать |
|-------|-------------|-------------------|
| **По фасовкам** | Каждая конкретная позиция меню (IPA 0.5л, IPA 0.33л) | Управление конкретными позициями меню |
| **По категориям** | Группы по стилям (все IPA вместе) | Стратегия ассортимента, определение направлений |

## Примечания

- Категории определяются полем `Style` из данных iiko
- Анализ работает как для одного бара, так и для всех сразу
- XYZ анализ добавляется автоматически к каждой категории
- Поддерживаются все те же ABC метрики (выручка, наценка, маржа)

## Возможные улучшения

- [ ] Добавить фильтрацию категорий в UI
- [ ] Экспорт результатов анализа категорий в Excel
- [ ] Сравнение категорий между барами
- [ ] Тренды по категориям (динамика за период)
- [ ] Рекомендации по оптимизации ассортимента
