<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление кранами - {{ bar_name }}</title>
    <style>
        :root {
            /* Light Theme */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --shadow: rgba(0, 0, 0, 0.08);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #999999;
            --text-tertiary: #666666;
            --border-color: #333333;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --shadow: rgba(0, 0, 0, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left h1 {
            font-size: 4rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .header-left .subtitle {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            font-weight: 400;
            letter-spacing: 0.02em;
            margin-top: 4px;
        }

        .nav-links {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .nav-link {
            padding: 8px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-link.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .theme-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .theme-btn.active {
            background: var(--accent);
            color: white;
        }

        .theme-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        /* Card */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--accent);
        }

        .stat-card .label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Taps Grid */
        .taps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .tap-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .tap-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .tap-card.empty {
            border-color: var(--text-tertiary);
            opacity: 0.6;
        }

        .tap-card.active {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(5, 150, 105, 0.1) 100%);
        }

        .tap-card.replacing {
            border-color: var(--warning);
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(217, 119, 6, 0.1) 100%);
        }

        .tap-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .tap-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .tap-status.empty {
            background: var(--text-tertiary);
            color: white;
        }

        .tap-status.active {
            background: var(--success);
            color: white;
        }

        .tap-status.replacing {
            background: var(--warning);
            color: white;
        }

        .tap-beer {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            min-height: 1.2em;
        }

        .tap-keg {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .modal-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        select, input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--bg-tertiary);
        }

        .autocomplete-item mark {
            background: var(--accent);
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn.secondary:hover {
            background: var(--border-color);
        }

        .btn.danger {
            background: var(--danger);
        }

        .btn.danger:hover {
            background: #b91c1c;
        }

        .btn.success {
            background: var(--success);
        }

        .btn.success:hover {
            background: #047857;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        /* History Section */
        .history-section {
            margin-top: 40px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .history-count {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .history-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .history-icon.start {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
        }

        .history-icon.stop {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        .history-icon.replace {
            background: rgba(217, 119, 6, 0.1);
            color: var(--warning);
        }

        .history-content {
            flex: 1;
        }

        .history-text {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .history-beer {
            font-weight: 600;
            color: var(--accent);
        }

        .history-meta {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 8px;
        }

        .history-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-tap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-history-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-left h1 {
                font-size: 2.5rem;
            }

            .taps-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .modal-content {
                padding: 24px;
            }

            .history-item {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>{{ bar_name }}</h1>
                <p class="subtitle">Управление кранами</p>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn active" data-theme="light">Светлая</button>
                <button class="theme-btn" data-theme="dark">Темная</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Всего кранов</div>
                <div class="value" id="stat-total">{{ tap_count }}</div>
            </div>
            <div class="stat-card">
                <div class="label">Активных</div>
                <div class="value" id="stat-active" style="color: var(--success);">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Пустых</div>
                <div class="value" id="stat-empty" style="color: var(--text-tertiary);">{{ tap_count }}</div>
            </div>
            <div class="stat-card">
                <div class="label">В работе</div>
                <div class="value" id="stat-percent">0%</div>
            </div>
        </div>

        <!-- Taps Grid -->
        <div class="card">
            <div class="taps-grid" id="taps-grid">
                <!-- Taps will be loaded here -->
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section">
            <div class="history-header">
                <div class="history-title">История изменений</div>
                <div class="history-count" id="history-count">0 событий</div>
            </div>
            <div class="history-list" id="history-list">
                <!-- History will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="tap-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Кран #1</h2>
                <p id="modal-status">Пустой</p>
            </div>
            <div class="modal-body">
                <div class="action-buttons" id="action-buttons">
                    <!-- Action buttons will be inserted here -->
                </div>
                <div id="form-container">
                    <!-- Form will be inserted here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn secondary" onclick="closeModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        const barName = "{{ bar_name }}";
        const barId = "{{ bar_id }}";
        const tapCount = {{ tap_count }};
        let tapsData = [];
        let beersData = [];
        let currentTap = null;

        // Theme toggle
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                localStorage.setItem('theme', theme);
            });
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelectorAll('.theme-btn').forEach(btn => {
            if (btn.dataset.theme === savedTheme) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // Load taps data
        async function loadTaps() {
            try {
                const response = await fetch(`/api/taps/${barId}`);
                const data = await response.json();
                tapsData = data.taps || [];
                renderTaps();
                updateStats();
            } catch (error) {
                console.error('Error loading taps:', error);
            }
        }

        // Load beers list
        async function loadBeers() {
            try {
                const response = await fetch('/api/beers/draft');
                const data = await response.json();
                beersData = data.beers || [];
            } catch (error) {
                console.error('Error loading beers:', error);
            }
        }

        // Render taps
        function renderTaps() {
            const grid = document.getElementById('taps-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= tapCount; i++) {
                const tap = tapsData.find(t => t.tap_number === i) || {
                    tap_number: i,
                    status: 'empty',
                    current_beer: null,
                    current_keg_id: null
                };

                const card = document.createElement('div');
                card.className = `tap-card ${tap.status}`;
                card.onclick = () => openTapModal(tap);

                const statusText = {
                    'empty': 'Пустой',
                    'active': 'Активный',
                    'replacing': 'Замена'
                };

                card.innerHTML = `
                    <div class="tap-number">Кран #${tap.tap_number}</div>
                    <span class="tap-status ${tap.status}">${statusText[tap.status]}</span>
                    <div class="tap-beer">${tap.current_beer || '—'}</div>
                    <div class="tap-keg">${tap.current_keg_id || ''}</div>
                `;

                grid.appendChild(card);
            }
        }

        // Update stats
        function updateStats() {
            const active = tapsData.filter(t => t.status === 'active').length;
            const empty = tapCount - tapsData.length + tapsData.filter(t => t.status === 'empty').length;
            const percent = Math.round((active / tapCount) * 100);

            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-empty').textContent = empty;
            document.getElementById('stat-percent').textContent = percent + '%';
        }

        // Open tap modal
        function openTapModal(tap) {
            currentTap = tap;
            document.getElementById('modal-title').textContent = `Кран #${tap.tap_number}`;

            const statusText = {
                'empty': 'Пустой',
                'active': 'Активный',
                'replacing': 'Идёт замена'
            };
            document.getElementById('modal-status').textContent = statusText[tap.status];

            const actionButtons = document.getElementById('action-buttons');
            actionButtons.innerHTML = '';

            if (tap.status === 'empty') {
                actionButtons.innerHTML = '';
                // Сразу показываем форму для подключения
                setTimeout(() => showStartForm(), 0);
            } else if (tap.status === 'active') {
                actionButtons.innerHTML = `
                    <button class="btn warning" onclick="showReplaceForm()">Заменить сорт</button>
                    <button class="btn danger" onclick="stopTap()">Остановить кран</button>
                `;
                document.getElementById('form-container').innerHTML = '';
            }

            document.getElementById('tap-modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('tap-modal').classList.remove('active');
            currentTap = null;
        }

        // Autocomplete function
        function setupBeerAutocomplete(inputId) {
            const input = document.getElementById(inputId);
            const listId = inputId + '-list';

            // Create autocomplete list
            const listDiv = document.createElement('div');
            listDiv.id = listId;
            listDiv.className = 'autocomplete-list';
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(listDiv);

            let selectedIndex = -1;

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                listDiv.innerHTML = '';
                selectedIndex = -1;

                if (!value) {
                    listDiv.classList.remove('active');
                    return;
                }

                const filtered = beersData.filter(beer =>
                    beer.name.toLowerCase().includes(value)
                ).slice(0, 10); // Показываем первые 10 результатов

                if (filtered.length === 0) {
                    listDiv.classList.remove('active');
                    return;
                }

                filtered.forEach((beer, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    // Подсвечиваем совпадение
                    const regex = new RegExp(`(${value})`, 'gi');
                    const highlighted = beer.name.replace(regex, '<mark>$1</mark>');
                    div.innerHTML = highlighted;

                    div.addEventListener('click', function() {
                        input.value = beer.name;
                        input.dataset.beerNum = beer.num || ''; // Сохраняем артикул
                        listDiv.classList.remove('active');
                        // Автоматически заполняем поле артикула
                        const artikulInput = document.getElementById('artikul');
                        if (artikulInput && beer.num) {
                            artikulInput.value = beer.num;
                        }
                    });

                    listDiv.appendChild(div);
                });

                listDiv.classList.add('active');
            });

            // Keyboard navigation
            input.addEventListener('keydown', function(e) {
                const items = listDiv.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    const selectedBeer = filtered[selectedIndex];
                    input.value = selectedBeer.name;
                    input.dataset.beerNum = selectedBeer.num || ''; // Сохраняем артикул
                    // Автоматически заполняем поле артикула
                    const artikulInput = document.getElementById('artikul');
                    if (artikulInput && selectedBeer.num) {
                        artikulInput.value = selectedBeer.num;
                    }
                    listDiv.classList.remove('active');
                } else if (e.key === 'Escape') {
                    listDiv.classList.remove('active');
                }
            });

            function updateSelection(items) {
                items.forEach((item, index) => {
                    if (index === selectedIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            // Close on click outside
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    listDiv.classList.remove('active');
                }
            });
        }

        // Show start form
        function showStartForm() {
            const container = document.getElementById('form-container');
            container.innerHTML = `
                <div class="form-group">
                    <label>Выберите пиво (начните печатать)</label>
                    <input type="text" id="beer-input" placeholder="Начните вводить название..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Артикул</label>
                    <input type="text" id="artikul" placeholder="Артикул из iiko" readonly>
                </div>
                <button class="btn success" onclick="startTap()" style="width: 100%; margin-top: 12px;">Подключить</button>
            `;

            // Setup autocomplete
            setTimeout(() => setupBeerAutocomplete('beer-input'), 0);
        }

        // Show replace form
        function showReplaceForm() {
            const container = document.getElementById('form-container');
            container.innerHTML = `
                <div class="form-group">
                    <label>Текущее пиво</label>
                    <input type="text" value="${currentTap.current_beer}" disabled>
                </div>
                <div class="form-group">
                    <label>Новое пиво (начните печатать)</label>
                    <input type="text" id="beer-input" placeholder="Начните вводить название..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Артикул</label>
                    <input type="text" id="artikul" placeholder="Артикул из iiko" readonly>
                </div>
                <button class="btn warning" onclick="replaceTap()" style="width: 100%; margin-top: 12px;">Заменить</button>
            `;

            // Setup autocomplete
            setTimeout(() => setupBeerAutocomplete('beer-input'), 0);
        }

        // Start tap
        async function startTap() {
            const beerName = document.getElementById('beer-input').value.trim();
            const artikul = document.getElementById('artikul').value || `AUTO-${Date.now()}`;

            if (!beerName) {
                alert('Введите название пива');
                return;
            }

            try {
                const response = await fetch(`/api/taps/${barId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tap_number: currentTap.tap_number,
                        beer_name: beerName,
                        keg_id: artikul
                    })
                });

                if (response.ok) {
                    closeModal();
                    loadTaps();
                    loadHistory();
                } else {
                    alert('Ошибка при подключении кеги');
                }
            } catch (error) {
                console.error('Error starting tap:', error);
                alert('Ошибка при подключении кеги');
            }
        }

        // Replace tap
        async function replaceTap() {
            const beerName = document.getElementById('beer-input').value.trim();
            const artikul = document.getElementById('artikul').value || `AUTO-${Date.now()}`;

            if (!beerName) {
                alert('Введите название пива');
                return;
            }

            try {
                const response = await fetch(`/api/taps/${barId}/replace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tap_number: currentTap.tap_number,
                        beer_name: beerName,
                        keg_id: artikul
                    })
                });

                if (response.ok) {
                    closeModal();
                    loadTaps();
                    loadHistory();
                } else {
                    alert('Ошибка при замене кеги');
                }
            } catch (error) {
                console.error('Error replacing tap:', error);
                alert('Ошибка при замене кеги');
            }
        }

        // Stop tap
        async function stopTap() {
            if (!confirm('Остановить кран?')) {
                return;
            }

            try {
                const response = await fetch(`/api/taps/${barId}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tap_number: currentTap.tap_number
                    })
                });

                if (response.ok) {
                    closeModal();
                    loadTaps();
                    loadHistory();
                } else {
                    alert('Ошибка при остановке крана');
                }
            } catch (error) {
                console.error('Error stopping tap:', error);
                alert('Ошибка при остановке крана');
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`/api/taps/events/all?bar_id=${barId}&limit=50`);
                const data = await response.json();
                const events = data.events || [];

                renderHistory(events);
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Render history
        function renderHistory(events) {
            const container = document.getElementById('history-list');
            const countEl = document.getElementById('history-count');

            countEl.textContent = events.length === 0 ? 'Нет событий' :
                                 events.length === 1 ? '1 событие' :
                                 events.length < 5 ? `${events.length} события` :
                                 `${events.length} событий`;

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">📋</div>
                        <p>История пуста</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Все действия с кранами будут отображаться здесь</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => {
                const date = new Date(event.timestamp);
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                const formattedTime = date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let icon = '🔄';
                let iconClass = 'replace';
                let text = '';

                if (event.action === 'start') {
                    icon = '✅';
                    iconClass = 'start';
                    text = `Подключена кега <span class="history-beer">${event.beer_name}</span>`;
                } else if (event.action === 'stop') {
                    icon = '⛔';
                    iconClass = 'stop';
                    text = `Закончилась кега <span class="history-beer">${event.beer_name}</span>`;
                } else if (event.action === 'replace') {
                    icon = '🔄';
                    iconClass = 'replace';
                    text = `Замена <span class="history-beer">${event.old_beer || 'пиво'}</span> на <span class="history-beer">${event.beer_name}</span>`;
                }

                return `
                    <div class="history-item">
                        <div class="history-icon ${iconClass}">${icon}</div>
                        <div class="history-content">
                            <div class="history-text">${text}</div>
                            <div class="history-meta">
                                <div class="history-time">🕐 ${formattedTime} ${formattedDate}</div>
                                <div class="history-tap">🍺 Кран #${event.tap_number}</div>
                                ${event.keg_id ? `<div>🏷️ ${event.keg_id}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Close modal on background click
        document.getElementById('tap-modal').addEventListener('click', (e) => {
            if (e.target.id === 'tap-modal') {
                closeModal();
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadTaps();
            loadHistory();
        }, 30000);

        // Initial load
        loadBeers();
        loadTaps();
        loadHistory();
    </script>
</body>
</html>
