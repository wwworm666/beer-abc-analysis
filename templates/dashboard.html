<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –ê–Ω–∞–ª–∏—Ç–∏–∫–∏ - –ü–ª–∞–Ω vs –§–∞–∫—Ç</title>
    <style>
        :root {
            /* Light Theme */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --shadow: rgba(0, 0, 0, 0.08);
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #999999;
            --text-tertiary: #666666;
            --border-color: #333333;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --shadow: rgba(0, 0, 0, 0.3);
            --success: #10b981;
            --success-light: #064e3b;
            --warning: #f59e0b;
            --warning-light: #78350f;
            --danger: #ef4444;
            --danger-light: #7f1d1d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left h1 {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1;
        }

        .header-left .subtitle {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .theme-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .theme-btn.active {
            background: var(--accent);
            color: white;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        /* Period Selector */
        .period-selector {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .period-nav {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 24px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 32px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        /* Metric Card */
        .metric-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .metric-card[data-status="success"] {
            border-color: var(--success);
        }

        .metric-card[data-status="warning"] {
            border-color: var(--warning);
        }

        .metric-card[data-status="danger"] {
            border-color: var(--danger);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-icon {
            font-size: 1.5rem;
        }

        .metric-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-body {
            margin-bottom: 16px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .metric-row-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .metric-row-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-fill[data-status="success"] {
            background: var(--success);
        }

        .progress-fill[data-status="warning"] {
            background: var(--warning);
        }

        .progress-fill[data-status="danger"] {
            background: var(--danger);
        }

        .metric-footer {
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }

        .metric-footer.status-success {
            background: var(--success-light);
            color: var(--success);
        }

        .metric-footer.status-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .metric-footer.status-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .metric-footer.status-neutral {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Plans Form */
        .plans-form {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .plan-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .plan-input-group input {
            padding: 12px;
            font-size: 1rem;
        }

        .plan-input-group .input-suffix {
            position: relative;
        }

        .plan-input-group .suffix-text {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 32px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .message.active {
            display: block;
        }

        .message.error {
            background: var(--danger-light);
            color: var(--danger);
        }

        .message.success {
            background: var(--success-light);
            color: var(--success);
        }

        .message.info {
            background: var(--warning-light);
            color: var(--warning);
        }

        /* No Plan State */
        .no-plan {
            text-align: center;
            padding: 60px 32px;
        }

        .no-plan h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .no-plan p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .header-left h1 {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .plans-form {
                grid-template-columns: 1fr;
            }

            .period-selector {
                flex-direction: column;
            }

            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üìä –î–∞—à–±–æ—Ä–¥ –ê–Ω–∞–ª–∏—Ç–∏–∫–∏</h1>
                <div class="subtitle">–ü–ª–∞–Ω vs –§–∞–∫—Ç ‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –±–∏–∑–Ω–µ—Å–∞</div>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn active" onclick="setTheme('light')">–°–≤–µ—Ç–ª–∞—è</button>
                <button class="theme-btn" onclick="setTheme('dark')">–¢—ë–º–Ω–∞—è</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('plans')">‚öôÔ∏è –ü–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>
        </div>

        <!-- Messages -->
        <div class="message error" id="error-message"></div>
        <div class="message success" id="success-message"></div>

        <!-- ==================== TAB 1: ANALYTICS ==================== -->
        <div class="tab-content active" id="analytics-tab">
            <!-- Period Selector -->
            <div class="card">
                <h2 style="margin-bottom: 20px; font-size: 1.3rem;">–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞</h2>

                <div class="period-selector">
                    <div class="form-group" style="flex: 2;">
                        <label for="week-selector">–ù–µ–¥–µ–ª—è</label>
                        <select id="week-selector" onchange="handleWeekChange()">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="custom-period-group">
                        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input type="date" id="custom-date-from">
                    </div>

                    <div class="form-group hidden" id="custom-period-group-2">
                        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="date" id="custom-date-to">
                    </div>

                    <div class="period-nav">
                        <button class="btn btn-secondary" onclick="navigateWeek(-1)">‚Üê –ü—Ä–µ–¥.</button>
                        <button class="btn btn-secondary" onclick="goToCurrentWeek()">–°–µ–≥–æ–¥–Ω—è</button>
                        <button class="btn btn-secondary" onclick="navigateWeek(1)">–°–ª–µ–¥. ‚Üí</button>
                    </div>

                    <button class="btn" onclick="loadAnalytics()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="card loading" id="analytics-loading">
                <div class="spinner"></div>
                <h2>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</h2>
                <p>–ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ iiko –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–ª–∞–Ω–æ–º</p>
            </div>

            <!-- Results -->
            <div id="analytics-results" class="hidden">
                <!-- Stats Bar -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-label">–í—Å–µ–≥–æ –º–µ—Ç—Ä–∏–∫</div>
                        <div class="stat-value" id="stat-total">15</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ü–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã</div>
                        <div class="stat-value" id="stat-completed">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                        <div class="stat-value" id="stat-average">-</div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="metrics-grid" id="metrics-grid">
                    <!-- Cards will be generated by JavaScript -->
                </div>
            </div>

            <!-- No Plan State -->
            <div class="card no-plan hidden" id="no-plan-state">
                <h3>üìã –ü–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω</h3>
                <p>–î–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω—ã –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</p>
                <button class="btn" onclick="switchTab('plans')">–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω</button>
            </div>
        </div>

        <!-- ==================== TAB 2: PLANS ==================== -->
        <div class="tab-content" id="plans-tab">
            <!-- Period Selector (same as analytics) -->
            <div class="card">
                <h2 style="margin-bottom: 20px; font-size: 1.3rem;">–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞</h2>

                <div class="period-selector">
                    <div class="form-group" style="flex: 2;">
                        <label for="plan-week-selector">–ù–µ–¥–µ–ª—è</label>
                        <select id="plan-week-selector">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>

                    <button class="btn" onclick="loadPlanForEditing()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞–Ω</button>
                </div>
            </div>

            <!-- Plans Form -->
            <div class="card">
                <h2 style="margin-bottom: 24px; font-size: 1.3rem;">–ü–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>

                <form id="plans-form" onsubmit="savePlan(event)">
                    <div class="plans-form">
                        <!-- –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
                        <div class="plan-input-group">
                            <label>üí∞ –í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="revenue" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üßæ –ß–µ–∫–∏ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="1" min="0" name="checks" required>
                                <span class="suffix-text">—à—Ç</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üíµ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="averageCheck" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <!-- –î–æ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                        <div class="plan-input-group">
                            <label>üç∫ –î–æ–ª—è —Ä–æ–∑–ª–∏–≤–∞ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" max="100" name="draftShare" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üçæ –î–æ–ª—è —Ñ–∞—Å–æ–≤–∫–∏ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" max="100" name="packagedShare" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üçΩÔ∏è –î–æ–ª—è –∫—É—Ö–Ω–∏ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" max="100" name="kitchenShare" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <!-- –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                        <div class="plan-input-group">
                            <label>üí∞ –í—ã—Ä—É—á–∫–∞ —Ä–æ–∑–ª–∏–≤ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="revenueDraft" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üí∞ –í—ã—Ä—É—á–∫–∞ —Ñ–∞—Å–æ–≤–∫–∞ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="revenuePackaged" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üí∞ –í—ã—Ä—É—á–∫–∞ –∫—É—Ö–Ω—è (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="revenueKitchen" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <!-- –ù–∞—Ü–µ–Ω–∫–∏ -->
                        <div class="plan-input-group">
                            <label>üìà % –Ω–∞—Ü–µ–Ω–∫–∏ –æ–±—â–∏–π (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="markupPercent" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üíπ –ü—Ä–∏–±—ã–ª—å (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="profit" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üìà –ù–∞—Ü–µ–Ω–∫–∞ —Ä–æ–∑–ª–∏–≤ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="markupDraft" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üìà –ù–∞—Ü–µ–Ω–∫–∞ —Ñ–∞—Å–æ–≤–∫–∞ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="markupPackaged" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <div class="plan-input-group">
                            <label>üìà –ù–∞—Ü–µ–Ω–∫–∞ –∫—É—Ö–Ω—è (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="markupKitchen" required>
                                <span class="suffix-text">%</span>
                            </div>
                        </div>

                        <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
                        <div class="plan-input-group">
                            <label>üí≥ –°–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ (–ø–ª–∞–Ω)</label>
                            <div class="input-suffix">
                                <input type="number" step="0.01" min="0" name="loyaltyWriteoffs" required>
                                <span class="suffix-text">‚ÇΩ</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="copyPlanDialog()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>
                        <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================

        let currentWeeks = [];
        let currentWeekIndex = -1;
        let currentPeriod = null;

        // ============================================================================
        // THEME MANAGEMENT
        // ============================================================================

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelectorAll('.theme-btn').forEach(btn => {
            if ((savedTheme === 'light' && btn.textContent.includes('–°–≤–µ—Ç–ª–∞—è')) ||
                (savedTheme === 'dark' && btn.textContent.includes('–¢—ë–º–Ω–∞—è'))) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // ============================================================================
        // TAB MANAGEMENT
        // ============================================================================

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // If switching to plans tab, sync the week selector
            if (tabName === 'plans') {
                syncPlanWeekSelector();
            }
        }

        // ============================================================================
        // WEEKS MANAGEMENT
        // ============================================================================

        async function loadWeeks() {
            try {
                const response = await fetch('/api/weeks');
                if (!response.ok) throw new Error('Failed to load weeks');

                const data = await response.json();
                currentWeeks = data.weeks;

                // Populate both selectors
                populateWeekSelector('week-selector', data.weeks, data.current_week.key);
                populateWeekSelector('plan-week-selector', data.weeks, data.current_week.key);

                // Set current week index
                currentWeekIndex = currentWeeks.findIndex(w => w.is_current);
                if (currentWeekIndex === -1) currentWeekIndex = 0;

                console.log('[WEEKS] Loaded', currentWeeks.length, 'weeks');

            } catch (error) {
                console.error('[WEEKS ERROR]', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–µ–ª—å: ' + error.message);
            }
        }

        function populateWeekSelector(selectId, weeks, currentKey) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';

            // Add weeks
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week.key;
                option.textContent = week.label;
                if (week.is_current) {
                    option.textContent += ' ‚Üê –¢–ï–ö–£–©–ê–Ø';
                }
                select.appendChild(option);
            });

            // Add custom option
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'üìÖ –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –≤—Ä—É—á–Ω—É—é';
            select.appendChild(customOption);

            // Select current week
            select.value = currentKey;
        }

        function handleWeekChange() {
            const selector = document.getElementById('week-selector');
            const value = selector.value;

            if (value === 'custom') {
                // Show custom date inputs
                document.getElementById('custom-period-group').classList.remove('hidden');
                document.getElementById('custom-period-group-2').classList.remove('hidden');
            } else {
                // Hide custom date inputs
                document.getElementById('custom-period-group').classList.add('hidden');
                document.getElementById('custom-period-group-2').classList.add('hidden');

                // Update current week index
                currentWeekIndex = currentWeeks.findIndex(w => w.key === value);
            }
        }

        function navigateWeek(direction) {
            const newIndex = currentWeekIndex + direction;
            if (newIndex < 0 || newIndex >= currentWeeks.length) return;

            currentWeekIndex = newIndex;
            document.getElementById('week-selector').value = currentWeeks[currentWeekIndex].key;
            handleWeekChange();
        }

        function goToCurrentWeek() {
            const currentWeek = currentWeeks.find(w => w.is_current);
            if (currentWeek) {
                document.getElementById('week-selector').value = currentWeek.key;
                currentWeekIndex = currentWeeks.findIndex(w => w.is_current);
                handleWeekChange();
            }
        }

        function syncPlanWeekSelector() {
            const analyticsValue = document.getElementById('week-selector').value;
            document.getElementById('plan-week-selector').value = analyticsValue;
        }

        function getCurrentPeriod() {
            const selector = document.getElementById('week-selector');
            const value = selector.value;

            if (value === 'custom') {
                const dateFrom = document.getElementById('custom-date-from').value;
                const dateTo = document.getElementById('custom-date-to').value;

                if (!dateFrom || !dateTo) {
                    showError('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞');
                    return null;
                }

                return {
                    key: `${dateFrom}_${dateTo}`,
                    start: dateFrom,
                    end: dateTo
                };
            } else {
                const week = currentWeeks.find(w => w.key === value);
                return week ? {
                    key: week.key,
                    start: week.start,
                    end: week.end
                } : null;
            }
        }

        // ============================================================================
        // ANALYTICS LOADING
        // ============================================================================

        async function loadAnalytics() {
            const period = getCurrentPeriod();
            if (!period) return;

            currentPeriod = period;

            // Show loading
            document.getElementById('analytics-loading').classList.add('active');
            document.getElementById('analytics-results').classList.add('hidden');
            document.getElementById('no-plan-state').classList.add('hidden');
            hideMessages();

            try {
                // Load plan and actual data in parallel
                const [planResponse, actualResponse] = await Promise.all([
                    fetch(`/api/plans/${period.key}`),
                    fetch('/api/dashboard-analytics', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            bar: '',  // Empty = all bars
                            date_from: period.start,
                            date_to: period.end
                        })
                    })
                ]);

                // Check if plan exists
                const hasPlan = planResponse.ok;
                const plan = hasPlan ? await planResponse.json() : null;

                // Check if actual data exists
                if (!actualResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ');
                }
                const actual = await actualResponse.json();

                // Hide loading
                document.getElementById('analytics-loading').classList.remove('active');

                if (!hasPlan) {
                    // Show no plan state
                    document.getElementById('no-plan-state').classList.remove('hidden');
                } else {
                    // Compare and display
                    displayComparison(plan, actual);
                }

            } catch (error) {
                console.error('[ANALYTICS ERROR]', error);
                document.getElementById('analytics-loading').classList.remove('active');
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // ============================================================================
        // COMPARISON LOGIC
        // ============================================================================

        function displayComparison(plan, actual) {
            const metrics = [
                {
                    icon: 'üí∞',
                    name: '–í—ã—Ä—É—á–∫–∞',
                    planKey: 'revenue',
                    actualKey: 'total_revenue',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üßæ',
                    name: '–ß–µ–∫–∏',
                    planKey: 'checks',
                    actualKey: 'total_checks',
                    unit: '—à—Ç',
                    format: 'number'
                },
                {
                    icon: 'üíµ',
                    name: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫',
                    planKey: 'averageCheck',
                    actualKey: 'avg_check',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üç∫',
                    name: '–î–æ–ª—è —Ä–æ–∑–ª–∏–≤–∞',
                    planKey: 'draftShare',
                    actualKey: 'draft_share',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üçæ',
                    name: '–î–æ–ª—è —Ñ–∞—Å–æ–≤–∫–∏',
                    planKey: 'packagedShare',
                    actualKey: 'bottles_share',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üçΩÔ∏è',
                    name: '–î–æ–ª—è –∫—É—Ö–Ω–∏',
                    planKey: 'kitchenShare',
                    actualKey: 'kitchen_share',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üí∞',
                    name: '–í—ã—Ä—É—á–∫–∞ —Ä–æ–∑–ª–∏–≤',
                    planKey: 'revenueDraft',
                    actualKey: 'draft_revenue',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üí∞',
                    name: '–í—ã—Ä—É—á–∫–∞ —Ñ–∞—Å–æ–≤–∫–∞',
                    planKey: 'revenuePackaged',
                    actualKey: 'bottles_revenue',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üí∞',
                    name: '–í—ã—Ä—É—á–∫–∞ –∫—É—Ö–Ω—è',
                    planKey: 'revenueKitchen',
                    actualKey: 'kitchen_revenue',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üìà',
                    name: '% –Ω–∞—Ü–µ–Ω–∫–∏',
                    planKey: 'markupPercent',
                    actualKey: 'avg_markup',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üíπ',
                    name: '–ü—Ä–∏–±—ã–ª—å',
                    planKey: 'profit',
                    actualKey: 'total_margin',
                    unit: '‚ÇΩ',
                    format: 'money'
                },
                {
                    icon: 'üìà',
                    name: '–ù–∞—Ü–µ–Ω–∫–∞ —Ä–æ–∑–ª–∏–≤',
                    planKey: 'markupDraft',
                    actualKey: 'draft_markup',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üìà',
                    name: '–ù–∞—Ü–µ–Ω–∫–∞ —Ñ–∞—Å–æ–≤–∫–∞',
                    planKey: 'markupPackaged',
                    actualKey: 'bottles_markup',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üìà',
                    name: '–ù–∞—Ü–µ–Ω–∫–∞ –∫—É—Ö–Ω—è',
                    planKey: 'markupKitchen',
                    actualKey: 'kitchen_markup',
                    unit: '%',
                    format: 'percent'
                },
                {
                    icon: 'üí≥',
                    name: '–°–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤',
                    planKey: 'loyaltyWriteoffs',
                    actualKey: 'loyalty_points_written_off',
                    unit: '‚ÇΩ',
                    format: 'money'
                }
            ];

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = '';

            let completedCount = 0;
            let totalPercent = 0;

            metrics.forEach(metric => {
                const planValue = plan[metric.planKey];
                const actualValue = actual[metric.actualKey];

                // Calculate percentage
                const percent = planValue > 0 ? (actualValue / planValue) * 100 : 0;
                const diff = actualValue - planValue;

                // Determine status
                let status = 'neutral';
                if (percent >= 100) {
                    status = 'success';
                    completedCount++;
                } else if (percent >= 90) {
                    status = 'warning';
                } else {
                    status = 'danger';
                }

                totalPercent += percent;

                // Create card
                const card = createMetricCard(metric, planValue, actualValue, percent, diff, status);
                grid.appendChild(card);
            });

            // Update stats
            document.getElementById('stat-total').textContent = metrics.length;
            document.getElementById('stat-completed').textContent = `${completedCount} –∏–∑ ${metrics.length}`;
            document.getElementById('stat-average').textContent = `${(totalPercent / metrics.length).toFixed(1)}%`;

            // Show results
            document.getElementById('analytics-results').classList.remove('hidden');
        }

        function createMetricCard(metric, planValue, actualValue, percent, diff, status) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            card.setAttribute('data-status', status);

            const statusIcon = status === 'success' ? '‚úÖ' : status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            const statusText = status === 'success' ? '–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω' :
                             status === 'warning' ? '–ë–ª–∏–∑–∫–æ –∫ –ø–ª–∞–Ω—É' : '–ü–ª–∞–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω';

            const formattedPlan = formatValue(planValue, metric.format);
            const formattedActual = formatValue(actualValue, metric.format);
            const formattedDiff = formatValue(Math.abs(diff), metric.format);
            const diffSign = diff >= 0 ? '+' : '-';

            card.innerHTML = `
                <div class="metric-header">
                    <span class="metric-icon">${metric.icon}</span>
                    <span class="metric-name">${metric.name}</span>
                </div>
                <div class="metric-body">
                    <div class="metric-row">
                        <span class="metric-row-label">üéØ –ü–ª–∞–Ω:</span>
                        <span class="metric-row-value">${formattedPlan} ${metric.unit}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row-label">‚úÖ –§–∞–∫—Ç:</span>
                        <span class="metric-row-value">${formattedActual} ${metric.unit}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row-label">üìä –í—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                        <span class="metric-row-value">${percent.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" data-status="${status}" style="width: ${Math.min(percent, 100)}%"></div>
                </div>
                <div class="metric-footer status-${status}">
                    ${statusIcon} ${statusText} (${diffSign}${formattedDiff} ${metric.unit})
                </div>
            `;

            return card;
        }

        function formatValue(value, format) {
            if (format === 'money') {
                return new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 0}).format(value);
            } else if (format === 'percent') {
                return value.toFixed(2);
            } else {
                return new Intl.NumberFormat('ru-RU').format(value);
            }
        }

        // ============================================================================
        // PLANS MANAGEMENT
        // ============================================================================

        function loadPlanForEditing() {
            const selector = document.getElementById('plan-week-selector');
            const periodKey = selector.value;

            if (periodKey === 'custom') {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –Ω–µ–¥–µ–ª—é');
                return;
            }

            fetch(`/api/plans/${periodKey}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        // No plan exists - clear form
                        clearPlanForm();
                        showInfo('–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.');
                        return null;
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–∞');
                    }
                })
                .then(plan => {
                    if (plan) {
                        populatePlanForm(plan);
                        showSuccess('–ü–ª–∞–Ω –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                })
                .catch(error => {
                    console.error('[PLAN ERROR]', error);
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–∞: ' + error.message);
                });
        }

        function populatePlanForm(plan) {
            const form = document.getElementById('plans-form');
            const inputs = form.querySelectorAll('input[name]');

            inputs.forEach(input => {
                const name = input.name;
                if (plan[name] !== undefined) {
                    input.value = plan[name];
                }
            });
        }

        function clearPlanForm() {
            document.getElementById('plans-form').reset();
        }

        async function savePlan(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const planData = {};

            for (let [key, value] of formData.entries()) {
                planData[key] = parseFloat(value);
            }

            // Validate shares sum
            const sharesSum = planData.draftShare + planData.packagedShare + planData.kitchenShare;
            if (Math.abs(sharesSum - 100) > 1) {
                showError(`–°—É–º–º–∞ –¥–æ–ª–µ–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%, —Å–µ–π—á–∞—Å ${sharesSum.toFixed(2)}%`);
                return;
            }

            const selector = document.getElementById('plan-week-selector');
            const periodKey = selector.value;

            if (periodKey === 'custom') {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –Ω–µ–¥–µ–ª—é');
                return;
            }

            try {
                const response = await fetch('/api/plans', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        period: periodKey,
                        data: planData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

                showSuccess('‚úÖ –ü–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');

            } catch (error) {
                console.error('[SAVE ERROR]', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }

        function copyPlanDialog() {
            // Simple prompt-based copy (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º)
            const allWeeksText = currentWeeks.map((w, i) => `${i + 1}. ${w.label}`).join('\n');
            const choice = prompt(
                '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏, –æ—Ç–∫—É–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω:\n\n' + allWeeksText
            );

            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < currentWeeks.length) {
                    const sourceKey = currentWeeks[index].key;
                    copyPlanFrom(sourceKey);
                } else {
                    showError('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏');
                }
            }
        }

        async function copyPlanFrom(sourceKey) {
            try {
                const response = await fetch(`/api/plans/${sourceKey}`);
                if (!response.ok) {
                    throw new Error('–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const plan = await response.json();

                // Remove metadata
                delete plan.createdAt;
                delete plan.updatedAt;

                // Populate form
                populatePlanForm(plan);
                showSuccess(`–ü–ª–∞–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–∑ –ø–µ—Ä–∏–æ–¥–∞ ${sourceKey}`);

            } catch (error) {
                console.error('[COPY ERROR]', error);
                showError('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        }

        // ============================================================================
        // MESSAGES
        // ============================================================================

        function showError(message) {
            hideMessages();
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 5000);
        }

        function showSuccess(message) {
            hideMessages();
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 3000);
        }

        function showInfo(message) {
            // Can add info message element if needed
            alert(message);
        }

        function hideMessages() {
            document.querySelectorAll('.message').forEach(msg => {
                msg.classList.remove('active');
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INIT] Loading dashboard...');
            loadWeeks();
        });
    </script>
</body>
</html>
