<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Management Platform | Официанты</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/claude-design.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        .leaderboard-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: 0 2px 8px var(--shadow-light);
            margin-bottom: var(--space-md);
            border-left: 4px solid transparent;
            transition: all var(--transition-base);
        }

        .leaderboard-card.rank-1 {
            border-left-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, var(--bg-card) 100%);
        }

        .leaderboard-card.rank-2 {
            border-left-color: #C0C0C0;
        }

        .leaderboard-card.rank-3 {
            border-left-color: #CD7F32;
        }

        .leaderboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 700;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .rank-badge.rank-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #FFFFFF;
        }

        .rank-badge.rank-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
            color: #FFFFFF;
        }

        .rank-badge.rank-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #B8722E 100%);
            color: #FFFFFF;
        }

        .waiter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .waiter-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .waiter-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .waiter-stat-value {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            font-feature-settings: 'tnum';
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header-title">Анализ официантов</h1>
                <p class="header-subtitle">Рейтинг продаж и производительность персонала</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="/" class="nav-item">Фасовка</a>
            <a href="/draft" class="nav-item">Разливное</a>
            <a href="/waiters" class="nav-item active">Официанты</a>
            <a href="/taps" class="nav-item">Краны</a>
            <a href="/stocks" class="nav-item">Остатки</a>
        </nav>

        <!-- Controls Card -->
        <div class="card mb-lg">
            <div class="flex flex-gap-md" style="flex-wrap: wrap; align-items: end;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label" for="bar-select">Бар</label>
                    <select class="form-select" id="bar-select">
                        <option value="">Все бары</option>
                        {% for bar in bars %}
                        <option value="{{ bar }}">{{ bar }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label" for="period-select">Период</label>
                    <select class="form-select" id="period-select">
                        <option value="7">Неделя</option>
                        <option value="14">2 недели</option>
                        <option value="30" selected>Месяц</option>
                        <option value="60">2 месяца</option>
                        <option value="90">Квартал</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="runAnalysis()" style="min-width: 180px;">
                    Запустить анализ
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <div class="loading-spinner" style="margin: 0 auto 24px;"></div>
                <h3 style="margin-bottom: 8px; color: var(--text-primary);">Анализируем данные...</h3>
                <p style="color: var(--text-secondary);">Получаем статистику продаж по каждому официанту</p>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="display: none;">
            <!-- Total Stats -->
            <div class="cards-grid mb-lg" id="total-stats">
                <!-- Будут добавлены через JS -->
            </div>

            <!-- Leaderboard Title -->
            <h3 style="color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: var(--space-md);">
                Рейтинг официантов
            </h3>

            <!-- Leaderboard -->
            <div id="leaderboard-container">
                <!-- Будут добавлены через JS -->
            </div>
        </div>

        <!-- No Data State -->
        <div id="no-data-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <h3 style="margin-bottom: 12px; color: var(--text-primary);">Нет данных за выбранный период</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    Попробуйте выбрать другой период или бар
                </p>
                <button class="btn btn-secondary" onclick="hideNoData()">
                    Вернуться к настройкам
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/microinteractions.js"></script>
    <script>
        async function runAnalysis() {
            const bar = document.getElementById('bar-select').value;
            const period = document.getElementById('period-select').value;

            // Скрыть результаты и no-data
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-data-container').style.display = 'none';

            // Показать loading
            document.getElementById('loading-container').style.display = 'block';

            try {
                const requestBody = {
                    bar: bar || '',
                    days: parseInt(period)
                };

                const response = await fetch('/api/waiter-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                // Скрыть loading
                document.getElementById('loading-container').style.display = 'none';

                if (data.error) {
                    BeerPlatform.showToast(data.error, 'error');
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                if (!data.waiters || data.waiters.length === 0) {
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                // Отобразить результаты
                displayResults(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-container').style.display = 'none';
                BeerPlatform.showToast('Ошибка при получении данных', 'error');
                document.getElementById('no-data-container').style.display = 'block';
            }
        }

        function displayResults(data) {
            // Показать контейнер результатов
            document.getElementById('results-container').style.display = 'block';

            // Total Stats
            displayTotalStats(data);

            // Leaderboard
            displayLeaderboard(data.waiters);
        }

        function displayTotalStats(data) {
            const container = document.getElementById('total-stats');
            container.innerHTML = '';

            const metrics = [
                { label: 'Всего официантов', value: data.total_waiters || 0 },
                { label: 'Общая выручка', value: data.total_revenue || 0, suffix: ' ₽' },
                { label: 'Средний чек', value: data.avg_check || 0, suffix: ' ₽' },
                { label: 'Всего заказов', value: data.total_orders || 0 }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value-md">${formatNumber(metric.value)}${metric.suffix || ''}</div>
                `;
                container.appendChild(card);
            });
        }

        function displayLeaderboard(waiters) {
            const container = document.getElementById('leaderboard-container');
            container.innerHTML = '';

            // Сортируем по выручке
            const sorted = [...waiters].sort((a, b) => (b.total_revenue || 0) - (a.total_revenue || 0));

            sorted.forEach((waiter, index) => {
                const rank = index + 1;
                const card = document.createElement('div');
                card.className = `leaderboard-card ${rank <= 3 ? `rank-${rank}` : ''}`;

                card.innerHTML = `
                    <div class="flex flex-between" style="align-items: center; margin-bottom: var(--space-sm);">
                        <div class="flex" style="align-items: center; gap: var(--space-sm);">
                            <div class="rank-badge ${rank <= 3 ? `rank-${rank}` : ''}">${rank}</div>
                            <div>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${waiter.name || 'Неизвестно'}</h3>
                                <p style="font-size: 13px; color: var(--text-secondary);">${waiter.bar || 'Все бары'}</p>
                            </div>
                        </div>
                        <div class="metric-value-sm" style="color: var(--accent);">
                            ${formatNumber(waiter.total_revenue || 0)} ₽
                        </div>
                    </div>
                    <div class="waiter-stats">
                        <div class="waiter-stat">
                            <div class="waiter-stat-label">Заказов</div>
                            <div class="waiter-stat-value">${formatNumber(waiter.orders_count || 0)}</div>
                        </div>
                        <div class="waiter-stat">
                            <div class="waiter-stat-label">Средний чек</div>
                            <div class="waiter-stat-value">${formatNumber(waiter.avg_check || 0)}</div>
                        </div>
                        <div class="waiter-stat">
                            <div class="waiter-stat-label">Маржа</div>
                            <div class="waiter-stat-value">${formatNumber(waiter.total_margin || 0)}</div>
                        </div>
                        <div class="waiter-stat">
                            <div class="waiter-stat-label">Наценка</div>
                            <div class="waiter-stat-value">${formatNumber(waiter.avg_markup || 0, 'decimal')}%</div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function formatNumber(num, format = 'int') {
            if (format === 'decimal') {
                return parseFloat(num).toFixed(1).replace('.', ',');
            }
            return Math.round(num).toLocaleString('ru-RU');
        }

        function hideNoData() {
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-data-container').style.display = 'none';
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Waiters analysis loaded');
        });
    </script>
</body>
</html>
