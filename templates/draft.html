<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Management Platform | Разливное</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/claude-design.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        .keg-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .volume-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            font-family: var(--font-mono);
            background: rgba(225, 123, 76, 0.15);
            color: var(--accent-dark);
        }

        .sorting-controls {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }

        .sort-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .sort-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .sort-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header-title">Разливное пиво</h1>
                <p class="header-subtitle">ABC/XYZ анализ кег и проливов</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="/" class="nav-item">Фасовка</a>
            <a href="/draft" class="nav-item active">Разливное</a>
            <a href="/waiters" class="nav-item">Официанты</a>
            <a href="/taps" class="nav-item">Краны</a>
            <a href="/stocks" class="nav-item">Остатки</a>
        </nav>

        <!-- Controls Card -->
        <div class="card mb-lg">
            <div class="flex flex-gap-md" style="flex-wrap: wrap; align-items: end;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label" for="bar-select">Бар</label>
                    <select class="form-select" id="bar-select">
                        <option value="">Общая (все бары)</option>
                        {% for bar in bars %}
                        <option value="{{ bar }}">{{ bar }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label" for="period-select">Период</label>
                    <select class="form-select" id="period-select">
                        <option value="7">Неделя</option>
                        <option value="14">2 недели</option>
                        <option value="30" selected>Месяц</option>
                        <option value="60">2 месяца</option>
                        <option value="90">Квартал</option>
                        <option value="180">Полгода</option>
                        <option value="365">Год</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="runAnalysis()" style="min-width: 180px;">
                    Запустить анализ
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <div class="loading-spinner" style="margin: 0 auto 24px;"></div>
                <h3 style="margin-bottom: 8px; color: var(--text-primary);">Анализируем разливное...</h3>
                <p style="color: var(--text-secondary);">Получаем данные о продажах кег и вычисляем проливы</p>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="display: none;">
            <!-- Keg Stats Grid -->
            <div class="keg-stats-grid" id="stats-grid">
                <!-- Будут добавлены через JS -->
            </div>

            <!-- Sorting Controls -->
            <div class="flex flex-between" style="align-items: center; margin-bottom: var(--space-md);">
                <h3 style="color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.8px;">
                    Детальная статистика
                </h3>
                <div class="sorting-controls">
                    <button class="sort-btn active" onclick="sortTable('volume')">По объёму</button>
                    <button class="sort-btn" onclick="sortTable('revenue')">По выручке</button>
                    <button class="sort-btn" onclick="sortTable('margin')">По марже</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="table" id="results-table">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th class="align-right">Объём (л)</th>
                            <th class="align-right">Кол-во кег</th>
                            <th class="align-right">Выручка (₽)</th>
                            <th class="align-right">Средняя наценка (%)</th>
                            <th class="align-right">Маржа (₽)</th>
                            <th>ABC-код</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Будут добавлены через JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data State -->
        <div id="no-data-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <h3 style="margin-bottom: 12px; color: var(--text-primary);">Нет данных за выбранный период</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    Попробуйте выбрать другой период или бар
                </p>
                <button class="btn btn-secondary" onclick="hideNoData()">
                    Вернуться к настройкам
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/microinteractions.js"></script>
    <script>
        let currentData = null;

        async function runAnalysis() {
            const bar = document.getElementById('bar-select').value;
            const period = document.getElementById('period-select').value;

            // Скрыть результаты и no-data
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-data-container').style.display = 'none';

            // Показать loading
            document.getElementById('loading-container').style.display = 'block';

            try {
                const requestBody = {
                    bar: bar || '',
                    days: parseInt(period)
                };

                const response = await fetch('/api/draft-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                // Скрыть loading
                document.getElementById('loading-container').style.display = 'none';

                if (data.error) {
                    BeerPlatform.showToast(data.error, 'error');
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                if (!data.items || data.items.length === 0) {
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                // Сохранить данные для сортировки
                currentData = data;

                // Отобразить результаты
                displayResults(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-container').style.display = 'none';
                BeerPlatform.showToast('Ошибка при получении данных', 'error');
                document.getElementById('no-data-container').style.display = 'block';
            }
        }

        function displayResults(data) {
            // Показать контейнер результатов
            document.getElementById('results-container').style.display = 'block';

            // Stats Grid
            displayStats(data);

            // Table
            displayTable(data.items);
        }

        function displayStats(data) {
            const container = document.getElementById('stats-grid');
            container.innerHTML = '';

            const metrics = [
                { label: 'Общий объём', value: data.total_liters || 0, suffix: ' л', format: 'decimal' },
                { label: 'Всего кег', value: data.total_kegs || 0, suffix: ' шт' },
                { label: 'Общая выручка', value: data.total_revenue || 0, suffix: ' ₽' },
                { label: 'Средняя наценка', value: data.avg_markup || 0, suffix: '%', format: 'decimal' },
                { label: 'Общая маржа', value: data.total_margin || 0, suffix: ' ₽' }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value-md">${formatNumber(metric.value, metric.format)}${metric.suffix}</div>
                `;
                container.appendChild(card);
            });
        }

        function displayTable(items) {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name || ''}</td>
                    <td class="align-right">${formatNumber(item.total_liters || 0, 'decimal')}</td>
                    <td class="align-right">${formatNumber(item.kegs_count || 0)}</td>
                    <td class="align-right">${formatNumber(item.total_revenue || 0)}</td>
                    <td class="align-right">${formatNumber(item.avg_markup_percent || 0, 'decimal')}%</td>
                    <td class="align-right">${formatNumber(item.total_margin || 0)}</td>
                    <td><span class="badge badge-neutral">${item.abc_code || 'N/A'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function sortTable(sortBy) {
            if (!currentData || !currentData.items) return;

            // Обновить активную кнопку
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Сортировать данные
            const sorted = [...currentData.items];

            if (sortBy === 'volume') {
                sorted.sort((a, b) => (b.total_liters || 0) - (a.total_liters || 0));
            } else if (sortBy === 'revenue') {
                sorted.sort((a, b) => (b.total_revenue || 0) - (a.total_revenue || 0));
            } else if (sortBy === 'margin') {
                sorted.sort((a, b) => (b.total_margin || 0) - (a.total_margin || 0));
            }

            // Отобразить отсортированную таблицу
            displayTable(sorted);
        }

        function formatNumber(num, format = 'int') {
            if (format === 'decimal') {
                return parseFloat(num).toFixed(1).replace('.', ',');
            }
            return Math.round(num).toLocaleString('ru-RU');
        }

        function hideNoData() {
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-data-container').style.display = 'none';
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Draft beer analysis loaded');
        });
    </script>
</body>
</html>
