<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Management Platform | Краны</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/claude-design.css">

    <style>
        .taps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        @media (max-width: 768px) {
            .taps-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        .tap-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
        }

        .tap-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px var(--shadow-medium);
            border-color: var(--accent);
        }

        .tap-card.active {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(127, 166, 80, 0.05) 0%, var(--bg-card) 100%);
        }

        .tap-card.empty {
            border-color: var(--border);
            opacity: 0.6;
        }

        .tap-number {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .tap-card.active .tap-number {
            background: var(--success);
            color: #FFFFFF;
        }

        .tap-beer-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            padding-right: 40px;
            line-height: 1.3;
            min-height: 40px;
        }

        .tap-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }

        .tap-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .tap-detail-label {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
        }

        .tap-detail-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--text-primary);
            font-feature-settings: 'tnum';
        }

        .tap-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tap-status-active {
            background: rgba(127, 166, 80, 0.15);
            color: var(--success);
        }

        .tap-status-empty {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .bar-section {
            margin-bottom: var(--space-xl);
        }

        .bar-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--border);
        }

        .bar-section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .bar-section-stats {
            display: flex;
            gap: var(--space-md);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .bar-section-stat {
            font-family: var(--font-mono);
        }

        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            padding: var(--space-sm);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header-title">Управление кранами</h1>
                <p class="header-subtitle">60 кранов в 4 барах • Статус в реальном времени</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="/" class="nav-item">Фасовка</a>
            <a href="/draft" class="nav-item">Разливное</a>
            <a href="/waiters" class="nav-item">Официанты</a>
            <a href="/taps" class="nav-item active">Краны</a>
            <a href="/stocks" class="nav-item">Остатки</a>
        </nav>

        <!-- Filters -->
        <div class="filters-bar">
            <button class="filter-btn active" onclick="filterTaps('all')">Все</button>
            <button class="filter-btn" onclick="filterTaps('active')">Активные</button>
            <button class="filter-btn" onclick="filterTaps('empty')">Пустые</button>
            <button class="filter-btn" onclick="filterBar('')">Все бары</button>
            {% for bar in bars %}
            <button class="filter-btn" onclick="filterBar('{{ bar }}')">{{ bar }}</button>
            {% endfor %}
        </div>

        <!-- Loading State -->
        <div id="loading-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <div class="loading-spinner" style="margin: 0 auto 24px;"></div>
                <h3 style="margin-bottom: 8px; color: var(--text-primary);">Загружаем данные кранов...</h3>
                <p style="color: var(--text-secondary);">Получаем актуальную информацию по всем 60 кранам</p>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container">
            <!-- Будут добавлены через JS -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/microinteractions.js"></script>
    <script>
        let allTapsData = null;
        let currentFilter = { type: 'all', bar: null };

        // Load taps data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTapsData();
        });

        async function loadTapsData() {
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('results-container').innerHTML = '';

            try {
                const response = await fetch('/api/taps/all');
                const data = await response.json();

                document.getElementById('loading-container').style.display = 'none';

                if (data.error) {
                    BeerPlatform.showToast(data.error, 'error');
                    return;
                }

                allTapsData = data;
                displayTaps(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-container').style.display = 'none';
                BeerPlatform.showToast('Ошибка при получении данных', 'error');
            }
        }

        function displayTaps(data) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            if (!data.bars) return;

            Object.entries(data.bars).forEach(([barName, barData]) => {
                // Skip if bar filter is active
                if (currentFilter.bar && currentFilter.bar !== barName) {
                    return;
                }

                const section = document.createElement('div');
                section.className = 'bar-section';

                const activeTaps = barData.taps.filter(t => t.beer_name).length;
                const emptyTaps = barData.taps.filter(t => !t.beer_name).length;

                section.innerHTML = `
                    <div class="bar-section-header">
                        <h2 class="bar-section-title">${barName}</h2>
                        <div class="bar-section-stats">
                            <span class="bar-section-stat">Всего: ${barData.taps.length}</span>
                            <span class="bar-section-stat" style="color: var(--success);">Активных: ${activeTaps}</span>
                            <span class="bar-section-stat" style="color: var(--text-tertiary);">Пустых: ${emptyTaps}</span>
                        </div>
                    </div>
                    <div class="taps-grid" id="taps-${barName.replace(/\s/g, '-')}"></div>
                `;

                container.appendChild(section);

                const tapsGrid = section.querySelector('.taps-grid');
                displayBarTaps(tapsGrid, barData.taps);
            });
        }

        function displayBarTaps(container, taps) {
            container.innerHTML = '';

            // Sort by tap number
            const sortedTaps = [...taps].sort((a, b) => a.tap_number - b.tap_number);

            sortedTaps.forEach(tap => {
                // Apply type filter
                if (currentFilter.type === 'active' && !tap.beer_name) return;
                if (currentFilter.type === 'empty' && tap.beer_name) return;

                const card = document.createElement('div');
                card.className = `tap-card ${tap.beer_name ? 'active' : 'empty'}`;

                const beerName = tap.beer_name || 'Пусто';
                const volume = tap.keg_volume ? `${tap.keg_volume}л` : '—';
                const lastChange = tap.last_change ? formatDate(tap.last_change) : '—';

                card.innerHTML = `
                    <div class="tap-number">${tap.tap_number}</div>
                    <div class="tap-beer-name">${beerName}</div>
                    <span class="tap-status-badge ${tap.beer_name ? 'tap-status-active' : 'tap-status-empty'}">
                        ${tap.beer_name ? 'Активен' : 'Пусто'}
                    </span>
                    ${tap.beer_name ? `
                        <div class="tap-details">
                            <div class="tap-detail-item">
                                <span class="tap-detail-label">Объём кеги</span>
                                <span class="tap-detail-value">${volume}</span>
                            </div>
                            <div class="tap-detail-item">
                                <span class="tap-detail-label">Замена</span>
                                <span class="tap-detail-value">${lastChange}</span>
                            </div>
                        </div>
                    ` : ''}
                `;

                // Click handler for editing
                card.addEventListener('click', () => {
                    showTapDetails(tap);
                });

                container.appendChild(card);
            });
        }

        function filterTaps(type) {
            currentFilter.type = type;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent === 'Все' && type === 'all') {
                    btn.classList.add('active');
                } else if (btn.textContent === 'Активные' && type === 'active') {
                    btn.classList.add('active');
                } else if (btn.textContent === 'Пустые' && type === 'empty') {
                    btn.classList.add('active');
                } else if (!btn.textContent.includes('Все') && !btn.textContent.includes('Активные') && !btn.textContent.includes('Пустые')) {
                    // Keep bar filter buttons as they are
                } else {
                    btn.classList.remove('active');
                }
            });

            displayTaps(allTapsData);
        }

        function filterBar(barName) {
            currentFilter.bar = barName || null;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if ((btn.textContent === 'Все бары' && !barName) || btn.textContent === barName) {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Все') || btn.textContent.includes('Активные') || btn.textContent.includes('Пустые')) {
                    // Keep status filter buttons as they are
                } else {
                    btn.classList.remove('active');
                }
            });

            displayTaps(allTapsData);
        }

        function showTapDetails(tap) {
            console.log('Tap details:', tap);
            // TODO: Implement tap editing modal
            BeerPlatform.showToast(`Кран ${tap.tap_number}: ${tap.beer_name || 'Пусто'}`, 'success');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Сегодня';
            if (diffDays === 1) return 'Вчера';
            if (diffDays < 7) return `${diffDays}д назад`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}н назад`;
            return date.toLocaleDateString('ru-RU');
        }
    </script>
</body>
</html>
