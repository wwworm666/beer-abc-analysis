<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Management Platform | Фасовка</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/claude-design.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Специфичные стили для index */
        .analysis-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: var(--space-sm);
            align-items: end;
            margin-bottom: var(--space-lg);
        }

        @media (max-width: 768px) {
            .analysis-controls {
                grid-template-columns: 1fr;
            }
        }

        .mode-selector {
            display: flex;
            gap: var(--space-xs);
            padding: 6px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-lg);
            width: fit-content;
        }

        .mode-btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .mode-btn:hover {
            background: var(--bg-secondary);
        }

        .mode-btn.active {
            background: var(--accent);
            color: #FFFFFF;
            box-shadow: 0 2px 4px var(--shadow-medium);
        }

        .abc-matrix-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .abc-matrix-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .abc-matrix-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .abc-matrix-card.category-aaa {
            background: linear-gradient(135deg, var(--success) 0%, #6B8F46 100%);
            border-color: var(--success);
            color: #FFFFFF;
        }

        .abc-matrix-card.category-ccc {
            background: linear-gradient(135deg, var(--error) 0%, #A64848 100%);
            border-color: var(--error);
            color: #FFFFFF;
        }

        .abc-matrix-card .category-label {
            font-family: var(--font-mono);
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .abc-matrix-card .category-count {
            font-family: var(--font-mono);
            font-size: 36px;
            font-weight: 700;
            font-feature-settings: 'tnum';
        }

        .date-range-display {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .custom-period-controls {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .custom-period-controls.active {
            display: grid;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header-title">Фасованное пиво</h1>
                <p class="header-subtitle">ABC/XYZ анализ бутылочного пива</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="/" class="nav-item active">Фасовка</a>
            <a href="/draft" class="nav-item">Разливное</a>
            <a href="/waiters" class="nav-item">Официанты</a>
            <a href="/taps" class="nav-item">Краны</a>
            <a href="/stocks" class="nav-item">Остатки</a>
        </nav>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-beers" onclick="setAnalysisMode('beers')">
                По бутылкам
            </button>
            <button class="mode-btn" id="mode-categories" onclick="setAnalysisMode('categories')">
                По категориям
            </button>
        </div>

        <!-- Controls Card -->
        <div class="card mb-lg">
            <div class="analysis-controls">
                <div class="form-group">
                    <label class="form-label" for="bar-select">Бар</label>
                    <select class="form-select" id="bar-select">
                        <option value="">Общая (все бары)</option>
                        {% for bar in bars %}
                        <option value="{{ bar }}">{{ bar }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="period-select">Период</label>
                    <select class="form-select" id="period-select" onchange="toggleCustomPeriod()">
                        <option value="7">Неделя</option>
                        <option value="14">2 недели</option>
                        <option value="30" selected>Месяц</option>
                        <option value="60">2 месяца</option>
                        <option value="90">Квартал</option>
                        <option value="180">Полгода</option>
                        <option value="365">Год</option>
                        <option value="custom">Свой период</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-full" onclick="runAnalysis()">
                        Запустить анализ
                    </button>
                </div>
            </div>

            <!-- Custom Period Controls -->
            <div class="custom-period-controls" id="custom-period-controls">
                <div class="form-group">
                    <label class="form-label" for="date-from">Дата начала</label>
                    <input class="form-input" type="date" id="date-from">
                </div>
                <div class="form-group">
                    <label class="form-label" for="date-to">Дата окончания</label>
                    <input class="form-input" type="date" id="date-to">
                </div>
            </div>

            <!-- Date Range Display -->
            <div class="date-range-display" id="date-range-display">
                Выберите период и нажмите "Запустить анализ"
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <div class="loading-spinner" style="margin: 0 auto 24px;"></div>
                <h3 style="margin-bottom: 8px; color: var(--text-primary);">Анализируем данные...</h3>
                <p style="color: var(--text-secondary);">Получаем данные из iiko и вычисляем ABC/XYZ коды</p>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="display: none;">
            <!-- Stats Grid -->
            <div class="cards-grid" id="stats-grid">
                <!-- Будут добавлены через JS -->
            </div>

            <!-- ABC Matrix -->
            <h3 class="mb-md" style="color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.8px;">
                ABC Матрица
            </h3>
            <div class="abc-matrix-grid" id="abc-matrix">
                <!-- Будут добавлены через JS -->
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="table" id="results-table">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th class="align-right">Выручка (₽)</th>
                            <th class="align-right">Средняя наценка (%)</th>
                            <th class="align-right">Маржа (₽)</th>
                            <th class="align-right">Количество</th>
                            <th>ABC-код</th>
                            <th>XYZ-код</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Будут добавлены через JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data State -->
        <div id="no-data-container" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <h3 style="margin-bottom: 12px; color: var(--text-primary);">Нет данных за выбранный период</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    Попробуйте выбрать другой период или бар
                </p>
                <button class="btn btn-secondary" onclick="document.getElementById('results-container').style.display = 'none'; document.getElementById('no-data-container').style.display = 'none';">
                    Вернуться к настройкам
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/microinteractions.js"></script>
    <script>
        let currentMode = 'beers';

        function setAnalysisMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mode-${mode}`).classList.add('active');
        }

        function toggleCustomPeriod() {
            const periodSelect = document.getElementById('period-select');
            const customControls = document.getElementById('custom-period-controls');

            if (periodSelect.value === 'custom') {
                customControls.classList.add('active');
            } else {
                customControls.classList.remove('active');
            }
        }

        async function runAnalysis() {
            const bar = document.getElementById('bar-select').value;
            const period = document.getElementById('period-select').value;

            // Скрыть результаты и no-data
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-data-container').style.display = 'none';

            // Показать loading
            document.getElementById('loading-container').style.display = 'block';

            try {
                let dateFrom, dateTo;

                if (period === 'custom') {
                    dateFrom = document.getElementById('date-from').value;
                    dateTo = document.getElementById('date-to').value;

                    if (!dateFrom || !dateTo) {
                        BeerPlatform.showToast('Пожалуйста, укажите обе даты', 'warning');
                        document.getElementById('loading-container').style.display = 'none';
                        return;
                    }
                }

                const params = new URLSearchParams({
                    bar: bar || '',
                    days: period !== 'custom' ? period : '',
                    mode: currentMode
                });

                if (period === 'custom') {
                    params.set('date_from', dateFrom);
                    params.set('date_to', dateTo);
                }

                const response = await fetch(`/api/analyze?${params}`);
                const data = await response.json();

                // Скрыть loading
                document.getElementById('loading-container').style.display = 'none';

                if (data.error) {
                    BeerPlatform.showToast(data.error, 'error');
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                if (!data.items || data.items.length === 0) {
                    document.getElementById('no-data-container').style.display = 'block';
                    return;
                }

                // Отобразить результаты
                displayResults(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-container').style.display = 'none';
                BeerPlatform.showToast('Ошибка при получении данных', 'error');
                document.getElementById('no-data-container').style.display = 'block';
            }
        }

        function displayResults(data) {
            // Показать контейнер результатов
            document.getElementById('results-container').style.display = 'block';

            // Stats Grid
            displayStats(data.stats);

            // ABC Matrix
            displayAbcMatrix(data.abc_matrix);

            // Table
            displayTable(data.items);
        }

        function displayStats(stats) {
            const container = document.getElementById('stats-grid');
            container.innerHTML = '';

            const metrics = [
                { label: 'Общая выручка', value: stats.total_revenue || 0, suffix: ' ₽' },
                { label: 'Средняя наценка', value: stats.avg_markup || 0, suffix: '%' },
                { label: 'Общая маржа', value: stats.total_margin || 0, suffix: ' ₽' },
                { label: 'Количество позиций', value: stats.total_items || 0, suffix: '' }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${formatNumber(metric.value)}${metric.suffix}</div>
                `;
                container.appendChild(card);
            });
        }

        function displayAbcMatrix(matrix) {
            const container = document.getElementById('abc-matrix');
            container.innerHTML = '';

            if (!matrix) return;

            Object.entries(matrix).forEach(([category, count]) => {
                const card = document.createElement('div');
                card.className = `abc-matrix-card ${category === 'AAA' ? 'category-aaa' : category === 'CCC' ? 'category-ccc' : ''}`;
                card.innerHTML = `
                    <div class="category-label">${category}</div>
                    <div class="category-count">${count}</div>
                `;
                container.appendChild(card);
            });
        }

        function displayTable(items) {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name || item.category || ''}</td>
                    <td class="align-right">${formatNumber(item.total_revenue || 0)}</td>
                    <td class="align-right">${formatNumber(item.avg_markup_percent || 0)}%</td>
                    <td class="align-right">${formatNumber(item.total_margin || 0)}</td>
                    <td class="align-right">${formatNumber(item.quantity || 0)}</td>
                    <td><span class="badge badge-neutral">${item.abc_code || 'N/A'}</span></td>
                    <td><span class="badge badge-neutral">${item.xyz_code || 'N/A'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ru-RU');
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Beer Management Platform loaded');
        });
    </script>
</body>
</html>
