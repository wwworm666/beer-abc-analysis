<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Management Platform | –§–∞—Å–æ–≤–∫–∞</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/claude-design.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Results & Tables Styles */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .bar-section {
            margin-bottom: var(--space-lg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-md);
            font-size: 14px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        thead {
            background: var(--bg-secondary);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            font-family: var(--font-mono);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        tbody tr {
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        .abc-code {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-family: var(--font-mono);
            font-size: 13px;
        }

        .abc-A { background: #7FA650; color: white; }
        .abc-B { background: #F5A97D; color: white; }
        .abc-C { background: #C4C4C4; color: white; }

        .xyz-X { background: #059669; color: white; }
        .xyz-Y { background: #d97706; color: white; }
        .xyz-Z { background: #dc2626; color: white; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 24px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-lg);
        }

        /* Toggle buttons for mode */
        .btn.btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn.btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .btn.btn-secondary.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Date range display */
        .date-range-display {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .date-range-display .dates {
            font-weight: 500;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <h1 class="header-title">ABC/XYZ –§–∞—Å–æ–≤–∫–∞</h1>
                <p class="header-subtitle">–ê–Ω–∞–ª–∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ —Ñ–∞—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∏–≤–∞</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="/" class="nav-item active">–§–∞—Å–æ–≤–∫–∞</a>
            <a href="/draft" class="nav-item">–†–∞–∑–ª–∏–≤–Ω–æ–µ</a>
            <a href="/waiters" class="nav-item">–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã</a>
            <a href="/taps" class="nav-item">–ö—Ä–∞–Ω—ã</a>
            <a href="/stocks" class="nav-item">–û—Å—Ç–∞—Ç–∫–∏</a>
        </nav>

        <!-- Controls Card -->
        <div class="card mb-md">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="form-group mb-md">
                <label class="form-label">–†–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞</label>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary active" id="mode-beers" onclick="setAnalysisMode('beers')">–ü–æ –±—É—Ç—ã–ª–∫–∞–º</button>
                    <button class="btn btn-secondary" id="mode-categories" onclick="setAnalysisMode('categories')">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label" for="bar-select">–ë–∞—Ä</label>
                    <select class="form-select" id="bar-select">
                        <option value="">–û–±—â–∞—è</option>
                        {% for bar in bars %}
                        <option value="{{ bar }}">{{ bar }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="period-select">–ü–µ—Ä–∏–æ–¥</label>
                    <select class="form-select" id="period-select" onchange="toggleCustomPeriod(); updateDateRangeDisplay();">
                        <option value="7">–ù–µ–¥–µ–ª—è</option>
                        <option value="14">2 –Ω–µ–¥–µ–ª–∏</option>
                        <option value="30" selected>–ú–µ—Å—è—Ü</option>
                        <option value="60">2 –º–µ—Å—è—Ü–∞</option>
                        <option value="90">–ö–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="180">–ü–æ–ª–≥–æ–¥–∞</option>
                        <option value="365">–ì–æ–¥</option>
                        <option value="custom">–°–≤–æ–π –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>

                <div class="form-group" style="align-self: end;">
                    <button class="btn btn-primary" onclick="runAnalysis()" style="width: 100%;">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                </div>
            </div>

            <div id="custom-period-controls" style="display: none; margin-bottom: 16px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="date-from">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                        <input class="form-input" type="date" id="date-from" onchange="updateDateRangeDisplay()">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="date-to">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input class="form-input" type="date" id="date-to" onchange="updateDateRangeDisplay()">
                    </div>
                </div>
            </div>

            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç -->
            <div id="date-range-display" style="display: none; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞: <span style="font-weight: 500; color: var(--text-primary);" id="date-range-text"></span>
            </div>
        </div>

        <div id="error-message" style="display: none; padding: 16px; background: #fee; border: 1px solid #fcc; border-radius: var(--radius-sm); margin-bottom: 16px; color: #c33;"></div>

        <!-- Loading State -->
        <div id="loading" style="display: none;">
            <div class="card text-center" style="padding: 60px;">
                <div class="loading-spinner" style="margin: 0 auto 24px;"></div>
                <h3 style="margin-bottom: 8px; color: var(--text-primary);">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</h3>
                <p style="color: var(--text-secondary);">–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ iiko –∏ –≤—ã—á–∏—Å–ª—è–µ–º ABC/XYZ –∫–æ–¥—ã</p>
            </div>
        </div>

        <div class="results" id="results"></div>
    </div>

    <!-- Microinteractions -->
    <script src="/static/js/microinteractions.js"></script>

    <script>
        let currentData = {};
        let activeCharts = {};
        let analysisMode = 'beers'; // 'beers' –∏–ª–∏ 'categories'

        // API Connection Status Check
        async function checkApiConnection() {
            const statusElement = document.getElementById('api-status');
            const textElement = statusElement.querySelector('.api-status-text');

            statusElement.className = 'api-status checking';
            textElement.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';

            try {
                const response = await fetch('/api/connection-status');
                const data = await response.json();

                if (response.ok && data.status === 'connected') {
                    statusElement.className = 'api-status connected';
                    textElement.textContent = 'iiko API –ø–æ–¥–∫–ª—é—á–µ–Ω';
                } else {
                    statusElement.className = 'api-status error';
                    textElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                    console.error('API connection error:', data.message);
                }
            } catch (error) {
                statusElement.className = 'api-status error';
                textElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                console.error('API connection error:', error);
            }
        }

        // Check connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkApiConnection();
            // Recheck connection every 60 seconds
            setInterval(checkApiConnection, 60000);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateDateRangeDisplay();
        });

        // Analysis mode management
        function setAnalysisMode(mode) {
            analysisMode = mode;

            document.querySelectorAll('#mode-beers, #mode-categories').forEach(btn => {
                btn.classList.remove('active');
            });

            if (mode === 'beers') {
                document.getElementById('mode-beers').classList.add('active');
            } else {
                document.getElementById('mode-categories').classList.add('active');
            }
        }

        // Theme management
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelectorAll('.theme-btn').forEach(btn => {
            if ((savedTheme === 'light' && btn.textContent === '–°–≤–µ—Ç–ª–∞—è') ||
                (savedTheme === 'dark' && btn.textContent === '–¢—ë–º–Ω–∞—è')) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        function toggleCustomPeriod() {
            const periodSelect = document.getElementById('period-select').value;
            const customControls = document.getElementById('custom-period-controls');

            if (periodSelect === 'custom') {
                customControls.style.display = 'grid';
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const today = new Date();
                const monthAgo = new Date(today);
                monthAgo.setDate(today.getDate() - 30);

                document.getElementById('date-to').valueAsDate = today;
                document.getElementById('date-from').valueAsDate = monthAgo;
            } else {
                customControls.style.display = 'none';
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
            updateDateRangeDisplay();
        }

        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function updateDateRangeDisplay() {
            const periodSelect = document.getElementById('period-select').value;
            const dateRangeDisplay = document.getElementById('date-range-display');
            const dateRangeText = document.getElementById('date-range-text');

            let startDate, endDate;
            const today = new Date();

            if (periodSelect === 'custom') {
                const dateFromInput = document.getElementById('date-from').value;
                const dateToInput = document.getElementById('date-to').value;

                if (dateFromInput && dateToInput) {
                    startDate = new Date(dateFromInput);
                    endDate = new Date(dateToInput);
                } else {
                    dateRangeDisplay.style.display = 'none';
                    return;
                }
            } else {
                const days = parseInt(periodSelect);
                endDate = new Date(today);
                startDate = new Date(today);
                startDate.setDate(today.getDate() - days);
            }

            dateRangeText.textContent = `${formatDate(startDate)} ‚Äî ${formatDate(endDate)}`;
            dateRangeDisplay.style.display = 'block';
        }

        async function runAnalysis() {
            const bar = document.getElementById('bar-select').value;
            const periodSelect = document.getElementById('period-select').value;

            let days;
            let dateFrom, dateTo;

            if (periodSelect === 'custom') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
                const dateFromInput = document.getElementById('date-from').value;
                const dateToInput = document.getElementById('date-to').value;

                if (!dateFromInput || !dateToInput) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
                    return;
                }

                dateFrom = dateFromInput;
                dateTo = dateToInput;

                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è API
                const from = new Date(dateFromInput);
                const to = new Date(dateToInput);
                days = Math.ceil((to - from) / (1000 * 60 * 60 * 24));
            } else {
                days = periodSelect;
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error-message').classList.remove('active');

            try {
                // –í—ã–±–∏—Ä–∞–µ–º endpoint –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                const endpoint = analysisMode === 'categories' ? '/api/categories' : '/api/analyze';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bar, days })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                const data = await response.json();
                currentData = data;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (analysisMode === 'categories') {
                    displayCategoryResults(data);
                } else {
                    displayResults(data);
                }

            } catch (error) {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            for (const [barName, barData] of Object.entries(data)) {
                const section = createBarSection(barName, barData);
                resultsDiv.appendChild(section);
            }

            resultsDiv.classList.add('active');
        }

        function createBarSection(barName, data) {
            const section = document.createElement('div');
            section.className = 'bar-section';
            
            const card = document.createElement('div');
            card.className = 'card';

            const header = `
                <div class="bar-header">
                    <h2>${barName}</h2>
                </div>
            `;

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card" onclick="showAllBeersList('${barName}', 'revenue')" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞">
                        <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                        <div class="value">${formatMoney(data.total_revenue)}</div>
                    </div>
                    <div class="stat-card" onclick="showAllBeersList('${barName}', 'quantity')" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞">
                        <div class="label">–ë—É—Ç—ã–ª–æ–∫</div>
                        <div class="value">${formatNumber(data.total_qty)}</div>
                    </div>
                    <div class="stat-card" onclick="showAllBeersList('${barName}', 'sku')" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞">
                        <div class="label">SKU</div>
                        <div class="value">${data.total_beers}</div>
                    </div>
                </div>
            `;

           const abcCards = Object.entries(data.abc_stats || data.stats || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12)
                .map(([category, count]) => `
                    <div class="abc-card ${category.toLowerCase()}" onclick="showCategoryDetails('${barName}', '${category}')">
                        ${wrapWithTooltip(`<div class="category">${category}</div>`, category)}
                        <div class="count">${count}</div>
                    </div>
                `).join('');

            const matrix = `
                <h3 class="section-title">ABC –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <div class="abc-matrix">
                    ${abcCards}
                </div>
            `;

            let xyzSection = '';
            if (data.xyz_stats && Object.keys(data.xyz_stats).length > 0) {
             const xyzCards = Object.entries(data.xyz_stats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([category, count]) => {
                        let bgClass = '';
                        if (category === 'X') bgClass = 'aaa';
                        else if (category === 'Y') bgClass = 'bbb';
                        else if (category === 'Z') bgClass = 'ccc';
                        
                        return `
                            <div class="abc-card ${bgClass}" onclick="showXYZDetails('${barName}', '${category}')">
                                ${wrapWithTooltip(`<div class="category">${category}</div>`, category)}
                                <div class="count">${count}</div>
                            </div>
                        `;
                    }).join('');

                xyzSection = `
                    <h3 class="section-title">XYZ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)</h3>
                    <div class="abc-matrix">
                        ${xyzCards}
                    </div>
                `;
            }

           // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ Bar –≤ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è —Ä–µ–∂–∏–º–∞ "–í—Å–µ –±–∞—Ä—ã")
            const hasBarColumn = data.top_beers && data.top_beers[0] && data.top_beers[0].Bar;

           const topTable = `
                <h3 class="section-title">–¢–æ–ø-10 –ø–æ –≤—ã—Ä—É—á–∫–µ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            ${hasBarColumn ? '<th>–ë–∞—Ä</th>' : ''}
                            <th>–ü–∏–≤–æ</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>ABC</th>
                            ${data.top_beers && data.top_beers[0] && data.top_beers[0].XYZ_Category ? '<th>XYZ</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${(data.top_beers || []).map((beer, i) => `
                            <tr class="beer-row">
                                <td>${i + 1}</td>
                                ${hasBarColumn ? `<td>${beer.Bar}</td>` : ''}
                                <td>${beer.Beer}</td>
                                <td>${formatMoney(beer.TotalRevenue)}</td>
                                <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                ${beer.XYZ_Category ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            card.innerHTML = header + stats + matrix + xyzSection + topTable;
            section.appendChild(card);
            return section;
        }

        function getXYZBadgeClass(xyz) {
            if (xyz === 'X') return 'aaa';
            if (xyz === 'Y') return 'bbb';
            return 'ccc';
        }

        function showCategoryDetails(barName, category) {
            const barData = currentData[barName];
            if (!barData) return;

            const beers = barData.records.filter(record => record.ABC_Combined === category);
            const hasXYZ = beers.length > 0 && beers[0].XYZ_Category;
            const hasBarColumn = beers.length > 0 && beers[0].Bar;

            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${category} ‚Äî ${barName}</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">–í—Å–µ–≥–æ: ${beers.length} —Ñ–∞—Å–æ–≤–æ–∫</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    ${hasBarColumn ? '<th>–ë–∞—Ä</th>' : ''}
                                    <th>–ü–∏–≤–æ</th>
                                    <th>–°—Ç–∏–ª—å</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–ù–∞—Ü–µ–Ω–∫–∞ %</th>
                                    ${hasXYZ ? '<th>XYZ</th>' : ''}
                                    ${hasXYZ ? '<th>–í–∞—Ä–∏–∞—Ü–∏—è</th>' : ''}
                                    <th>–ì—Ä–∞—Ñ–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => {
                                        const safeId = `cat-${category}-${i}`;
                                        const beerBar = beer.Bar || barName;
                                        return `
                                        <tr class="beer-row" id="beer-row-${safeId}">
                                            <td>${i + 1}</td>
                                            ${hasBarColumn ? `<td>${beer.Bar}</td>` : ''}
                                            <td>${beer.Beer}</td>
                                            <td>${beer.Style || '‚Äî'}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>${(beer.AvgMarkupPercent * 100).toFixed(1)}%</td>
                                            ${hasXYZ ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                                            ${hasXYZ ? `<td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>` : ''}
                                            <td>
                                                <span class="chart-icon" onclick='showWeeklyChart(event, "${beerBar}", ${JSON.stringify(beer.Beer)}, "${safeId}")'>
                                                    üìä
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="chart-row-${safeId}" style="display: none;">
                                            <td colspan="${hasBarColumn ? (hasXYZ ? 10 : 8) : (hasXYZ ? 9 : 7)}">
                                                <div class="chart-container">
                                                    <canvas id="chart-${safeId}"></canvas>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function showXYZDetails(barName, xyzCategory) {
            const barData = currentData[barName];
            if (!barData) return;

            const beers = barData.records.filter(record => record.XYZ_Category === xyzCategory);
            const hasBarColumn = beers.length > 0 && beers[0].Bar;

            let categoryName = xyzCategory;
            let categoryDesc = '';
            if (xyzCategory === 'X') {
                categoryName = 'X ‚Äî –°—Ç–∞–±–∏–ª—å–Ω—ã–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è < 10%';
            } else if (xyzCategory === 'Y') {
                categoryName = 'Y ‚Äî –°—Ä–µ–¥–Ω–∏–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è 10-25%';
            } else if (xyzCategory === 'Z') {
                categoryName = 'Z ‚Äî –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è > 25%';
            }

            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2>${categoryName} ‚Äî ${barName}</h2>
                                <p style="color: var(--text-secondary); margin-top: 4px; font-size: 0.9rem;">${categoryDesc}</p>
                            </div>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">–í—Å–µ–≥–æ: ${beers.length} —Ñ–∞—Å–æ–≤–æ–∫</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    ${hasBarColumn ? '<th>–ë–∞—Ä</th>' : ''}
                                    <th>–ü–∏–≤–æ</th>
                                    <th>ABC</th>
                                    <th>–í–∞—Ä–∏–∞—Ü–∏—è</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–ì—Ä–∞—Ñ–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => {
                                        const safeId = `xyz-${xyzCategory}-${i}`;
                                        const beerBar = beer.Bar || barName;
                                        return `
                                        <tr class="beer-row" id="beer-row-${safeId}">
                                            <td>${i + 1}</td>
                                            ${hasBarColumn ? `<td>${beer.Bar}</td>` : ''}
                                            <td>${beer.Beer}</td>
                                         <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                            <td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>
                                                <span class="chart-icon" onclick='showWeeklyChart(event, "${beerBar}", ${JSON.stringify(beer.Beer)}, "${safeId}")'>
                                                    üìä
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="chart-row-${safeId}" style="display: none;">
                                            <td colspan="${hasBarColumn ? 8 : 7}">
                                                <div class="chart-container">
                                                    <canvas id="chart-${safeId}"></canvas>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function showWeeklyChart(event, barName, beerName, rowId) {
            event.stopPropagation();
            
            const chartRow = document.getElementById(`chart-row-${rowId}`);
            
            if (chartRow && chartRow.style.display !== 'none') {
                chartRow.style.display = 'none';
                if (activeCharts[rowId]) {
                    activeCharts[rowId].destroy();
                    delete activeCharts[rowId];
                }
                return;
            }
            
            if (chartRow) {
                chartRow.style.display = 'table-row';
            }
            
            try {
                const response = await fetch(`/api/weekly-chart/${encodeURIComponent(barName)}/${encodeURIComponent(beerName)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
                
                const data = await response.json();
                
                const canvas = document.getElementById(`chart-${rowId}`);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                if (activeCharts[rowId]) {
                    activeCharts[rowId].destroy();
                }

                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                
                activeCharts[rowId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.weeks,
                        datasets: [{
                            label: '–ü—Ä–æ–¥–∞–∂–∏ (—à—Ç)',
                            data: data.sales,
                            borderColor: isDark ? '#3b82f6' : '#0066cc',
                            backgroundColor: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(0, 102, 204, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: isDark ? '#3b82f6' : '#0066cc',
                            pointBorderColor: isDark ? '#1a1a1a' : '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: beerName,
                                color: isDark ? '#e0e0e0' : '#1a1a1a',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#2a2a2a' : '#ffffff',
                                titleColor: isDark ? '#e0e0e0' : '#1a1a1a',
                                bodyColor: isDark ? '#e0e0e0' : '#1a1a1a',
                                borderColor: isDark ? '#333333' : '#e0e0e0',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} —à—Ç`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: isDark ? '#666666' : '#999999'
                                },
                                grid: {
                                    color: isDark ? '#2a2a2a' : '#f5f5f5'
                                },
                                border: {
                                    display: false
                                }
                            },
                            x: {
                                ticks: {
                                    color: isDark ? '#666666' : '#999999'
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                canvas.style.height = '300px';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + error.message);
                if (chartRow) {
                    chartRow.style.display = 'none';
                }
            }
        }

        function displayCategoryResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const bar = document.getElementById('bar-select').value;

            if (bar) {
                // –î–ª—è –æ–¥–Ω–æ–≥–æ –±–∞—Ä–∞
                const section = createCategorySectionForBar(bar, data);
                resultsDiv.appendChild(section);
            } else {
                // –î–ª—è –≤—Å–µ—Ö –±–∞—Ä–æ–≤
                for (const [barName, categoryData] of Object.entries(data.categories || {})) {
                    const section = createCategorySectionForBar(barName, { categories: categoryData, summary: data.summary });
                    resultsDiv.appendChild(section);
                }
            }

            resultsDiv.classList.add('active');
        }

        function createCategorySectionForBar(barName, data) {
            const section = document.createElement('div');
            section.className = 'bar-section';

            const card = document.createElement('div');
            card.className = 'card';

            const header = `
                <div class="bar-header">
                    <h2>üìä ${barName} ‚Äî –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                </div>
            `;

            // –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            let summaryTable = '';
            if (data.summary && data.summary.length > 0) {
                const barSummary = data.summary.filter(s => !barName || s.Category);

                summaryTable = `
                    <h3 class="section-title">–°–≤–æ–¥–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–§–∞—Å–æ–≤–æ–∫</th>
                                <th>–í—ã—Ä—É—á–∫–∞</th>
                                <th>% –æ—Ç –≤—ã—Ä—É—á–∫–∏</th>
                                <th>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π %</th>
                                <th>ABC</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${barSummary.map(cat => `
                                <tr class="beer-row" onclick="showCategoryDetail('${barName}', '${cat.Category}')">
                                    <td><strong>${cat.Category}</strong></td>
                                    <td>${cat.BeersCount}</td>
                                    <td>${formatMoney(cat.TotalRevenue)}</td>
                                    <td>${cat.RevenuePercent.toFixed(1)}%</td>
                                    <td>${cat.CumulativePercent.toFixed(1)}%</td>
                                    <td><span class="badge ${cat.ABC_Category.toLowerCase()}">${cat.ABC_Category}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // –î–µ—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            let categoryCards = '';
            const categories = data.categories || {};

            if (Object.keys(categories).length > 0) {
                const sortedCategories = Object.entries(categories)
                    .sort((a, b) => b[1].total_revenue - a[1].total_revenue)
                    .slice(0, 10); // –¢–æ–ø-10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π

                categoryCards = `
                    <h3 class="section-title">–¢–æ–ø-10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –≤—ã—Ä—É—á–∫–µ</h3>
                    <div class="abc-matrix">
                        ${sortedCategories.map(([catName, catData]) => {
                            const topABC = Object.entries(catData.abc_stats || {})
                                .sort((a, b) => b[1] - a[1])[0];
                            const dominantABC = topABC ? topABC[0] : 'BBB';

                            return `
                                <div class="abc-card" onclick="showCategoryDetail('${barName}', '${catName}')" style="cursor: pointer;">
                                    <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; min-height: 40px;">
                                        ${catName.length > 25 ? catName.substring(0, 25) + '...' : catName}
                                    </div>
                                    <div class="category">
                                        <span class="badge ${dominantABC.toLowerCase()}">${dominantABC}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                                        ${formatMoney(catData.total_revenue)}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                        ${catData.total_beers} —Ñ–∞—Å–æ–≤–æ–∫
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            card.innerHTML = header + summaryTable + categoryCards;
            section.appendChild(card);
            return section;
        }

        function showCategoryDetail(barName, categoryName) {
            const categories = currentData.categories || {};
            const catData = categories[categoryName] || (categories[barName] && categories[barName][categoryName]);

            if (!catData) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                return;
            }

            const beers = catData.beers || [];
            const hasXYZ = beers.length > 0 && beers[0].XYZ_Category;

            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2>${categoryName} ‚Äî ${barName}</h2>
                                <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                                    ${catData.total_beers} —Ñ–∞—Å–æ–≤–æ–∫ ‚Ä¢ –í—ã—Ä—É—á–∫–∞: ${formatMoney(catData.total_revenue)}
                                </p>
                            </div>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>

                        <!-- ABC —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <h3 class="section-title">ABC —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                        <div class="abc-matrix" style="margin-bottom: 30px;">
                            ${Object.entries(catData.abc_stats || {})
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 8)
                                .map(([abc, count]) => `
                                    <div class="abc-card ${abc.toLowerCase()}">
                                        <div class="category">${abc}</div>
                                        <div class="count">${count}</div>
                                    </div>
                                `).join('')}
                        </div>

                        ${hasXYZ ? `
                            <h3 class="section-title">XYZ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                            <div class="abc-matrix" style="margin-bottom: 30px;">
                                ${Object.entries(catData.xyz_stats || {})
                                    .map(([xyz, count]) => {
                                        let bgClass = xyz === 'X' ? 'aaa' : (xyz === 'Y' ? 'bbb' : 'ccc');
                                        return `
                                            <div class="abc-card ${bgClass}">
                                                <div class="category">${xyz}</div>
                                                <div class="count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        ` : ''}

                        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –ø–∏–≤–æ–º -->
                        <h3 class="section-title">–í—Å–µ —Ñ–∞—Å–æ–≤–∫–∏</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ü–∏–≤–æ</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>ABC</th>
                                    ${hasXYZ ? '<th>XYZ</th>' : ''}
                                    ${hasXYZ ? '<th>–í–∞—Ä–∏–∞—Ü–∏—è</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => `
                                        <tr class="beer-row">
                                            <td>${i + 1}</td>
                                            <td>${beer.Beer}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                            ${hasXYZ ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                                            ${hasXYZ ? `<td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>` : ''}
                                        </tr>
                                    `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeModalBackdrop(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('category-modal');
            if (modal) {
                modal.remove();
            }
            for (let key in activeCharts) {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                }
            }
            activeCharts = {};
        }

        function formatMoney(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('ru-RU').format(value);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // –û–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è tooltips
        const categoryDescriptions = {
            // ABC –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            'AAA': { emoji: 'üåü', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ó–≤–µ–∑–¥—ã –º–µ–Ω—é! Must have.' },
            'AAB': { emoji: '‚≠ê', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ.' },
            'AAC': { emoji: '‚ö†Ô∏è', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.' },
            
            'ABA': { emoji: 'üí∞', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞ —Å—á—ë—Ç –æ–±—ä—ë–º–∞.' },
            'ABB': { emoji: '‚úÖ', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°—Ç–∞–±–∏–ª—å–Ω–æ —Ö–æ—Ä–æ—à–æ.' },
            'ABC': { emoji: 'üìä', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω—É.' },
            
            'ACA': { emoji: 'üî•', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ù–∞—Ä–æ–¥–Ω–æ–µ –ø–∏–≤–æ!' },
            'ACB': { emoji: 'üí°', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É.' },
            'ACC': { emoji: '‚ö†Ô∏è', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É!' },
            
            'BAA': { emoji: 'üíé', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–µ–º–∏—É–º —Å–µ–≥–º–µ–Ω—Ç.' },
            'BAB': { emoji: '‚úÖ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å.' },
            'BAC': { emoji: 'ü§î', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã.' },
            
            'BBA': { emoji: 'üìà', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–°—Ç–æ–∏—Ç –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å.' },
            'BBB': { emoji: '‚ûñ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°–µ—Ä–µ–¥–Ω—è—á–æ–∫.' },
            'BBC': { emoji: 'üìâ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å.' },
            
            'BCA': { emoji: 'üéØ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É.' },
            'BCB': { emoji: 'üí≠', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°–ª–∞–±–æ–≤–∞—Ç–æ.' },
            'BCC': { emoji: '‚ùå', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –∑–∞–º–µ–Ω—É.' },
            
            'CAA': { emoji: 'üç∑', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: 'Craft/Premium –¥–ª—è –∏–º–∏–¥–∂–∞.' },
            'CAB': { emoji: 'üé®', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ù–∏—à–µ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç.' },
            'CAC': { emoji: '‚ö†Ô∏è', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ.' },
            
            'CBA': { emoji: 'üîç', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.' },
            'CBB': { emoji: 'ü§∑', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ–Ω—É.' },
            'CBC': { emoji: 'üóëÔ∏è', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–£–±—Ä–∞—Ç—å –∏–∑ –º–µ–Ω—é.' },
            
            'CCA': { emoji: 'üßê', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã.' },
            'CCB': { emoji: '‚ùå', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–£–±—Ä–∞—Ç—å –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞.' },
            'CCC': { emoji: 'üíÄ', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–±—Ä–∞—Ç—å!' },
            
            // XYZ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            'X': { emoji: '‚úÖ', text: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å (–≤–∞—Ä–∏–∞—Ü–∏—è <10%)', action: '–õ–µ–≥–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫—É–ø–∫–∏.' },
            'Y': { emoji: 'üìä', text: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è (10-25%)', action: '–ù—É–∂–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å.' },
            'Z': { emoji: '‚ö°', text: '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å (>25%)', action: '–°–ª–æ–∂–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å.' }
        };

        function createTooltip(category) {
            const desc = categoryDescriptions[category];
            if (!desc) return '';
            
            return `<span class="tooltip"><span class="emoji">${desc.emoji}</span>${desc.text}<br><strong>${desc.action}</strong></span>`;
        }

        function wrapWithTooltip(html, category) {
            return `<span class="tooltip-wrapper">${html}${createTooltip(category)}</span>`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ–∑–∏—Ü–∏–π
        function showAllBeersList(barName, sortBy) {
            const barData = currentData[barName];
            if (!barData) return;

            const beers = barData.records || [];
            const hasXYZ = beers.length > 0 && beers[0].XYZ_Category;
            const hasBarColumn = beers.length > 0 && beers[0].Bar;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let sortedBeers = [...beers];
            let title = '';

            if (sortBy === 'revenue') {
                sortedBeers.sort((a, b) => b.TotalRevenue - a.TotalRevenue);
                title = '–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—ã—Ä—É—á–∫–µ';
            } else if (sortBy === 'quantity') {
                sortedBeers.sort((a, b) => b.TotalQty - a.TotalQty);
                title = '–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É';
            } else {
                sortedBeers.sort((a, b) => a.Beer.localeCompare(b.Beer));
                title = '–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ (–∞–ª—Ñ–∞–≤–∏—Ç)';
            }

            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2>${title} ‚Äî ${barName}</h2>
                                <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                                    –í—Å–µ–≥–æ: ${beers.length} SKU ‚Ä¢ –ë—É—Ç—ã–ª–æ–∫: ${formatNumber(barData.total_qty)} —à—Ç ‚Ä¢ –í—ã—Ä—É—á–∫–∞: ${formatMoney(barData.total_revenue)}
                                </p>
                            </div>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    ${hasBarColumn ? '<th>–ë–∞—Ä</th>' : ''}
                                    <th>–ü–∏–≤–æ</th>
                                    <th>–°—Ç–∏–ª—å</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>ABC</th>
                                    ${hasXYZ ? '<th>XYZ</th>' : ''}
                                    <th>–ù–∞—Ü–µ–Ω–∫–∞ %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedBeers.map((beer, i) => `
                                    <tr class="beer-row">
                                        <td>${i + 1}</td>
                                        ${hasBarColumn ? `<td>${beer.Bar}</td>` : ''}
                                        <td>${beer.Beer}</td>
                                        <td>${beer.Style || '‚Äî'}</td>
                                        <td>${formatNumber(beer.TotalQty)}</td>
                                        <td>${formatMoney(beer.TotalRevenue)}</td>
                                        <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                        ${hasXYZ ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                                        <td>${(beer.AvgMarkupPercent * 100).toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
    </script>
</body>
</html>