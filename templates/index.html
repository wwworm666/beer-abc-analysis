<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer ABC/XYZ Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Light Theme */
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --shadow: rgba(0, 0, 0, 0.08);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #999999;
            --text-tertiary: #666666;
            --border-color: #333333;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --shadow: rgba(0, 0, 0, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .header-left p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .theme-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .theme-btn.active {
            background: var(--accent);
            color: white;
        }

        .theme-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        /* Card */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Button */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: auto;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 32px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .loading p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Results */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .bar-section {
            margin-bottom: 40px;
        }

        .bar-header {
            margin-bottom: 32px;
        }

        .bar-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--accent);
        }

        .stat-card .label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Section Title */
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 40px 0 20px 0;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        /* ABC Matrix */
        .abc-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .abc-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .abc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--accent);
        }

        .abc-card.aaa {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .abc-card.ccc {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .abc-card .category {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }

        .abc-card .count {
            font-size: 1.75rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        thead {
            border-bottom: 2px solid var(--border-color);
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .beer-row {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .beer-row:hover {
            background: var(--bg-tertiary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-variant-numeric: tabular-nums;
        }

        .badge.aaa, .badge.aab, .badge.aac { 
            background: var(--success);
            color: white;
        }
        .badge.aba, .badge.abb, .badge.abc,
        .badge.aca, .badge.acb, .badge.acc { 
            background: var(--accent);
            color: white;
        }
        .badge.baa, .badge.bab, .badge.bac,
        .badge.bba, .badge.bbb, .badge.bbc,
        .badge.bca, .badge.bcb, .badge.bcc { 
            background: var(--warning);
            color: white;
        }
        .badge.caa, .badge.cab, .badge.cac,
        .badge.cba, .badge.cbb, .badge.cbc,
        .badge.ccc { 
            background: var(--danger);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 40px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            transition: color 0.2s ease;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Chart */
        .chart-container {
            margin: 20px 0;
            padding: 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .chart-icon {
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
            display: inline-block;
        }

        .chart-icon:hover {
            transform: scale(1.2);
        }

        /* Error */
        .error {
            background: var(--danger);
            color: white;
            padding: 16px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .error.active {
            display: block;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
        }
        /* Tooltips */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow);
            white-space: nowrap;
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1.4;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border-color) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip strong {
            color: var(--accent);
        }

        .tooltip .emoji {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Beer ABC/XYZ Analysis</h1>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –ø–∏–≤–∞ –∏–∑ iiko</p>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn active" onclick="setTheme('light')">–°–≤–µ—Ç–ª–∞—è</button>
                <button class="theme-btn" onclick="setTheme('dark')">–¢—ë–º–Ω–∞—è</button>
            </div>
        </div>

        <div class="card">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
            <div style="margin-bottom: 24px;">
                <label style="margin-bottom: 12px; display: block;">–†–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞</label>
                <div class="theme-toggle">
                    <button class="theme-btn active" id="mode-beers" onclick="setAnalysisMode('beers')">–ü–æ —Ñ–∞—Å–æ–≤–∫–∞–º</button>
                    <button class="theme-btn" id="mode-categories" onclick="setAnalysisMode('categories')">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                </div>
            </div>

            <div class="controls">
                <div class="form-group">
                    <label for="bar-select">–ë–∞—Ä</label>
                    <select id="bar-select">
                        <option value="">–í—Å–µ –±–∞—Ä—ã</option>
                        {% for bar in bars %}
                        <option value="{{ bar }}">{{ bar }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="days-input">–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
                    <input type="number" id="days-input" value="30" min="7" max="365">
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="runAnalysis()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                </div>
            </div>
        </div>

        <div class="error" id="error-message"></div>

        <div class="card loading" id="loading">
            <div class="spinner"></div>
            <h2>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</h2>
            <p>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        let currentData = {};
        let activeCharts = {};
        let analysisMode = 'beers'; // 'beers' –∏–ª–∏ 'categories'

        // Analysis mode management
        function setAnalysisMode(mode) {
            analysisMode = mode;

            document.querySelectorAll('#mode-beers, #mode-categories').forEach(btn => {
                btn.classList.remove('active');
            });

            if (mode === 'beers') {
                document.getElementById('mode-beers').classList.add('active');
            } else {
                document.getElementById('mode-categories').classList.add('active');
            }
        }

        // Theme management
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelectorAll('.theme-btn').forEach(btn => {
            if ((savedTheme === 'light' && btn.textContent === '–°–≤–µ—Ç–ª–∞—è') ||
                (savedTheme === 'dark' && btn.textContent === '–¢—ë–º–Ω–∞—è')) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        async function runAnalysis() {
            const bar = document.getElementById('bar-select').value;
            const days = document.getElementById('days-input').value;

            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error-message').classList.remove('active');

            try {
                // –í—ã–±–∏—Ä–∞–µ–º endpoint –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                const endpoint = analysisMode === 'categories' ? '/api/categories' : '/api/analyze';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bar, days })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                const data = await response.json();
                currentData = data;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (analysisMode === 'categories') {
                    displayCategoryResults(data);
                } else {
                    displayResults(data);
                }

            } catch (error) {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            for (const [barName, barData] of Object.entries(data)) {
                const section = createBarSection(barName, barData);
                resultsDiv.appendChild(section);
            }

            resultsDiv.classList.add('active');
        }

        function createBarSection(barName, data) {
            const section = document.createElement('div');
            section.className = 'bar-section';
            
            const card = document.createElement('div');
            card.className = 'card';

            const header = `
                <div class="bar-header">
                    <h2>${barName}</h2>
                </div>
            `;

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                        <div class="value">${formatMoney(data.total_revenue)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">–ü—Ä–æ–¥–∞–Ω–æ</div>
                        <div class="value">${formatNumber(data.total_qty)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">–§–∞—Å–æ–≤–æ–∫</div>
                        <div class="value">${data.total_beers}</div>
                    </div>
                </div>
            `;

           const abcCards = Object.entries(data.abc_stats || data.stats || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12)
                .map(([category, count]) => `
                    <div class="abc-card ${category.toLowerCase()}" onclick="showCategoryDetails('${barName}', '${category}')">
                        ${wrapWithTooltip(`<div class="category">${category}</div>`, category)}
                        <div class="count">${count}</div>
                    </div>
                `).join('');

            const matrix = `
                <h3 class="section-title">ABC –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <div class="abc-matrix">
                    ${abcCards}
                </div>
            `;

            let xyzSection = '';
            if (data.xyz_stats && Object.keys(data.xyz_stats).length > 0) {
             const xyzCards = Object.entries(data.xyz_stats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([category, count]) => {
                        let bgClass = '';
                        if (category === 'X') bgClass = 'aaa';
                        else if (category === 'Y') bgClass = 'bbb';
                        else if (category === 'Z') bgClass = 'ccc';
                        
                        return `
                            <div class="abc-card ${bgClass}" onclick="showXYZDetails('${barName}', '${category}')">
                                ${wrapWithTooltip(`<div class="category">${category}</div>`, category)}
                                <div class="count">${count}</div>
                            </div>
                        `;
                    }).join('');

                xyzSection = `
                    <h3 class="section-title">XYZ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)</h3>
                    <div class="abc-matrix">
                        ${xyzCards}
                    </div>
                `;
            }

           const topTable = `
                <h3 class="section-title">–¢–æ–ø-10 –ø–æ –≤—ã—Ä—É—á–∫–µ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ü–∏–≤–æ</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>ABC</th>
                            ${data.top_beers && data.top_beers[0] && data.top_beers[0].XYZ_Category ? '<th>XYZ</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${(data.top_beers || []).map((beer, i) => `
                            <tr class="beer-row">
                                <td>${i + 1}</td>
                                <td>${beer.Beer}</td>
                                <td>${formatMoney(beer.TotalRevenue)}</td>
                                <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                ${beer.XYZ_Category ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            card.innerHTML = header + stats + matrix + xyzSection + topTable;
            section.appendChild(card);
            return section;
        }

        function getXYZBadgeClass(xyz) {
            if (xyz === 'X') return 'aaa';
            if (xyz === 'Y') return 'bbb';
            return 'ccc';
        }

        function showCategoryDetails(barName, category) {
            const barData = currentData[barName];
            if (!barData) return;

            const beers = barData.records.filter(record => record.ABC_Combined === category);
            const hasXYZ = beers.length > 0 && beers[0].XYZ_Category;
            
            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${category} ‚Äî ${barName}</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">–í—Å–µ–≥–æ: ${beers.length} —Ñ–∞—Å–æ–≤–æ–∫</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ü–∏–≤–æ</th>
                                    <th>–°—Ç–∏–ª—å</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–ù–∞—Ü–µ–Ω–∫–∞ %</th>
                                    ${hasXYZ ? '<th>XYZ</th>' : ''}
                                    ${hasXYZ ? '<th>–í–∞—Ä–∏–∞—Ü–∏—è</th>' : ''}
                                    <th>–ì—Ä–∞—Ñ–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => {
                                        const safeId = `cat-${category}-${i}`;
                                        return `
                                        <tr class="beer-row" id="beer-row-${safeId}">
                                            <td>${i + 1}</td>
                                            <td>${beer.Beer}</td>
                                            <td>${beer.Style || '‚Äî'}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>${(beer.AvgMarkupPercent * 100).toFixed(1)}%</td>
                                            ${hasXYZ ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                                            ${hasXYZ ? `<td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>` : ''}
                                            <td>
                                                <span class="chart-icon" onclick='showWeeklyChart(event, "${barName}", ${JSON.stringify(beer.Beer)}, "${safeId}")'>
                                                    üìä
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="chart-row-${safeId}" style="display: none;">
                                            <td colspan="${hasXYZ ? 9 : 7}">
                                                <div class="chart-container">
                                                    <canvas id="chart-${safeId}"></canvas>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function showXYZDetails(barName, xyzCategory) {
            const barData = currentData[barName];
            if (!barData) return;

            const beers = barData.records.filter(record => record.XYZ_Category === xyzCategory);
            
            let categoryName = xyzCategory;
            let categoryDesc = '';
            if (xyzCategory === 'X') {
                categoryName = 'X ‚Äî –°—Ç–∞–±–∏–ª—å–Ω—ã–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è < 10%';
            } else if (xyzCategory === 'Y') {
                categoryName = 'Y ‚Äî –°—Ä–µ–¥–Ω–∏–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è 10-25%';
            } else if (xyzCategory === 'Z') {
                categoryName = 'Z ‚Äî –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π';
                categoryDesc = '–í–∞—Ä–∏–∞—Ü–∏—è > 25%';
            }
            
            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2>${categoryName} ‚Äî ${barName}</h2>
                                <p style="color: var(--text-secondary); margin-top: 4px; font-size: 0.9rem;">${categoryDesc}</p>
                            </div>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">–í—Å–µ–≥–æ: ${beers.length} —Ñ–∞—Å–æ–≤–æ–∫</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ü–∏–≤–æ</th>
                                    <th>ABC</th>
                                    <th>–í–∞—Ä–∏–∞—Ü–∏—è</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–ì—Ä–∞—Ñ–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => {
                                        const safeId = `xyz-${xyzCategory}-${i}`;
                                        return `
                                        <tr class="beer-row" id="beer-row-${safeId}">
                                            <td>${i + 1}</td>
                                            <td>${beer.Beer}</td>
                                         <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                            <td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>
                                                <span class="chart-icon" onclick='showWeeklyChart(event, "${barName}", ${JSON.stringify(beer.Beer)}, "${safeId}")'>
                                                    üìä
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="chart-row-${safeId}" style="display: none;">
                                            <td colspan="7">
                                                <div class="chart-container">
                                                    <canvas id="chart-${safeId}"></canvas>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function showWeeklyChart(event, barName, beerName, rowId) {
            event.stopPropagation();
            
            const chartRow = document.getElementById(`chart-row-${rowId}`);
            
            if (chartRow && chartRow.style.display !== 'none') {
                chartRow.style.display = 'none';
                if (activeCharts[rowId]) {
                    activeCharts[rowId].destroy();
                    delete activeCharts[rowId];
                }
                return;
            }
            
            if (chartRow) {
                chartRow.style.display = 'table-row';
            }
            
            try {
                const response = await fetch(`/api/weekly-chart/${encodeURIComponent(barName)}/${encodeURIComponent(beerName)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
                
                const data = await response.json();
                
                const canvas = document.getElementById(`chart-${rowId}`);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                if (activeCharts[rowId]) {
                    activeCharts[rowId].destroy();
                }

                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                
                activeCharts[rowId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.weeks,
                        datasets: [{
                            label: '–ü—Ä–æ–¥–∞–∂–∏ (—à—Ç)',
                            data: data.sales,
                            borderColor: isDark ? '#3b82f6' : '#0066cc',
                            backgroundColor: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(0, 102, 204, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: isDark ? '#3b82f6' : '#0066cc',
                            pointBorderColor: isDark ? '#1a1a1a' : '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: beerName,
                                color: isDark ? '#e0e0e0' : '#1a1a1a',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#2a2a2a' : '#ffffff',
                                titleColor: isDark ? '#e0e0e0' : '#1a1a1a',
                                bodyColor: isDark ? '#e0e0e0' : '#1a1a1a',
                                borderColor: isDark ? '#333333' : '#e0e0e0',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} —à—Ç`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: isDark ? '#666666' : '#999999'
                                },
                                grid: {
                                    color: isDark ? '#2a2a2a' : '#f5f5f5'
                                },
                                border: {
                                    display: false
                                }
                            },
                            x: {
                                ticks: {
                                    color: isDark ? '#666666' : '#999999'
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                canvas.style.height = '300px';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + error.message);
                if (chartRow) {
                    chartRow.style.display = 'none';
                }
            }
        }

        function displayCategoryResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const bar = document.getElementById('bar-select').value;

            if (bar) {
                // –î–ª—è –æ–¥–Ω–æ–≥–æ –±–∞—Ä–∞
                const section = createCategorySectionForBar(bar, data);
                resultsDiv.appendChild(section);
            } else {
                // –î–ª—è –≤—Å–µ—Ö –±–∞—Ä–æ–≤
                for (const [barName, categoryData] of Object.entries(data.categories || {})) {
                    const section = createCategorySectionForBar(barName, { categories: categoryData, summary: data.summary });
                    resultsDiv.appendChild(section);
                }
            }

            resultsDiv.classList.add('active');
        }

        function createCategorySectionForBar(barName, data) {
            const section = document.createElement('div');
            section.className = 'bar-section';

            const card = document.createElement('div');
            card.className = 'card';

            const header = `
                <div class="bar-header">
                    <h2>üìä ${barName} ‚Äî –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                </div>
            `;

            // –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            let summaryTable = '';
            if (data.summary && data.summary.length > 0) {
                const barSummary = data.summary.filter(s => !barName || s.Category);

                summaryTable = `
                    <h3 class="section-title">–°–≤–æ–¥–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–§–∞—Å–æ–≤–æ–∫</th>
                                <th>–í—ã—Ä—É—á–∫–∞</th>
                                <th>% –æ—Ç –≤—ã—Ä—É—á–∫–∏</th>
                                <th>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π %</th>
                                <th>ABC</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${barSummary.map(cat => `
                                <tr class="beer-row" onclick="showCategoryDetail('${barName}', '${cat.Category}')">
                                    <td><strong>${cat.Category}</strong></td>
                                    <td>${cat.BeersCount}</td>
                                    <td>${formatMoney(cat.TotalRevenue)}</td>
                                    <td>${cat.RevenuePercent.toFixed(1)}%</td>
                                    <td>${cat.CumulativePercent.toFixed(1)}%</td>
                                    <td><span class="badge ${cat.ABC_Category.toLowerCase()}">${cat.ABC_Category}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // –î–µ—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            let categoryCards = '';
            const categories = data.categories || {};

            if (Object.keys(categories).length > 0) {
                const sortedCategories = Object.entries(categories)
                    .sort((a, b) => b[1].total_revenue - a[1].total_revenue)
                    .slice(0, 10); // –¢–æ–ø-10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π

                categoryCards = `
                    <h3 class="section-title">–¢–æ–ø-10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –≤—ã—Ä—É—á–∫–µ</h3>
                    <div class="abc-matrix">
                        ${sortedCategories.map(([catName, catData]) => {
                            const topABC = Object.entries(catData.abc_stats || {})
                                .sort((a, b) => b[1] - a[1])[0];
                            const dominantABC = topABC ? topABC[0] : 'BBB';

                            return `
                                <div class="abc-card" onclick="showCategoryDetail('${barName}', '${catName}')" style="cursor: pointer;">
                                    <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; min-height: 40px;">
                                        ${catName.length > 25 ? catName.substring(0, 25) + '...' : catName}
                                    </div>
                                    <div class="category">
                                        <span class="badge ${dominantABC.toLowerCase()}">${dominantABC}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                                        ${formatMoney(catData.total_revenue)}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                        ${catData.total_beers} —Ñ–∞—Å–æ–≤–æ–∫
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            card.innerHTML = header + summaryTable + categoryCards;
            section.appendChild(card);
            return section;
        }

        function showCategoryDetail(barName, categoryName) {
            const categories = currentData.categories || {};
            const catData = categories[categoryName] || (categories[barName] && categories[barName][categoryName]);

            if (!catData) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                return;
            }

            const beers = catData.beers || [];
            const hasXYZ = beers.length > 0 && beers[0].XYZ_Category;

            const modalHTML = `
                <div class="modal active" id="category-modal" onclick="closeModalBackdrop(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2>${categoryName} ‚Äî ${barName}</h2>
                                <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.9rem;">
                                    ${catData.total_beers} —Ñ–∞—Å–æ–≤–æ–∫ ‚Ä¢ –í—ã—Ä—É—á–∫–∞: ${formatMoney(catData.total_revenue)}
                                </p>
                            </div>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>

                        <!-- ABC —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <h3 class="section-title">ABC —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                        <div class="abc-matrix" style="margin-bottom: 30px;">
                            ${Object.entries(catData.abc_stats || {})
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 8)
                                .map(([abc, count]) => `
                                    <div class="abc-card ${abc.toLowerCase()}">
                                        <div class="category">${abc}</div>
                                        <div class="count">${count}</div>
                                    </div>
                                `).join('')}
                        </div>

                        ${hasXYZ ? `
                            <h3 class="section-title">XYZ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                            <div class="abc-matrix" style="margin-bottom: 30px;">
                                ${Object.entries(catData.xyz_stats || {})
                                    .map(([xyz, count]) => {
                                        let bgClass = xyz === 'X' ? 'aaa' : (xyz === 'Y' ? 'bbb' : 'ccc');
                                        return `
                                            <div class="abc-card ${bgClass}">
                                                <div class="category">${xyz}</div>
                                                <div class="count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        ` : ''}

                        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –ø–∏–≤–æ–º -->
                        <h3 class="section-title">–í—Å–µ —Ñ–∞—Å–æ–≤–∫–∏</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ü–∏–≤–æ</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>ABC</th>
                                    ${hasXYZ ? '<th>XYZ</th>' : ''}
                                    ${hasXYZ ? '<th>–í–∞—Ä–∏–∞—Ü–∏—è</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${beers
                                    .sort((a, b) => b.TotalRevenue - a.TotalRevenue)
                                    .map((beer, i) => `
                                        <tr class="beer-row">
                                            <td>${i + 1}</td>
                                            <td>${beer.Beer}</td>
                                            <td>${formatNumber(beer.TotalQty)}</td>
                                            <td>${formatMoney(beer.TotalRevenue)}</td>
                                            <td>${wrapWithTooltip(`<span class="badge ${beer.ABC_Combined.toLowerCase()}">${beer.ABC_Combined}</span>`, beer.ABC_Combined)}</td>
                                            ${hasXYZ ? `<td>${wrapWithTooltip(`<span class="badge ${getXYZBadgeClass(beer.XYZ_Category)}">${beer.XYZ_Category}</span>`, beer.XYZ_Category)}</td>` : ''}
                                            ${hasXYZ ? `<td>${beer.CoefficientOfVariation ? beer.CoefficientOfVariation.toFixed(1) + '%' : '‚Äî'}</td>` : ''}
                                        </tr>
                                    `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeModalBackdrop(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('category-modal');
            if (modal) {
                modal.remove();
            }
            for (let key in activeCharts) {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                }
            }
            activeCharts = {};
        }

        function formatMoney(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('ru-RU').format(value);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        // –û–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è tooltips
        const categoryDescriptions = {
            // ABC –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            'AAA': { emoji: 'üåü', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ó–≤–µ–∑–¥—ã –º–µ–Ω—é! Must have.' },
            'AAB': { emoji: '‚≠ê', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ.' },
            'AAC': { emoji: '‚ö†Ô∏è', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.' },
            
            'ABA': { emoji: 'üí∞', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞ —Å—á—ë—Ç –æ–±—ä—ë–º–∞.' },
            'ABB': { emoji: '‚úÖ', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°—Ç–∞–±–∏–ª—å–Ω–æ —Ö–æ—Ä–æ—à–æ.' },
            'ABC': { emoji: 'üìä', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω—É.' },
            
            'ACA': { emoji: 'üî•', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ù–∞—Ä–æ–¥–Ω–æ–µ –ø–∏–≤–æ!' },
            'ACB': { emoji: 'üí°', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É.' },
            'ACC': { emoji: '‚ö†Ô∏è', text: '–û—Ç–ª–∏—á–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É!' },
            
            'BAA': { emoji: 'üíé', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–µ–º–∏—É–º —Å–µ–≥–º–µ–Ω—Ç.' },
            'BAB': { emoji: '‚úÖ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å.' },
            'BAC': { emoji: 'ü§î', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã.' },
            
            'BBA': { emoji: 'üìà', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–°—Ç–æ–∏—Ç –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å.' },
            'BBB': { emoji: '‚ûñ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°–µ—Ä–µ–¥–Ω—è—á–æ–∫.' },
            'BBC': { emoji: 'üìâ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å.' },
            
            'BCA': { emoji: 'üéØ', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É.' },
            'BCB': { emoji: 'üí≠', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–°–ª–∞–±–æ–≤–∞—Ç–æ.' },
            'BCC': { emoji: '‚ùå', text: '–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –∑–∞–º–µ–Ω—É.' },
            
            'CAA': { emoji: 'üç∑', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: 'Craft/Premium –¥–ª—è –∏–º–∏–¥–∂–∞.' },
            'CAB': { emoji: 'üé®', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–ù–∏—à–µ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç.' },
            'CAC': { emoji: '‚ö†Ô∏è', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ.' },
            
            'CBA': { emoji: 'üîç', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.' },
            'CBB': { emoji: 'ü§∑', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ–Ω—É.' },
            'CBC': { emoji: 'üóëÔ∏è', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–£–±—Ä–∞—Ç—å –∏–∑ –º–µ–Ω—é.' },
            
            'CCA': { emoji: 'üßê', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞', action: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã.' },
            'CCB': { emoji: '‚ùå', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞', action: '–£–±—Ä–∞—Ç—å –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞.' },
            'CCC': { emoji: 'üíÄ', text: '–ù–∏–∑–∫–∞—è –≤—ã—Ä—É—á–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ ‚Ä¢ –ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∞', action: '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–±—Ä–∞—Ç—å!' },
            
            // XYZ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            'X': { emoji: '‚úÖ', text: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å (–≤–∞—Ä–∏–∞—Ü–∏—è <10%)', action: '–õ–µ–≥–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫—É–ø–∫–∏.' },
            'Y': { emoji: 'üìä', text: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è (10-25%)', action: '–ù—É–∂–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å.' },
            'Z': { emoji: '‚ö°', text: '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å (>25%)', action: '–°–ª–æ–∂–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å.' }
        };

        function createTooltip(category) {
            const desc = categoryDescriptions[category];
            if (!desc) return '';
            
            return `<span class="tooltip"><span class="emoji">${desc.emoji}</span>${desc.text}<br><strong>${desc.action}</strong></span>`;
        }

        function wrapWithTooltip(html, category) {
            return `<span class="tooltip-wrapper">${html}${createTooltip(category)}</span>`;
        }
    </script>
</body>
</html>