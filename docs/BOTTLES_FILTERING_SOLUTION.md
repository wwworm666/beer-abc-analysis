# Решение проблемы фильтрации фасованного пива

**Дата:** 2025-11-15

## Проблема

Endpoint `/api/stocks/bottles` не мог найти фасованное пиво, потому что использовал фильтрацию по ключевым словам в названии товара (`пив`, `beer`, `ipa`, и т.д.). Однако большинство позиций фасовки не содержат эти слова в названии.

## Анализ доступных полей API

Изучив iiko API (endpoint `/products`), были найдены следующие доступные поля для каждого товара:

```
1. id              - GUID товара
2. parentId        - ID родительской группы/категории
3. num             - Внутренний номер
4. code            - Код товара
5. name            - Название товара
6. productType     - Тип: GOODS, DISH, OUTER
7. cookingPlaceType- Место приготовления
8. mainUnit        - Единица измерения
9. productCategory - Категория (поставщик)
10. containers     - Контейнеры
11. barcodes       - Штрихкоды
12. productGroupType - Тип группы
```

## Решение

Ключевым полем оказалось **`parentId`** - идентификатор родительской группы товара.

### Обнаруженная структура групп

В системе iiko существует группа **"Напитки Фасовка"** с ID: `6103ecbf-e6f8-49fe-8cd2-6102d49e14a6`

Эта группа содержит подгруппы:
- Аббатское и похожее (Ф)
- Безалкогольное (Ф)
- Карамельное и янтарное пиво (Ф)
- Кислые эли (Ф)
- Миды (Ф)
- НАБОРЫ
- НОВЫЕ АЛКОГОЛЬНЫЕ ТОВАРЫ
- Нефильтрованное пиво (Ф)
- Охмеленные эли (Ф)
- Светлые лагеры (Ф)
- и другие...

Которые, в свою очередь, содержат конкретные товары.

### Реализация

#### 1. Обновлен `core/olap_reports.py`

Добавлено поле `parentId` в метод `get_nomenclature()`:

```python
product_info = {
    'name': ...,
    'type': ...,
    'category': ...,
    'mainUnit': ...,
    'parentId': product_el.find('parentId').text if product_el.find('parentId') is not None else None,
}
```

Добавлен новый метод `get_products_in_group()`:

```python
def get_products_in_group(self, parent_group_id, nomenclature=None):
    """
    Рекурсивно получить все товары, входящие в указанную группу

    Returns:
        set с ID всех товаров в этой группе и подгруппах
    """
```

Метод рекурсивно обходит всю иерархию групп и возвращает набор ID всех товаров.

#### 2. Обновлен `app.py` (endpoint `/api/stocks/bottles`)

Старая логика (НЕ РАБОТАЛА):
```python
# Фильтровали по ключевым словам
if product_type != 'GOODS': continue
if product_unit != 'шт': continue
beer_keywords = ['пив', 'beer', 'ipa', ...]
if not any(keyword in product_name_lower for keyword in beer_keywords):
    continue
```

Новая логика (РАБОТАЕТ):
```python
# ID группы "Напитки Фасовка"
FASOVKA_GROUP_ID = '6103ecbf-e6f8-49fe-8cd2-6102d49e14a6'

# Получаем все товары из группы (включая подгруппы)
fasovka_product_ids = olap.get_products_in_group(FASOVKA_GROUP_ID, nomenclature)

# Фильтруем по группе
if product_id not in fasovka_product_ids:
    continue
```

## Результат

До исправления:
- Найдено товаров: **0**

После исправления:
- Найдено товаров: **529** (для бара "Большой пр. В.О")
- Всего в группе "Напитки Фасовка": **4146 товаров**
  - Тип GOODS: 4106
  - Тип DISH: 40
  - Единица "шт": 4129
  - Единица "л": 6
  - Единица "кг": 11

### Поставщики фасовки

1. ООО Невский Синдикат - 249 позиций
2. ООО Фёст - 97 позиций
3. ООО МаркетБир - 73 позиции
4. СПБ-Премиум - 52 позиции
5. Партнер ООО - 25 позиций
6. БирИнсайдерс - 21 позиция
7. ЕГАИС - 6 позиций
8. ДримТим - 5 позиций
9. ООО "Хорошее пиво" - 1 позиция

## Изменённые файлы

1. **core/olap_reports.py** (строки 100-149):
   - Добавлено поле `parentId` в `get_nomenclature()`
   - Добавлен метод `get_products_in_group()`

2. **app.py** (строки 1590-1629):
   - Заменена логика фильтрации с ключевых слов на фильтрацию по группе

## Тестирование

Созданы скрипты для отладки:
- `debug_full_product_fields.py` - показывает все доступные поля из API
- `debug_product_groups.py` - анализирует структуру групп товаров
- `test_fasovka_group.py` - тестирует метод `get_products_in_group()`
- `test_bottles_final.py` - тестирует весь endpoint `/api/stocks/bottles`

Все тесты успешно пройдены.
