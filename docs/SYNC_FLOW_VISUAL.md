# 🔄 ВИЗУАЛЬНЫЕ ДИАГРАММЫ СИНХРОНИЗАЦИИ

## Диаграмма 1: От заказа клиента к отчёту

```
╔════════════════════════════════════════════════════════════════════════════╗
║                          ЖИЗНЕННЫЙ ЦИКЛ ПИВА                              ║
║                       (От клиента к аналитике)                            ║
╚════════════════════════════════════════════════════════════════════════════╝

                        🍺 КЛИЕНТ ЗАКАЗЫВАЕТ ПИВО
                              (Бар/Ресторан)
                                    |
                                    | POS
                                    v
                    ┌─────────────────────────────────┐
                    │  Brewlok IPA (0,5)              │ ← DishName
                    │  Количество: 1                  │
                    │  Бар: Большой пр. В.О          │
                    │  Время: 2025-11-03 18:30       │
                    │  Цена: 350 руб                  │
                    └────────────┬────────────────────┘
                                 |
                                 | iiko POS
                                 v
                    ┌─────────────────────────────────┐
                    │   Экспорт в OLAP                │
                    │   (Аккумуляция в хранилище)    │
                    └────────────┬────────────────────┘
                                 |
                                 | ежедневно/еженедельно
                                 v
                    ┌─────────────────────────────────┐
                    │  iiko OLAP хранилище            │
                    │  (SQL база данных)              │
                    │  Таблица: draft_sales           │
                    └────────────┬────────────────────┘
                                 |
                                 | API запрос
                                 v
                    ┌─────────────────────────────────┐
                    │  ПРИЛОЖЕНИЕ (app.py)            │
                    │  Запрашивает последние 30 дней  │
                    └────────────┬────────────────────┘
                                 |
           ┌─────────────────────┼─────────────────────┐
           |                     |                     |
           v                     v                     v
    ┌──────────────┐   ┌──────────────────┐  ┌───────────────┐
    │ ПАРСИНГ      │   │ РАСЧЁТ ОБЪЁМА    │  │ МЭППИНГ       │
    │              │   │                  │  │               │
    │ extract_beer │   │ DishAmountInt *  │  │ Lookup in     │
    │ _info()      │   │ PortionVolume    │  │ KEG_TO_DISH   │
    │              │   │                  │  │ _MAPPING      │
    │ "Brewlok IPA │   │ 1 * 0.5 = 0.5L  │  │               │
    │ (0,5)"→      │   │                  │  │ "Brewlok IPA" │
    │ ("Brewlok    │   │ VolumeInLiters   │  │ → кег         │
    │ IPA", 0.5)   │   │                  │  │               │
    └──────┬───────┘   └────────┬─────────┘  └───────┬───────┘
           |                    |                    |
           └────────────────────┼────────────────────┘
                                |
                                v
                    ┌─────────────────────────────────┐
                    │  DATAFRAME (pandas)             │
                    │  BeerName: "Brewlok IPA"        │
                    │  PortionVolume: 0.5             │
                    │  VolumeInLiters: 0.5            │
                    │  Store: "Большой пр. В.О"      │
                    │  KeG: "КЕГ Brewlok IPA 20л"    │
                    └────────────┬────────────────────┘
                                 |
                                 | GROUP BY BeerName, Store
                                 v
                    ┌─────────────────────────────────┐
                    │  АГРЕГИРОВАНИЕ                  │
                    │  (get_beer_summary)             │
                    │  TotalLiters: 75.0              │
                    │  TotalPortions: 150             │
                    │  BeerSharePercent: 3.2%         │
                    │  Kegs30L: 2.5                   │
                    │  ABC: "B", XYZ: "X"             │
                    └────────────┬────────────────────┘
                                 |
                                 | JSON serialize
                                 v
                    ┌─────────────────────────────────┐
                    │  API RESPONSE                   │
                    │  JSON с аналитикой              │
                    └────────────┬────────────────────┘
                                 |
                                 | HTTP
                                 v
                    ┌─────────────────────────────────┐
                    │  БРАУЗЕР (JavaScript)           │
                    │  Получает JSON                  │
                    └────────────┬────────────────────┘
                                 |
                                 | Парсинг JSON
                                 v
                    ┌─────────────────────────────────┐
                    │  СТРАНИЦА "ПРОЛИВЫ"             │
                    │                                 │
                    │  Brewlok IPA (Большой пр. В.О) │
                    │  ├─ 75.0 L                      │
                    │  ├─ 150 порций                  │
                    │  ├─ 3.2% доля                   │ ← Что видит пользователь
                    │  ├─ ~2.5 кега 30L               │
                    │  ├─ ABC: B (Важное)             │
                    │  └─ XYZ: X (Стабильное)         │
                    └─────────────────────────────────┘

```

---

## Диаграмма 2: Архитектура мэппинга

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                    СИСТЕМА МЭППИНГА (KEG ↔ DISH)                          ║
║                     Как соединить два мира                                ║
╚═══════════════════════════════════════════════════════════════════════════╝

┌───────────────────────────────────────────────────────────────────────────┐
│                      ИНВЕНТАРЬ iiko                                       │
│                    (Кеги как товары)                                     │
│                                                                           │
│  Товар ID: 12345  →  КЕГ Brewlok IPA 20 л                              │
│  Товар ID: 12346  →  КЕГ ФестХаус Хеллес 30 л                         │
│  Товар ID: 12347  →  КЕГ Блек Шип 50 л                                │
└────────────────────────┬────────────────────────────────────────────────┘
                         |
                         | Экспорт в CSV
                         |
┌────────────────────────┴────────────────────────────────────────────────┐
│ CSV: active_dishes_to_kegs_CLEAN.csv                                     │
│ (Исходный источник истины)                                              │
│                                                                          │
│ KEG_NAME                         | DISH_NAME                            │
│ ─────────────────────────────────────────────────────────────────────   │
│ КЕГ Brewlok IPA 20 л            | Brewlok IPA                          │
│ КЕГ Brewlok IPA 20 л            | ВО Brewlok IPA                       │
│ КЕГ ФестХаус Хеллес 30 л        | ФестХаус Хеллес                      │
│ КЕГ Блек Шип 50 л               | Блек Шип                             │
└────────────────────────┬────────────────────────────────────────────────┘
                         |
                         | python utils/import_final_mapping.py
                         |
        ┌────────────────┼────────────────┬──────────────────┐
        |                |                |                  |
        v                v                v                  v
┌──────────────┐  ┌────────────────┐ ┌────────────────┐  ┌──────────────┐
│ Python dict  │  │ JSON forward   │ │ JSON reverse   │  │ Validation   │
│              │  │                │ │                │  │              │
│ mapping/     │  │ data/          │ │ data/          │  │ Check for    │
│ keg_mapping  │  │ keg_mapping    │ │ dish_to_keg    │  │ duplicates   │
│ .py          │  │ .json          │ │ _mapping.json  │  │              │
│              │  │                │ │                │  │              │
│ KEG_TO_DISH_ │  │ {              │ │ {              │  │              │
│ MAPPING = {  │  │  "кег": [      │ │  "dish": "кег" │  │ ✓ Valid      │
│  "КЕГ...":   │  │   "dish1",     │ │ }              │  │ ✓ Complete   │
│  ["dish1",   │  │   "dish2"      │ │                │  │ ✓ Unique     │
│   "dish2"    │  │  ]             │ │                │  │              │
│  ]           │  │ }              │ │                │  │              │
│ }            │  │                │ │                │  │              │
└──────┬───────┘  └────────┬───────┘ └────────┬───────┘  └──────────────┘
       |                   |                  |
       └───────────────────┼──────────────────┘
                           |
                           | Импортируется в памяти приложения
                           |
┌──────────────────────────┴──────────────────────────────────────────────┐
│                    RUNNING APPLICATION                                  │
│                      (Flask app.py)                                     │
│                                                                         │
│  from mapping.keg_mapping import KEG_TO_DISH_MAPPING                   │
│                                                                         │
│  При старте загружает весь словарь в оперативную память                │
└──────────────────────────┬──────────────────────────────────────────────┘
                           |
                           | Используется в коде
                           |
       ┌───────────────────┼───────────────────┐
       |                   |                   |
       v                   v                   v
  get_beer_summary()  analyze_draft()  categorize_beer()
  (draft_analysis)    (app.py)         (category_analysis)

```

---

## Диаграмма 3: Процесс нормализации имён

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                      НОРМАЛИЗАЦИЯ ИМЁН БЕР                               ║
║              Как из DishName получить BeerName                           ║
╚═══════════════════════════════════════════════════════════════════════════╝

RAW DishName из iiko OLAP:
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ВО Brewlok IPA (0,5)                                                  │
│  │     │          │    │                                              │
│  │     │          │    └─── Размер порции в скобках                  │
│  │     │          │                                                   │
│  │     │          └─────── Вариант (0.5L, 0.25L, 1.0L)                │
│  │     │                                                              │
│  │     └────────────────── Название пива (латинское)                │
│  │                                                                    │
│  └───────────────────────── Префикс (ВО = Во Время)                │
│                                                                      │
└──────────────────────────────────────────────────────────────────────────┘
        |
        | STEP 1: REMOVE PREFIX
        | (НЗ, ВО, ТЦ)
        v
┌──────────────────────────────────────────────────────────────────────────┐
│  Brewlok IPA (0,5)                                                      │
└──────────────────────────────────────────────────────────────────────────┘
        |
        | STEP 2: EXTRACT VOLUME (используя regex)
        | pattern = r'\((\d+[,\.]\d+)\)'
        v
        ┌─────────────────────────────────────────────┐
        │ BeerName: "Brewlok IPA"                     │
        │ PortionVolume: 0.5                          │
        └─────────────────────────────────────────────┘
        |
        | STEP 3: LOOKUP IN MAPPING
        | for keg, dishes in KEG_TO_DISH_MAPPING.items():
        |     if "Brewlok IPA" in dishes:
        v
┌──────────────────────────────────────────────────────────────────────────┐
│  FOUND KEG: КЕГ Brewlok IPA 20 л                                        │
│                                                                          │
│  Теперь можем получить:                                                │
│  • Объём кега: 20л                                                     │
│  • Стоимость единицы                                                   │
│  • Остаток в инвентаре (опционально)                                   │
│  • Поставщика                                                          │
│  • Регион происхождения                                               │
└──────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════

ПРИМЕР С РАЗНЫМИ ВАРИАНТАМИ:

Input:                      Extract Beer:        Found KEG:
─────────────────────────────────────────────────────────────────────────
НЗ Brewlok IPA (0,5)    →   Brewlok IPA      →   КЕГ Brewlok IPA 20л
ВО Brewlok IPA (0,5)    →   Brewlok IPA      →   КЕГ Brewlok IPA 20л
Brewlok IPA (0,25)      →   Brewlok IPA      →   КЕГ Brewlok IPA 20л
ТЦ Brewlok IPA (1,0)    →   Brewlok IPA      →   КЕГ Brewlok IPA 20л
Brewlok IPA             →   Brewlok IPA      →   КЕГ Brewlok IPA 20л
                                                 (Даже без объёма!)

═══════════════════════════════════════════════════════════════════════════

СТАРАЯ ОШИБКА (исправлена):

Строгий regex требовал конца строки:
pattern = r'^(.+?)\s*\((\d+[,\.]\d+)\)\s*$'

Проблема:
─────────────────────────────────────────────────────────────────────────
"ХБ Октоберфест (1,0) с собой"  →  НЕ СОВПАДАЕТ ❌
                               ↓
                            beer = "ХБ Октоберфест (1,0) с собой"
                            volume = 0.0 (ERROR!)

Новый гибкий regex:
pattern = r'\((\d+[,\.]\d+)\)'

Решение:
─────────────────────────────────────────────────────────────────────────
"ХБ Freguesia (1,0) с собой"  →  СОВПАДАЕТ ✓
                              ↓
                           beer = "ХБ Festhous"
                           volume = 1.0 ✓

```

---

## Диаграмма 4: Жизненный цикл обновления мэппинга

```
╔═══════════════════════════════════════════════════════════════════════════╗
║              ЖИЗНЕННЫЙ ЦИКЛ ОБНОВЛЕНИЯ МЭППИНГА                          ║
║                 (Как система остаётся синхронизированной)                ║
╚═══════════════════════════════════════════════════════════════════════════╝

DAY 1: В ресторане заказывают новое пиво
┌────────────────────────────────────────┐
│ Клиент заказывает "Craft Brew IPA"     │
│ → Добавлено в меню POS                │
│ → Экспортируется в iiko OLAP          │
└────────────────────┬───────────────────┘
                     |
DAY 2-5: Накапливаются продажи
┌────────────────────────────────────────┐
│ Много людей заказывают "Craft Brew IPA"│
│ OLAP накапливает транзакции           │
└────────────────────┬───────────────────┘
                     |
DAY 7: Плановая проверка
┌────────────────────────────────────────┐
│ python utils/check_unmapped_dishes.py  │
│                                        │
│ ✓ Запрашивает последние 30 дней продаж│
│ ✓ Сравнивает с KEG_TO_DISH_MAPPING   │
│ ✓ Находит "Craft Brew IPA" (NEW!)    │
│ ✓ Экспортирует в NEW_DISHES_TO_ADD.csv│
└────────────────────┬───────────────────┘
                     |
┌────────────────────┴────────────────────┐
│ РЕЗУЛЬТАТ: NEW_DISHES_TO_ADD.csv        │
├─────────────────────────────────────────┤
│ DISH_NAME          | KEG_NAME (?)       │
│ Craft Brew IPA     | ?                  │
└────────────────────┬───────────────────┘
                     |
DAY 7-8: Ручное сопоставление
┌────────────────────────────────────────┐
│ Разработчик открывает CSV              │
│ Проверяет: Какой кег это пиво?         │
│ Смотрит в инвентарь iiko              │
│ Находит: "КЕГ Craft Brew IPA 30л"     │
│ Заполняет CSV вручную                 │
└────────────────────┬───────────────────┘
                     |
DAY 8: Автоматическое сопоставление
┌────────────────────────────────────────┐
│ python utils/auto_add_new_dishes.py    │
│                                        │
│ ✓ Читает NEW_DISHES_TO_ADD.csv        │
│ ✓ Пытается автоматически найти кег   │
│   - Точное совпадение                 │
│   - Substring matching (fuzzy)        │
│ ✓ Метит как AUTO или MANUAL_REQUIRED  │
│ ✓ Обновляет CSV исходный              │
└────────────────────┬───────────────────┘
                     |
DAY 8: Переимпорт
┌────────────────────────────────────────┐
│ python utils/import_final_mapping.py   │
│                                        │
│ ✓ Читает CSV исходный                 │
│ ✓ Генерирует mapping/keg_mapping.py   │
│ ✓ Генерирует data/keg_mapping.json    │
│ ✓ Генерирует data/dish_to_keg_...json │
│ ✓ Проверяет на дубликаты              │
└────────────────────┬───────────────────┘
                     |
DAY 8-9: Перезагрузка приложения
┌────────────────────────────────────────┐
│ python app.py                          │
│                                        │
│ ✓ Перезагружает mapping/keg_mapping.py│
│ ✓ "Craft Brew IPA" теперь в памяти   │
│ ✓ Новые продажи правильно сопоставлены│
└────────────────────┬───────────────────┘
                     |
DAY 9+: Нормальная работа
┌────────────────────────────────────────┐
│ Все новые продажи "Craft Brew IPA"    │
│ автоматически сопоставляются с кегом  │
│ и включаются в аналитику              │
└────────────────────────────────────────┘


╔═══════════════════════════════════════════════════════════════════════════╗
║                      ВСЁ СИНХРОНИЗИРОВАНО! ✓                             ║
╚═══════════════════════════════════════════════════════════════════════════╝

```

---

## Диаграмма 5: Структура данных в памяти

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                  СТРУКТУРА ДАННЫХ В ПАМЯТИ ПРИЛОЖЕНИЯ                    ║
║                        (Во время выполнения)                             ║
╚═══════════════════════════════════════════════════════════════════════════╝

ФАЙЛОВАЯ СИСТЕМА (диск)
┌─────────────────────────────────────────────────────────────────────────┐
│ mapping/keg_mapping.py (140 строк Python)                              │
└─────────────────────────────────────────────────────────────────────────┘
                              |
                    При импорте в приложение
                              |
                              v
ОПЕРАТИВНАЯ ПАМЯТЬ (памяти Python)
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  KEG_TO_DISH_MAPPING = {                                              │
│                                                                         │
│    'КЕГ Brewlok IPA 20 л': [                                          │
│        'Brewlok IPA',                                                 │
│        'ВО Brewlok IPA'                                               │
│    ],                                                                 │
│                                                                         │
│    'КЕГ ФестХаус Хеллес 30 л': [                                     │
│        'ФестХаус Хеллес'                                             │
│    ],                                                                 │
│                                                                         │
│    'КЕГ Блек Шип 50 л': [                                            │
│        'Блек Шип'                                                    │
│    ],                                                                 │
│                                                                         │
│    'КЕГ Brewlok Stout 20 л': [                                       │
│        'Brewlok Stout',                                              │
│        'ВО Brewlok Stout'                                            │
│    ],                                                                 │
│                                                                         │
│    ... (140 кегов всего) ...                                         │
│                                                                         │
│  }  <- Быстрый поиск: O(1) для каждого кега                         │
│      O(n) для поиска блюда в значениях                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


ИСПОЛЬЗОВАНИЕ В КОДЕ:

lookup = KEG_TO_DISH_MAPPING.get('КЕГ Brewlok IPA 20 л')
# → ['Brewlok IPA', 'ВО Brewlok IPA']

for keg_name, dishes in KEG_TO_DISH_MAPPING.items():
    if 'Brewlok IPA' in dishes:
        # → Нашли кег для "Brewlok IPA"
        break

```

---

## Диаграмма 6: Полная синхронизация между системами

```
╔═══════════════════════════════════════════════════════════════════════════╗
║             ПОЛНАЯ СИНХРОНИЗАЦИЯ (Расширенный вид)                       ║
║              Как всё соединяется в один поток данных                     ║
╚═══════════════════════════════════════════════════════════════════════════╝


                        🍺 ФИЗИЧЕСКАЯ РЕАЛЬНОСТЬ
                          (Ключи, Бокалы, Кеги)
                                   |
                                   |
┌──────────────────────────────────┼──────────────────────────────────┐
│                                  |                                  │
│                        РЕСТОРАН (БИЗНЕС)                           │
│                                  |                                  │
│      ┌──────────────┬────────────┼───────────┬──────────────┐       │
│      |              |            |           |              |       │
│      v              v            v           v              v       │
│   ┌─────┐      ┌──────┐    ┌───────┐   ┌──────┐       ┌──────┐    │
│   │ POS │      │CHEF  │    │BARMAN │   │WAITER│       │STOCK │    │
│   │ CASH│      │SCREEN│    │ DRIPS │   │ BOOK │       │ MGMT │    │
│   └──┬──┘      └──┬───┘    └───┬───┘   └──┬───┘       └──┬───┘    │
│      |            |            |          |             |          │
│      └────────────┴────────────┴──────────┴─────────────┘          │
│                        |                                            │
│                        | Все транзакции                            │
│                        v                                            │
│                   ┌─────────────────────────────┐                  │
│                   │  iiko POS система           │                  │
│                   │  (реальные продажи)         │                  │
│                   │                             │                  │
│                   │  DishName, Amount, Price,   │                  │
│                   │  Waiter, Time, Cost, etc    │                  │
│                   └──────────────┬──────────────┘                  │
│                                  |                                  │
└──────────────────────────────────┼──────────────────────────────────┘
                                   |
                                   | Экспорт
                                   v
                    ┌───────────────────────────┐
                    │  iiko OLAP Хранилище      │
                    │  (SQL База)               │
                    │                           │
                    │  draft_sales таблица      │
                    │  sales_by_waiter таблица  │
                    │  prices таблица           │
                    │  inventory таблица        │
                    └──────────────┬────────────┘
                                   |
                                   | REST API /reports/olap
                                   v
                    ┌───────────────────────────┐
                    │  ПРИЛОЖЕНИЕ               │
                    │  (Flask + Python)         │
                    │                           │
                    │  olap.get_draft_sales...()│
                    │  → DataFrame              │
                    │                           │
                    │  ┌─────────────────────┐  │
                    │  │ extract_beer_info   │  │
                    │  │ parse имена пива    │  │
                    │  │ "Brewlok IPA (0,5)" │  │
                    │  │ → ("Brewlok", 0.5)  │  │
                    │  └─────────┬───────────┘  │
                    │            |              │
                    │            v              │
                    │  ┌─────────────────────┐  │
                    │  │ KEG_TO_DISH_MAPPING │  │
                    │  │ lookup beer name    │  │
                    │  │ find corresponding  │  │
                    │  │ keg name            │  │
                    │  └─────────┬───────────┘  │
                    │            |              │
                    │            v              │
                    │  ┌─────────────────────┐  │
                    │  │ get_beer_summary()  │  │
                    │  │ aggregate volumes   │  │
                    │  │ calc percentages    │  │
                    │  │ ABC/XYZ analysis    │  │
                    │  └─────────┬───────────┘  │
                    │            |              │
                    │            v              │
                    │  DataFrame (результаты)   │
                    └──────────────┬────────────┘
                                   |
                                   | JSON (/api/draft-analyze)
                                   v
                    ┌───────────────────────────┐
                    │  БРАУЗЕР (JavaScript)     │
                    │  • Получает JSON          │
                    │  • Парсит данные          │
                    │  • Рендерит таблицы       │
                    │  • Строит графики         │
                    │  • Показывает доли (%)    │
                    └──────────────┬────────────┘
                                   |
                                   v
                    ┌───────────────────────────┐
                    │  СТРАНИЦА "ПРОЛИВЫ"       │
                    │                           │
                    │  Brewlok IPA              │
                    │  ├─ 75.0 L                │
                    │  ├─ 150 порций            │
                    │  ├─ 3.2% ← ДОЛЯ           │
                    │  ├─ 2.5 кега              │
                    │  ├─ B (ABC)               │
                    │  └─ X (XYZ)               │
                    └───────────────────────────┘
                            |
                            | ПОЛЬЗОВАТЕЛЬ
                            | ВИДИТ РЕЗУЛЬТАТ
                            v
                    ┌───────────────────────────┐
                    │  ✓ АНАЛИТИКА              │
                    │  ✓ СИНХРОНИЗИРОВАНО       │
                    │  ✓ АКТУАЛЬНО              │
                    └───────────────────────────┘

```

