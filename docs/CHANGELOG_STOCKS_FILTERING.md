# Changelog: Фильтрация остатков кег по активным кранам

**Дата:** 2025-11-06

## Что было сделано

### 1. Реализована фильтрация остатков кег
Endpoint `/api/stocks/taplist` теперь показывает **только те кеги, которые сейчас активны на кранах** (вместо всех 60+ кег).

### 2. Интеграция с TapsManager
- Используется существующий `TapsManager` для получения списка активных кранов
- Поддерживается фильтрация по конкретному бару и режим "Общая"

### 3. Нечеткое сравнение названий
Реализовано 3 уровня сравнения названий пива:

1. **Точное совпадение** - название из крана === название из остатков
2. **Вхождение подстроки** - одно название содержит другое
3. **Совпадение первых слов** - первые 2 слова идентичны
4. **Похожие слова** - первое слово совпадает + второе слово начинается одинаково
   - Пример: "Ригеле **Альте** Вайс" ~ "Ригеле **Альт** Вайс С"

### 4. Обработка названий
Из названий кег удаляются:
- Префикс "КЕГ" (из данных кранов)
- Префикс "Кег" (из номенклатуры iiko)
- Объемы: "20 л", "30 л" и т.д.
- Суффикс "кег"

### 5. Persist на Render Disk
- На Render: данные кранов хранятся в `/kultura/taps_data.json`
- Локально: используется `data/taps_data.json`

## Изменённые файлы

### app.py (строки 1174-1340)
- Endpoint `/api/stocks/taplist` - полностью переписан
- Добавлена логика сбора активных кег из `taps_manager`
- Добавлена фильтрация остатков по активным кранам
- Реализовано нечеткое сравнение названий

### Логика работы

```python
# 1. Собираем активные краны
for bar_id in bars:
    taps = taps_manager.get_bar_taps(bar_id)
    for tap in taps:
        if tap.status == 'active':
            active_beers.add(tap.current_beer)  # "КЕГ Ригеле Альте Вайс" -> "Ригеле Альте Вайс"

# 2. Получаем остатки из iiko API
balances = olap.get_store_balances()

# 3. Фильтруем только активные кеги
for balance in balances:
    # Обрабатываем название: "Кег Ригеле Альт Вайс С 20 л" -> "Ригеле Альт Вайс С"
    if fuzzy_match(processed_name, active_beers):
        include_in_result()
```

## Тестирование на Render

После деплоя проверить:

1. Что файл `/kultura/taps_data.json` существует и содержит актуальные данные кранов
2. Endpoint возвращает только активные кеги:
   ```bash
   curl "https://your-app.onrender.com/api/stocks/taplist?bar=Большой пр. В.О"
   ```
3. Режим "Общая" показывает кеги со всех баров:
   ```bash
   curl "https://your-app.onrender.com/api/stocks/taplist?bar=Общая"
   ```

## Известные ограничения

1. **Названия должны быть похожими** - если название на кране сильно отличается от названия в iiko, нечеткое сравнение может не сработать
2. **Первое слово должно совпадать** - алгоритм полагается на совпадение первого слова в названии
3. **Кеги = GOODS в литрах** - фильтруются только товары типа GOODS с единицей измерения "л"

## Возможные улучшения

1. Добавить админ-панель для маппинга названий (если нечеткое сравнение не работает)
2. Логировать случаи, когда активный кран не нашел соответствие в остатках
3. Добавить кэширование результатов API (сейчас каждый запрос = вызов iiko API)
