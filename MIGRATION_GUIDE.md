# Руководство по миграции с v1.0 на v2.0

## Обзор изменений

Система управления кранами была полностью переработана для улучшения пользовательского опыта и интеграции с номенклатурой iiko.

## Основные изменения

### URL структура

**До (v1.0):**
```
http://localhost:5000/taps - единая страница для всех баров
```

**После (v2.0):**
```
http://localhost:5000/taps - главная страница (выбор бара)
http://localhost:5000/taps/bar1 - Большой пр. В.О
http://localhost:5000/taps/bar2 - Лиговский
http://localhost:5000/taps/bar3 - Кременчугская
http://localhost:5000/taps/bar4 - Варшавская
```

### Пользовательский интерфейс

**До:**
- Одна страница со всеми барами
- Ручной ввод названия пива
- Градиентный фиолетовый дизайн

**После:**
- Отдельная страница для каждого бара
- Выпадающий список с автозаполнением из номенклатуры
- Минималистичный дизайн как на других страницах (Фасовка, Проливы)
- Переключатель светлой/тёмной темы

### API endpoints

#### Новые endpoints:

```
GET  /api/beers/draft           - список разливного пива
GET  /api/taps/{bar_id}/stats   - краткая статистика бара
GET  /taps/{bar_id}              - страница конкретного бара
```

#### Без изменений:

```
GET  /api/taps/bars
GET  /api/taps/{bar_id}
POST /api/taps/{bar_id}/start
POST /api/taps/{bar_id}/stop
POST /api/taps/{bar_id}/replace
GET  /api/taps/{bar_id}/{tap_number}/history
GET  /api/taps/events/all
GET  /api/taps/statistics
```

## Что делать

### 1. Обновление кода

Код уже обновлён в:
- `app.py` - добавлены новые маршруты и endpoints
- `templates/taps_main.html` - главная страница (новая)
- `templates/taps_bar.html` - страница бара (новая)

### 2. Обновление закладок

Если у вас были закладки на старую страницу:

**Старая закладка:**
```
http://localhost:5000/taps
```

**Новые закладки:**
- Главная: `http://localhost:5000/taps`
- Большой пр. В.О: `http://localhost:5000/taps/bar1`
- Лиговский: `http://localhost:5000/taps/bar2`
- Кременчугская: `http://localhost:5000/taps/bar3`
- Варшавская: `http://localhost:5000/taps/bar4`

### 3. Обновление документации

**Устаревшие файлы (можно удалить или архивировать):**
- `templates/taps.html` (v1.0)
- `TAPS_README.md` (v1.0)
- `TAPS_QUICK_START.md` (v1.0)
- `TAPS_MANAGEMENT.md` (v1.0)
- `TAPS_API_EXAMPLES.md` (v1.0)
- `TAPS_FILE_STRUCTURE.md` (v1.0)
- `TAPS_SUMMARY.md` (v1.0)
- `TAPS_CHANGELOG.md` (v1.0)

**Новые файлы:**
- `templates/taps_main.html` (v2.0)
- `templates/taps_bar.html` (v2.0)
- `TAPS_V2_README.md` (v2.0)
- `MIGRATION_GUIDE.md` (этот файл)

### 4. Проверка номенклатуры

Убедитесь, что файл `data/all_products.json` существует и содержит разливное пиво.

Если файла нет, создайте его или обновите из iiko:
```bash
# Скрипт для загрузки номенклатуры (если есть)
python scripts/update_nomenclature.py
```

## Совместимость данных

### Формат данных НЕ изменился

Файл `data/taps_data.json` использует тот же формат, что и в v1.0.

**Миграция данных НЕ требуется!**

Все существующие данные о кранах будут работать без изменений.

### Пример структуры данных

```json
{
  "bar1": {
    "name": "Бар 1",
    "total_taps": 12,
    "taps": [
      {
        "tap_number": 1,
        "status": "active",
        "current_beer": "Guinness Draught",
        "current_keg_id": "KEG-001",
        "started_at": "2024-10-24T10:00:00",
        "history": []
      }
    ]
  }
}
```

## Тестирование после миграции

### 1. Проверка главной страницы

```bash
# Откройте в браузере
http://localhost:5000/taps
```

Должны увидеть:
- 4 карточки баров
- Статистику по каждому бару
- Возможность кликнуть на карточку

### 2. Проверка страницы бара

```bash
# Откройте в браузере
http://localhost:5000/taps/bar1
```

Должны увидеть:
- Навигацию (Фасовка, Проливы, Официанты, Краны)
- Статистику (всего, активных, пустых, %)
- Сетку кранов (12 или 24)

### 3. Проверка выпадающего списка

1. Кликните на пустой кран
2. Нажмите "Подключить кегу"
3. Должен появиться выпадающий список с разливным пивом

Если список пустой:
- Проверьте наличие `data/all_products.json`
- Проверьте консоль браузера (F12) на ошибки

### 4. Проверка API

```bash
# Список разливного пива
curl http://localhost:5000/api/beers/draft

# Статистика бара
curl http://localhost:5000/api/taps/bar1/stats

# Подключение кеги
curl -X POST http://localhost:5000/api/taps/bar1/start \
  -H "Content-Type: application/json" \
  -d '{"tap_number": 1, "beer_name": "Test Beer", "keg_id": "KEG-001"}'
```

## Откат на v1.0 (если нужно)

Если возникли проблемы и нужно вернуться к v1.0:

### 1. Откатите изменения в app.py

Верните маршрут `/taps` к старому варианту:

```python
@app.route('/taps')
def taps():
    """Страница управления пивными кранами"""
    return render_template('taps.html')
```

### 2. Используйте старый шаблон

Убедитесь, что `templates/taps.html` (v1.0) существует.

### 3. Перезапустите сервер

```bash
python app.py
```

## FAQ

### Вопрос: Нужно ли мигрировать данные?

**Ответ:** Нет, данные остаются в том же формате.

### Вопрос: Что делать, если нет файла all_products.json?

**Ответ:** Система будет работать, но выпадающий список будет пустым. Вы сможете вводить названия пива вручную (функция будет добавлена) или загрузить номенклатуру из iiko.

### Вопрос: Можно ли использовать обе версии одновременно?

**Ответ:** Нет, рекомендуется использовать только v2.0.

### Вопрос: Изменился ли формат API?

**Ответ:** Нет, существующие API endpoints работают так же. Добавлены только новые endpoints.

### Вопрос: Работает ли мобильная версия?

**Ответ:** Да, v2.0 полностью адаптирован для мобильных устройств.

## Контрольный список миграции

- [ ] Обновлён код в `app.py`
- [ ] Созданы новые шаблоны `taps_main.html` и `taps_bar.html`
- [ ] Проверено наличие `data/all_products.json`
- [ ] Проверена главная страница `/taps`
- [ ] Проверены страницы всех баров (`/taps/bar1`, `/taps/bar2`, и т.д.)
- [ ] Протестировано подключение кеги
- [ ] Протестирована замена кеги
- [ ] Протестирована остановка крана
- [ ] Проверена работа выпадающего списка пива
- [ ] Обновлены закладки браузера
- [ ] Обучены пользователи новому интерфейсу

## Поддержка

Если возникли проблемы при миграции:

1. Проверьте логи сервера в консоли
2. Откройте DevTools (F12) → Console в браузере
3. Убедитесь, что все файлы на месте
4. Проверьте версию Python (требуется 3.7+)

---

**Миграция завершена!** Система готова к использованию.

Откройте http://localhost:5000/taps для начала работы.
